<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>JianHong</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="Note">
<meta property="og:type" content="website">
<meta property="og:title" content="JianHong">
<meta property="og:url" content="http://example.com/page/8/index.html">
<meta property="og:site_name" content="JianHong">
<meta property="og:description" content="Note">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="JianHong">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="JianHong" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
  
<meta name="generator" content="Hexo 7.0.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">JianHong</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"><span class="fa fa-bars"></span></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
        
          <a class="nav-icon" href="/atom.xml" title="RSS Feed"><span class="fa fa-rss"></span></a>
        
        <a class="nav-icon nav-search-btn" title="Search"><span class="fa fa-search"></span></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main">
  
    <article id="post-Note/后端/Java/中间件/数据库操作" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2024/01/18/Note/%E5%90%8E%E7%AB%AF/Java/%E4%B8%AD%E9%97%B4%E4%BB%B6/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%93%8D%E4%BD%9C/" class="article-date">
  <time class="dt-published" datetime="2024-01-18T13:12:24.678Z" itemprop="datePublished">2024-01-18</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Java%E4%B8%AD%E9%97%B4%E4%BB%B6/">Java中间件</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2024/01/18/Note/%E5%90%8E%E7%AB%AF/Java/%E4%B8%AD%E9%97%B4%E4%BB%B6/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%93%8D%E4%BD%9C/">数据库操作</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="JDBC"><a href="#JDBC" class="headerlink" title="JDBC"></a>JDBC</h1><h3 id="获取数据库连接的几种方式"><a href="#获取数据库连接的几种方式" class="headerlink" title="获取数据库连接的几种方式"></a>获取数据库连接的几种方式</h3><ol>
<li><p>通过第三方api</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Driver</span> <span class="variable">driver</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">com</span>.mysql.jdbc.Driver();</span><br><span class="line"><span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> <span class="string">&quot;jdbc:mysql://localhost:3306/test&quot;</span>;</span><br><span class="line"><span class="type">Properties</span> <span class="variable">info</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Properties</span>();</span><br><span class="line">info.setProperty(<span class="string">&quot;user&quot;</span>,<span class="string">&quot;root&quot;</span>);</span><br><span class="line">info.setProperty(<span class="string">&quot;password&quot;</span>,<span class="string">&quot;&quot;</span>);</span><br><span class="line"><span class="type">Connection</span> <span class="variable">connect</span> <span class="operator">=</span>driver.connect(url,info);</span><br></pre></td></tr></table></figure>
</li>
<li><p>通过反射</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;com.mysql.cj.jdbc.Driver&quot;</span>);</span><br><span class="line"><span class="type">Driver</span> <span class="variable">driver</span> <span class="operator">=</span> (Driver) clazz.getConstructor().newInstance();</span><br><span class="line"><span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> <span class="string">&quot;jdbc:mysql://localhost:3306/test?useUnicode=true&amp;characterEncoding=utf-8 &quot;</span>;</span><br><span class="line"><span class="type">Properties</span> <span class="variable">info</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Properties</span>();</span><br><span class="line">info.setProperty(<span class="string">&quot;user&quot;</span>,<span class="string">&quot;root&quot;</span>);</span><br><span class="line">info.setProperty(<span class="string">&quot;password&quot;</span>,<span class="string">&quot;&quot;</span>);</span><br><span class="line"><span class="type">Connection</span> <span class="variable">conn</span> <span class="operator">=</span>driver.connect(url,info);</span><br></pre></td></tr></table></figure>
</li>
<li><p>通过DriverManager</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//获取Driver实现类</span></span><br><span class="line"><span class="type">Class</span> <span class="variable">aClass</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;com.mysql.cj.jdbc.Driver&quot;</span>);</span><br><span class="line"><span class="type">Driver</span> <span class="variable">driver</span> <span class="operator">=</span> (Driver) aClass.getConstructor().newInstance();</span><br><span class="line"><span class="comment">//提供连接需要的信息</span></span><br><span class="line"><span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> <span class="string">&quot;jdbc:mysql://localhost:3306/test&quot;</span>;</span><br><span class="line"><span class="type">String</span> <span class="variable">user</span> <span class="operator">=</span> <span class="string">&quot;root&quot;</span>;</span><br><span class="line"><span class="type">String</span> <span class="variable">password</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line"><span class="comment">//注册驱动</span></span><br><span class="line">DriverManager.registerDriver(driver);</span><br><span class="line"><span class="comment">//获取连接</span></span><br><span class="line"><span class="type">Connection</span> <span class="variable">conn</span> <span class="operator">=</span> DriverManager.getConnection(url,user,password);</span><br></pre></td></tr></table></figure>
</li>
<li><p>加载驱动</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//提供连接需要的信息</span></span><br><span class="line"><span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> <span class="string">&quot;jdbc:mysql://localhost:3306/test&quot;</span>;</span><br><span class="line"><span class="type">String</span> <span class="variable">user</span> <span class="operator">=</span> <span class="string">&quot;root&quot;</span>;</span><br><span class="line"><span class="type">String</span> <span class="variable">password</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line"><span class="comment">//加载Driver（可以省略，最好不省略）</span></span><br><span class="line"><span class="comment">//加载Driver类会执行其内部的静态代码块，会进行注册</span></span><br><span class="line">Class.forName(<span class="string">&quot;com.mysql.cj.jdbc.Driver&quot;</span>);</span><br><span class="line"><span class="comment">//获取连接</span></span><br><span class="line"><span class="type">Connection</span> <span class="variable">conn</span> <span class="operator">=</span> DriverManager.getConnection(url,user,password);</span><br></pre></td></tr></table></figure>
</li>
<li><p>读配置文件</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//加载配置文件（获取类加载器加载资源文件）</span></span><br><span class="line"><span class="type">InputStream</span> <span class="variable">is</span> <span class="operator">=</span> ClassLoader.getSystemClassLoader().getResourceAsStream(<span class="string">&quot;JDBC.properties&quot;</span>);</span><br><span class="line"><span class="type">Properties</span> <span class="variable">prop</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Properties</span>();</span><br><span class="line"><span class="comment">//读取配置信息</span></span><br><span class="line">prop.load(is);</span><br><span class="line"><span class="type">String</span> <span class="variable">user</span> <span class="operator">=</span> prop.getProperty(<span class="string">&quot;user&quot;</span>);</span><br><span class="line"><span class="type">String</span> <span class="variable">password</span> <span class="operator">=</span> prop.getProperty(<span class="string">&quot;password&quot;</span>);</span><br><span class="line"><span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> prop.getProperty(<span class="string">&quot;url&quot;</span>);</span><br><span class="line"><span class="type">String</span> <span class="variable">driverClass</span> <span class="operator">=</span> prop.getProperty(<span class="string">&quot;driverClass&quot;</span>);</span><br><span class="line"><span class="comment">//获取Driver实现类</span></span><br><span class="line">Class.forName(driverClass);</span><br><span class="line"><span class="comment">//获取连接</span></span><br><span class="line"><span class="type">Connection</span> <span class="variable">conn</span> <span class="operator">=</span> DriverManager.getConnection(url, user, password);</span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="preparedstatement"><a href="#preparedstatement" class="headerlink" title="preparedstatement"></a>preparedstatement</h3><ul>
<li>预编译sql语句，对应的参数使用占位符表示，可避免sql注入攻击</li>
<li>结合反射和泛型使用更灵活</li>
</ul>
<h3 id="Blob"><a href="#Blob" class="headerlink" title="Blob"></a>Blob</h3><ul>
<li>用于保存图片</li>
<li>读取时是以流的形式读取的</li>
</ul>
<h3 id="Batch"><a href="#Batch" class="headerlink" title="Batch"></a>Batch</h3><ul>
<li>用于批量操作，提高效率</li>
</ul>
<h3 id="事务"><a href="#事务" class="headerlink" title="事务"></a>事务</h3><ul>
<li>用一次连接完成一组sql语句，提高速度</li>
<li>事务的特性即一致性，要么都成功提交，要么都失败回滚</li>
</ul>
<h1 id="MyBatis"><a href="#MyBatis" class="headerlink" title="MyBatis"></a>MyBatis</h1><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><ul>
<li>底层封装了JDBC</li>
<li>JDBC存在的问题<ul>
<li>数据库配置信息硬编码</li>
<li>连接对象是要通过http连接数据库，每次都需要创建和释放连接，性能低</li>
<li>SQL、参数、结果集都是硬编码，不灵活</li>
<li>结果集需要手动封装处理，繁琐不灵活</li>
</ul>
</li>
</ul>
<h2 id="操作"><a href="#操作" class="headerlink" title="操作"></a>操作</h2><table>
<thead>
<tr>
<th>作用</th>
<th>操作符</th>
<th>xml写法</th>
</tr>
</thead>
<tbody><tr>
<td>大于</td>
<td>&gt;</td>
<td>&amp;gt;</td>
</tr>
<tr>
<td>大于等于</td>
<td>&gt;&#x3D;</td>
<td>&amp;gt;&#x3D;</td>
</tr>
<tr>
<td>小于</td>
<td>&lt;</td>
<td>&amp;lt;</td>
</tr>
<tr>
<td>小于等于</td>
<td>&lt;&#x3D;</td>
<td>&amp;lt;&#x3D;</td>
</tr>
<tr>
<td>不等于</td>
<td>!&#x3D;</td>
<td>&amp;lt;&amp;gt;</td>
</tr>
<tr>
<td>转义</td>
<td></td>
<td><![CDATA[ 操作符 ]]></td>
</tr>
</tbody></table>
<h2 id="标签"><a href="#标签" class="headerlink" title="标签"></a>标签</h2><p>if</p>
<ul>
<li>用于动态拼接SQL语句，底层是使用的OGNL表达式来解析的，可以支持不同数据类型之间的比较</li>
</ul>
<h2 id="分页"><a href="#分页" class="headerlink" title="分页"></a>分页</h2><p>​	MyBatis默认的一对多分页会有一点问题，查询后分页他会以多的那部分计算分页条数，导致查询出来的数据条目对不上</p>
<ul>
<li>使用resultMap解决</li>
<li>自定义分页插件，比较困难</li>
<li>条件查询中嵌套子查询</li>
<li>单表查询后分页在连接多表</li>
</ul>
<h2 id="动态SQL"><a href="#动态SQL" class="headerlink" title="动态SQL"></a>动态SQL</h2><p>条件查询</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">select * from A </span><br><span class="line"><span class="tag">&lt;<span class="name">where</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;&quot;</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">where</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>test后可用双引号也可用单引号</li>
</ul>
<p>动态连接表</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">choose</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">when</span> <span class="attr">test</span>=<span class="string">&quot;&quot;</span>&gt;</span></span><br><span class="line">        表</span><br><span class="line">    <span class="tag">&lt;/<span class="name">when</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">otherwise</span>&gt;</span></span><br><span class="line">        表</span><br><span class="line">    <span class="tag">&lt;/<span class="name">otherwise</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">choose</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>遍历集合</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">where</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">foreach</span> <span class="attr">collection</span>=<span class="string">&quot;集合&quot;</span> <span class="attr">open</span>=<span class="string">&quot;开始字符&quot;</span> <span class="attr">close</span>=<span class="string">&quot;结束字符&quot;</span> <span class="attr">item</span>=<span class="string">&quot;下标名&quot;</span>, <span class="attr">separator</span>=<span class="string">&quot;分隔符&quot;</span>&gt;</span></span><br><span class="line">    	#&#123;id&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">foreach</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">where</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>Sql语句抽取</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">sql</span> <span class="attr">id</span>=<span class="string">&quot;&quot;</span>&gt;</span></span><br><span class="line">	tong&#x27;yongSQL</span><br><span class="line"><span class="tag">&lt;/<span class="name">sql</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="Handler"><a href="#Handler" class="headerlink" title="Handler"></a>Handler</h2><h3 id="TypeHandlers"><a href="#TypeHandlers" class="headerlink" title="TypeHandlers&lt;T&gt;"></a>TypeHandlers&lt;T&gt;</h3><ul>
<li><p>T是想要转换的类型</p>
</li>
<li><p>自定义类型转换器</p>
<ul>
<li>继承BaseTypeHandler，实现四个方法<ul>
<li>setNonNullParameter()<ul>
<li>将Java类型转换成数据库需要的类型</li>
</ul>
</li>
<li>getNullableResult()<ul>
<li>有三个重载</li>
<li>将数据库中的数据转换成Java类型</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="Plugins"><a href="#Plugins" class="headerlink" title="Plugins"></a>Plugins</h2><h3 id="PageHelper"><a href="#PageHelper" class="headerlink" title="PageHelper"></a>PageHelper</h3><p><code>PageHelper.startPage(第几页,一页几条数据);</code></p>
<ul>
<li>用于分页，与查询解耦</li>
</ul>
<h2 id="多表操作"><a href="#多表操作" class="headerlink" title="多表操作"></a>多表操作</h2><ul>
<li>使用resultMap封装对象的成员变量</li>
<li>使用association封装对象中的对象</li>
<li>使用collection封装集合数组等<ul>
<li>对象可以是一个子查询</li>
</ul>
</li>
<li>可以在mapper上使用注解来编写sql<ul>
<li>@One：一对一结果集封装</li>
<li>@Many：一对多结果集封装</li>
<li>@Result &#x2F; @Results：封装结果集</li>
</ul>
</li>
</ul>
<h1 id="MyBatisPlus"><a href="#MyBatisPlus" class="headerlink" title="MyBatisPlus"></a>MyBatisPlus</h1><h2 id="常用注解"><a href="#常用注解" class="headerlink" title="常用注解"></a>常用注解</h2><h3 id="TableField"><a href="#TableField" class="headerlink" title="TableField"></a>TableField</h3><ul>
<li>对象中的属性名和字段名不一致<ul>
<li>TableField(value &#x3D; “”)</li>
</ul>
</li>
<li>对象中的属性字段在表中不存在<ul>
<li>TableField(exist &#x3D; false)</li>
</ul>
</li>
<li>想让对象中的属性不被查询出来<ul>
<li>TableField(select &#x3D; false)</li>
</ul>
</li>
<li>自动填充<ul>
<li><code>@TableField(fill = FieldFill.INSERT_UPDATE)</code></li>
</ul>
</li>
</ul>
<h3 id="TableLogic"><a href="#TableLogic" class="headerlink" title="TableLogic"></a>TableLogic</h3><ul>
<li>逻辑删除</li>
<li>value 表示显示的值，delval表示删除的值</li>
</ul>
<h2 id="Wrapper"><a href="#Wrapper" class="headerlink" title="Wrapper"></a>Wrapper</h2><ul>
<li><p>QueryWrapper&lt;User&gt;</p>
</li>
<li><p>UpdateWrapper&lt;User&gt;</p>
</li>
<li><p>基本操作字符</p>
<table>
<thead>
<tr>
<th>操作符</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td>wrapper.eq(“字段名”,值)</td>
<td>等于</td>
</tr>
<tr>
<td>wrapper.set(“字段名”,值)</td>
<td>设置</td>
</tr>
<tr>
<td>wrapper.ne(“字段名”,值)</td>
<td>不等于</td>
</tr>
<tr>
<td>wrapper.gt(“字段名”,值)</td>
<td>大于</td>
</tr>
<tr>
<td>wrapper.ge(“字段名”,值)</td>
<td>大于等于</td>
</tr>
<tr>
<td>wrapper.lt(“字段名”,值)</td>
<td>小于</td>
</tr>
<tr>
<td>wrapper.le(“字段名”,值)</td>
<td>小于等于</td>
</tr>
<tr>
<td>wrapper.between(值1, 值2)</td>
<td>在值1和值2之间</td>
</tr>
<tr>
<td>wrapper.notBetween(值1, 值2)</td>
<td>不在值1和值2之间</td>
</tr>
<tr>
<td>wrapper.in(值1, 值2)</td>
<td>值1或值2</td>
</tr>
<tr>
<td>wrapper.notIn(值1, 值2)</td>
<td>不是值1或值2</td>
</tr>
<tr>
<td>wrapper.alleq(map, 是否处理null值)</td>
<td>全相等</td>
</tr>
<tr>
<td>wrapper.like(“字段名”,值)</td>
<td>like   %值%</td>
</tr>
<tr>
<td>wrapper.notLike(“字段名”,值)</td>
<td>not like  %值%</td>
</tr>
<tr>
<td>wrapper.likeLeft(“字段名”,值)</td>
<td>%值  —&gt; 以这个值结尾</td>
</tr>
<tr>
<td>wrapper.likeLeft(“字段名”,值)</td>
<td>值%  —&gt; 以这个值开头</td>
</tr>
<tr>
<td>wrapper.orderBy(“字段名”)</td>
<td>升序排序</td>
</tr>
<tr>
<td>wrapper.orderByAsc(“字段名”)</td>
<td>升序排序</td>
</tr>
<tr>
<td>wrapper.orderByDesc(“字段名”)</td>
<td>降序排序</td>
</tr>
<tr>
<td>wrapper.or()</td>
<td>or</td>
</tr>
<tr>
<td>wrapper.and()</td>
<td>and</td>
</tr>
<tr>
<td>wrapper.select(“字段名1”,”字段名2”)</td>
<td>指定输出的字段</td>
</tr>
</tbody></table>
</li>
<li><p>可以在参数中写连接条件，返回值是boolean</p>
</li>
</ul>
<h2 id="Wrappers"><a href="#Wrappers" class="headerlink" title="Wrappers"></a>Wrappers</h2><ul>
<li>可替代wrapper对象使用</li>
</ul>
<h2 id="填充器"><a href="#填充器" class="headerlink" title="填充器"></a>填充器</h2><ul>
<li>实现MetaObjectHandler接口，实现insertFill和updateFill方法</li>
<li>需要在实体类上添加@TableField并指定fill的策略</li>
</ul>
<h1 id="Druid"><a href="#Druid" class="headerlink" title="Druid"></a>Druid</h1><h2 id="简介-1"><a href="#简介-1" class="headerlink" title="简介"></a>简介</h2><ul>
<li>是一个JDBC组件，包含三个部分<ul>
<li>DruidDriver：代理Driver，能够提供基于Filter－Chain模式的插件体系</li>
<li>DruidDataSource ：高效可管理的数据库连接池</li>
<li>SQLParser ：</li>
</ul>
</li>
<li>用途<ul>
<li>监控数据库访问性能，Druid内置提供了一个功能强大的StatFilter插件，能够详细统计SQL的执行性能，这对于线上分析数据库访问性能有帮助</li>
<li>高效、功能强大、可扩展性好</li>
<li>数据库密码加密。直接把数据库密码写在配置文件中，这是不好的行为，容易导致安全问题。DruidDruiver和DruidDataSource都支持PasswordCallback</li>
<li>SQL执行日志，Druid提供了不同的 LogFilter，能够支持 Common-Logging、Log4j 和 JdkLog</li>
<li>可以通过Druid提供的Filter-Chain机制，很方便编写JDBC层的扩展插件</li>
</ul>
</li>
</ul>
<h2 id="使用步骤"><a href="#使用步骤" class="headerlink" title="使用步骤"></a>使用步骤</h2><ol>
<li>导入依赖</li>
<li>单数据源配置配置</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">druidDemo</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://localhost:3306/test?characterEncoding=UTF-8</span></span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">com.mysql.jdbc.Driver</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">xxx</span> <span class="comment"># 数据库账号</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">xxx@</span> <span class="comment"># 数据库密码</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">com.alibaba.druid.pool.DruidDataSource</span> <span class="comment"># 设置类型为 DruidDataSource</span></span><br><span class="line">    <span class="comment"># Druid 自定义配置，对应 DruidDataSource 中的 setting 方法的属性</span></span><br><span class="line">    <span class="attr">druid:</span> <span class="comment"># 设置 Druid 连接池的自定义配置。然后 DruidDataSourceAutoConfigure 会自动化配置 Druid 连接池。</span></span><br><span class="line">      <span class="attr">min-idle:</span> <span class="number">0</span> <span class="comment"># 池中维护的最小空闲连接数，默认为 0 个。</span></span><br><span class="line">      <span class="attr">max-active:</span> <span class="number">20</span> <span class="comment"># 池中最大连接数，包括闲置和使用中的连接，默认为 8 个。</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>多数据源配置</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">druidDemo</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">mall:</span></span><br><span class="line">      <span class="attr">url:</span> <span class="string">jdbc:mysql://localhost:3306/test?characterEncoding=UTF-8</span></span><br><span class="line">      <span class="attr">driver-class-name:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line">      <span class="attr">username:</span> <span class="string">root</span> <span class="comment"># 数据库账号</span></span><br><span class="line">      <span class="attr">password:</span> <span class="string">root0319@</span> <span class="comment"># 数据库密码</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">com.alibaba.druid.pool.DruidDataSource</span> <span class="comment"># 设置类型为 DruidDataSource</span></span><br><span class="line">      <span class="attr">min-idle:</span> <span class="number">0</span> <span class="comment"># 池中维护的最小空闲连接数，默认为 0 个。</span></span><br><span class="line">      <span class="attr">max-active:</span> <span class="number">20</span> <span class="comment"># 池中最大连接数，包括闲置和使用中的连接，默认为 8 个。</span></span><br><span class="line">    <span class="comment"># 用户数据源配置</span></span><br><span class="line">    <span class="attr">users:</span></span><br><span class="line">      <span class="attr">url:</span> <span class="string">jdbc:mysql://localhost:3306/test?characterEncoding=UTF-8</span></span><br><span class="line">      <span class="attr">driver-class-name:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line">      <span class="attr">username:</span> <span class="string">root</span> <span class="comment"># 数据库账号</span></span><br><span class="line">      <span class="attr">password:</span> <span class="string">root0319@</span> <span class="comment"># 数据库密码</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">com.alibaba.druid.pool.DruidDataSource</span> <span class="comment"># 设置类型为 DruidDataSource</span></span><br><span class="line">      <span class="attr">min-idle:</span> <span class="number">0</span> <span class="comment"># 池中维护的最小空闲连接数，默认为 0 个。</span></span><br><span class="line">      <span class="attr">max-active:</span> <span class="number">20</span> <span class="comment"># 池中最大连接数，包括闲置和使用中的连接，默认为 8 个。</span></span><br></pre></td></tr></table></figure>

<ol start="4">
<li>配置监控台</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">druid:</span> <span class="comment"># 设置 Druid 连接池的自定义配置。然后 DruidDataSourceAutoConfigure 会自动化配置 Druid 连接池。</span></span><br><span class="line">	<span class="attr">filter:</span></span><br><span class="line">		<span class="attr">stat:</span> <span class="comment"># 配置 StatFilter </span></span><br><span class="line">			<span class="attr">log-slow-sql:</span> <span class="literal">true</span> <span class="comment"># 开启慢查询记录</span></span><br><span class="line">			<span class="attr">slow-sql-millis:</span> <span class="number">5000</span> <span class="comment"># 慢 SQL 的标准，单位：毫秒</span></span><br><span class="line">			<span class="attr">merge-sql:</span> <span class="literal">true</span> <span class="comment"># SQL合并配置</span></span><br><span class="line">	<span class="attr">stat-view-servlet:</span> <span class="comment"># 配置 StatViewServlet</span></span><br><span class="line">		<span class="attr">enabled:</span> <span class="literal">true</span> <span class="comment"># 是否开启 StatViewServlet</span></span><br><span class="line">		<span class="attr">login-username:</span> <span class="string">root</span> <span class="comment"># 账号</span></span><br><span class="line">		<span class="attr">login-password:</span> <span class="string">root</span> <span class="comment"># 密码</span></span><br></pre></td></tr></table></figure>

<ul>
<li>stat文档：<a target="_blank" rel="noopener" href="https://github.com/alibaba/druid/wiki/%E9%85%8D%E7%BD%AE_StatFilter">https://github.com/alibaba/druid/wiki/%E9%85%8D%E7%BD%AE_StatFilter</a></li>
<li>stat-view-servlet文档：<a target="_blank" rel="noopener" href="https://github.com/alibaba/druid/wiki/%E9%85%8D%E7%BD%AE_StatViewServlet%E9%85%8D%E7%BD%AE">https://github.com/alibaba/druid/wiki/%E9%85%8D%E7%BD%AE_StatViewServlet%E9%85%8D%E7%BD%AE</a></li>
<li>Druid监控台：<a target="_blank" rel="noopener" href="http://127.0.0.1:8082/druid/sql.html">http://127.0.0.1:8082/druid/sql.html</a></li>
</ul>
<p>使用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Connection <span class="title function_">getConnection</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">InputStream</span> <span class="variable">is</span> <span class="operator">=</span> ClassLoader.getSystemClassLoader().getResourceAsStream(<span class="string">&quot;Druid.Properties&quot;</span>);</span><br><span class="line">        <span class="type">Properties</span> <span class="variable">prop</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Properties</span>();</span><br><span class="line">        prop.load(is);</span><br><span class="line">        <span class="type">DataSource</span> <span class="variable">source</span> <span class="operator">=</span> DruidDataSourceFactory.createDataSource(prop);</span><br><span class="line">        <span class="keyword">return</span> source.getConnection();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="Hikari"><a href="#Hikari" class="headerlink" title="Hikari"></a>Hikari</h1><h1 id="MyCat"><a href="#MyCat" class="headerlink" title="MyCat"></a>MyCat</h1><h2 id="分库分表"><a href="#分库分表" class="headerlink" title="分库分表"></a>分库分表</h2><h3 id="垂直分库"><a href="#垂直分库" class="headerlink" title="垂直分库"></a>垂直分库</h3><h3 id="水平分库"><a href="#水平分库" class="headerlink" title="水平分库"></a>水平分库</h3><h3 id="分库规则"><a href="#分库规则" class="headerlink" title="分库规则"></a>分库规则</h3><ul>
<li><p>范围分片</p>
</li>
<li><p>取模分片</p>
</li>
<li><p>一致性hash</p>
<ul>
<li>针对主键不是纯数字类型</li>
</ul>
</li>
<li><p>枚举</p>
</li>
<li><p>应用指定</p>
</li>
<li><p>固定分片hash<br>id值取二进制低10为 &amp; 1111111111</p>
<p><img src="/../../../private/Note/pic/image-20220321163541472.png" alt="image-20220321163541472"></p>
</li>
<li><p>字符串hash解析</p>
<ul>
<li>截取子字符串进行hash计算 &amp; 1023</li>
</ul>
</li>
<li><p>按天分片</p>
</li>
<li><p>按自然月分片</p>
</li>
</ul>
<h3 id="管理界面"><a href="#管理界面" class="headerlink" title="管理界面"></a>管理界面</h3><ul>
<li>登录9066的管理端口<br><img src="/../../../private/Note/pic/image-20220321164806894.png" alt="image-20220321164806894"></li>
<li>安装Mycat-eye<ul>
<li>需要安装zookeeper</li>
</ul>
</li>
</ul>
<h2 id="主从分离"><a href="#主从分离" class="headerlink" title="主从分离"></a>主从分离</h2><h3 id="一主一从"><a href="#一主一从" class="headerlink" title="一主一从"></a>一主一从</h3><h3 id="双主双从"><a href="#双主双从" class="headerlink" title="双主双从"></a>双主双从</h3>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2024/01/18/Note/%E5%90%8E%E7%AB%AF/Java/%E4%B8%AD%E9%97%B4%E4%BB%B6/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%93%8D%E4%BD%9C/" data-id="clrj8k01j006g4wuw0j2tal88" data-title="数据库操作" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E4%B8%AD%E9%97%B4%E4%BB%B6/" rel="tag">中间件</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-Note/后端/Java/中间件/容器化" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2024/01/18/Note/%E5%90%8E%E7%AB%AF/Java/%E4%B8%AD%E9%97%B4%E4%BB%B6/%E5%AE%B9%E5%99%A8%E5%8C%96/" class="article-date">
  <time class="dt-published" datetime="2024-01-18T13:12:24.677Z" itemprop="datePublished">2024-01-18</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Java%E4%B8%AD%E9%97%B4%E4%BB%B6/">Java中间件</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2024/01/18/Note/%E5%90%8E%E7%AB%AF/Java/%E4%B8%AD%E9%97%B4%E4%BB%B6/%E5%AE%B9%E5%99%A8%E5%8C%96/">容器化</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="Docker"><a href="#Docker" class="headerlink" title="Docker"></a>Docker</h1><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><ul>
<li>不同环境的操作系统不同，Docker如何解决的<ul>
<li>将用户程序（配置、依赖）和需要用到的系统函数库一起打包（镜像），只要内核相同都可以运行</li>
<li>互相隔离，沙箱机制</li>
</ul>
</li>
<li>与虚拟机的差别<ul>
<li>docker是容器虚拟化，虚拟的是操作系统，虚拟机虚拟的是硬件</li>
<li>虚拟机可以运行不同的操作系统，容器只能运行同一类型的操作系统</li>
<li>docker性能更好，硬盘占用小，秒级启动速度，支持上千个容器</li>
</ul>
</li>
<li>镜像<ul>
<li>docker将用户程序（环境、配置、依赖）和需要用到的系统函数库一起打包为一个镜像</li>
</ul>
</li>
<li>容器<ul>
<li>运行镜像形成的进程就是容器，docker会给容器做隔离，对外不可见</li>
</ul>
</li>
<li>DockerHub<ul>
<li><code>hub.docker.com</code></li>
</ul>
</li>
</ul>
<h2 id="架构"><a href="#架构" class="headerlink" title="架构"></a>架构</h2><ul>
<li>CS架构<ul>
<li>服务端：Docker守护线程（Docker Daemon），负责处理Docker命令，管理镜像、容器</li>
<li>客户端：向Docker发送命令</li>
</ul>
</li>
</ul>
<h2 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h2><table>
<thead>
<tr>
<th>效果</th>
<th>指令</th>
<th>可选参数</th>
<th>参数说明</th>
</tr>
</thead>
<tbody><tr>
<td>启动docker</td>
<td>systemctl start docker</td>
<td></td>
<td></td>
</tr>
<tr>
<td>拉取镜像</td>
<td>docker pull</td>
<td></td>
<td></td>
</tr>
<tr>
<td>查看镜像</td>
<td>docker images</td>
<td></td>
<td></td>
</tr>
<tr>
<td>推送&#x2F;发布 镜像</td>
<td>docker push</td>
<td></td>
<td></td>
</tr>
<tr>
<td>压缩镜像</td>
<td>docker save</td>
<td>-o</td>
<td>压缩包名称</td>
</tr>
<tr>
<td>解压缩镜像</td>
<td>docker load</td>
<td></td>
<td></td>
</tr>
<tr>
<td>重命名镜像</td>
<td>docker tag 原名 新名</td>
<td></td>
<td></td>
</tr>
<tr>
<td>查看运行中的容器</td>
<td>docker ps</td>
<td>-a</td>
<td>查看所有</td>
</tr>
<tr>
<td>删除容器</td>
<td>docker rm id</td>
<td>r m i<br />-f</td>
<td>删除镜像<br />强制删除</td>
</tr>
<tr>
<td>创建容器</td>
<td>docker run  {相关参数}  镜像名</td>
<td>-v<br />–name<br />-p<br />-d<br />-e</td>
<td>挂载数据卷 数据卷名:容器内路径<br />容器名称<br />端口映射 宿主机 : 容器<br />后台运行<br />环境变量</td>
</tr>
<tr>
<td>进入容器</td>
<td>docker exec{容器名}</td>
<td>-it <br />bash</td>
<td>允许与容器交互（输入&#x2F;出）<br />终端交互命令</td>
</tr>
<tr>
<td>查看容器日志</td>
<td>docker logs</td>
<td>-f</td>
<td>实时打印日志</td>
</tr>
<tr>
<td>查看容器内部配置信息</td>
<td>docker inspect</td>
<td></td>
<td></td>
</tr>
<tr>
<td>关闭&#x2F;开启&#x2F;重启容器</td>
<td>docker stop&#x2F;start&#x2F;restart</td>
<td></td>
<td></td>
</tr>
<tr>
<td>将DockerFile构建为镜像</td>
<td>docker build</td>
<td>-t<br /> .</td>
<td>名字:版本<br />构建dockerfile所在的目录</td>
</tr>
<tr>
<td>数据卷相关命令</td>
<td>docker volume</td>
<td>create<br />inspect<br />ls<br />prune<br />rm</td>
<td>创建一个数据卷<br />显示一个或多个数据卷的信息<br />列出所有的volume<br />删除未使用的数据卷<br />删除指定的数据卷</td>
</tr>
<tr>
<td>部署集群</td>
<td>docker-compose up</td>
<td>-d</td>
<td>后台运行</td>
</tr>
<tr>
<td>容器自动启动</td>
<td>docker update 容器名 –restart&#x3D;always</td>
<td></td>
<td></td>
</tr>
</tbody></table>
<h2 id="常用操作"><a href="#常用操作" class="headerlink" title="常用操作"></a>常用操作</h2><ul>
<li>容器转镜像<ul>
<li>docker commit 容器id 镜像名称:版本号</li>
<li>docker save -o 压缩文件名称 镜像名称:版本号</li>
<li>docker load -i 压缩文件名称</li>
</ul>
</li>
<li>查看最新的几条日志<ul>
<li><code>docker logs -f -t --tail 条数 模块名</code></li>
</ul>
</li>
</ul>
<h2 id="数据卷"><a href="#数据卷" class="headerlink" title="数据卷"></a>数据卷</h2><ul>
<li>是一个虚拟目录，指向宿主机文件系统中的目录（&#x2F;var &#x2F;lib &#x2F;docker &#x2F;volumes &#x2F; ）</li>
<li>分目录挂载和文件挂载<ul>
<li>目录挂载：由docker管理，目录路径较长</li>
<li>文件挂载：手动创建，目录清晰，但需要自己管理</li>
</ul>
</li>
</ul>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><ol>
<li><p>卸载旧版本</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">sudo yum remove docker \</span><br><span class="line">                  docker-client \</span><br><span class="line">                  docker-client-latest \</span><br><span class="line">                  docker-common \</span><br><span class="line">                  docker-latest \</span><br><span class="line">                  docker-latest-logrotate \</span><br><span class="line">                  docker-logrotate \</span><br><span class="line">                  docker-engine</span><br></pre></td></tr></table></figure>
</li>
<li><p>安装所需软件包</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo yum install -y yum-utils \</span><br><span class="line">  device-mapper-persistent-data \</span><br><span class="line">  lvm2</span><br></pre></td></tr></table></figure>
</li>
<li><p>配置阿里云源</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo yum-config-manager \</span><br><span class="line">    --add-repo \</span><br><span class="line">    http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span><br></pre></td></tr></table></figure>
</li>
<li><p>安装</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo yum install docker-ce docker-ce-cli containerd.io</span><br></pre></td></tr></table></figure>
</li>
<li><p>设置开机自启</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl enable docker</span><br></pre></td></tr></table></figure>
</li>
<li><p>容器加速服务</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">sudo mkdir -p /etc/docker</span><br><span class="line">sudo tee /etc/docker/daemon.json &lt;&lt;-&#x27;EOF&#x27;</span><br><span class="line">&#123;</span><br><span class="line">  &quot;registry-mirrors&quot;: [&quot;https://a3fp19zs.mirror.aliyuncs.com&quot;]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line">sudo systemctl daemon-reload</span><br><span class="line">sudo systemctl restart docker</span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="DockerFile"><a href="#DockerFile" class="headerlink" title="DockerFile"></a>DockerFile</h2><h3 id="结构"><a href="#结构" class="headerlink" title="结构"></a>结构</h3><ul>
<li>基础镜像层(BaseImage)<ul>
<li>包含系统的函数库、环境变量、文件系统</li>
</ul>
</li>
<li>入口(EntryPoint)<ul>
<li>镜像中应用程序启动的命令</li>
</ul>
</li>
<li>层(Layer)<ul>
<li>在基础镜像层基础上添加安装包、依赖、配置等，每次操作形成一层</li>
</ul>
</li>
</ul>
<h3 id="指令"><a href="#指令" class="headerlink" title="指令"></a>指令</h3><table>
<thead>
<tr>
<th>关键字</th>
<th>作用</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>from</td>
<td>指定父镜像</td>
<td>说明是基于哪个image构建的</td>
</tr>
<tr>
<td>run</td>
<td>执行一段命令</td>
<td></td>
</tr>
<tr>
<td>entrypoint</td>
<td>镜像启动命令</td>
<td>入口</td>
</tr>
<tr>
<td>copy</td>
<td>复制文件</td>
<td>复制文件到image中</td>
</tr>
<tr>
<td>expose</td>
<td>指定容器运行时端口</td>
<td></td>
</tr>
<tr>
<td>env</td>
<td>设置环境变量</td>
<td>指定环境变量</td>
</tr>
</tbody></table>
<h3 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h3><ul>
<li><p>创建一个空的文件夹</p>
</li>
<li><p>导入jar包，程序jar包，DockerFile</p>
<ul>
<li><p>DockerFile内容</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#指定基础镜像</span></span><br><span class="line"><span class="keyword">FROM</span> java:<span class="number">8</span>-alpine</span><br><span class="line"><span class="comment">#复制jar</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> ./jar路径 目标路径/xxx.jar</span></span><br><span class="line"><span class="comment">#暴露端口</span></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">8081</span></span><br><span class="line"><span class="comment">#入口 Java项目的启动命令</span></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="language-bash"> java -jar 目标路径/xxx.jar</span></span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<h3 id="虚悬镜像"><a href="#虚悬镜像" class="headerlink" title="虚悬镜像"></a>虚悬镜像</h3><ul>
<li>仓库名、标签都是&lt;none&gt;的镜像</li>
<li>构建或者删除镜像时出现的错误</li>
<li>使用 <code>docker image prune</code> 删除</li>
</ul>
<h2 id="Docker-Compose"><a href="#Docker-Compose" class="headerlink" title="Docker Compose"></a>Docker Compose</h2><h3 id="简介-1"><a href="#简介-1" class="headerlink" title="简介"></a>简介</h3><ul>
<li>通过compose文件快速部署分布式应用</li>
</ul>
<h3 id="安装-1"><a href="#安装-1" class="headerlink" title="安装"></a>安装</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">下载</span></span><br><span class="line">curl -L https://github.com/docker/compose/releases/download/1.22.0/docker-compose-&#x27;uname -s&#x27;-&#x27;uname -m&#x27; -o /usr/local/bin/docker-compose</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">设置权限</span></span><br><span class="line">chmod +x /usr/local/bin/docker-compose</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">查看版本信息</span></span><br><span class="line">docker-compose -version</span><br></pre></td></tr></table></figure>

<h2 id="部署Nginx-SpringBoot项目"><a href="#部署Nginx-SpringBoot项目" class="headerlink" title="部署Nginx+SpringBoot项目"></a>部署Nginx+SpringBoot项目</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">创建目录并进入</span></span><br><span class="line">mkdir ~/docker-compose</span><br><span class="line">cd ~/docker-compose</span><br></pre></td></tr></table></figure>

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#编写文件 docker-compose.yml</span></span><br><span class="line"><span class="attr">version:</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">	<span class="attr">nginx:</span></span><br><span class="line">		<span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">    	<span class="attr">ports:</span> </span><br><span class="line">    		<span class="bullet">-</span> <span class="number">80</span><span class="string">:80</span></span><br><span class="line">    	<span class="attr">links:</span></span><br><span class="line">    		<span class="bullet">-</span> <span class="string">qpp</span></span><br><span class="line">    	<span class="attr">volumes:</span></span><br><span class="line">    		<span class="bullet">-</span> <span class="string">./nginx/conf.d:/etc/nginx/conf.d</span></span><br><span class="line">    <span class="attr">app:</span></span><br><span class="line">    	<span class="attr">image:</span> <span class="string">app</span></span><br><span class="line">    	<span class="attr">expose:</span></span><br><span class="line">    		<span class="bullet">-</span> <span class="string">&quot;8080&quot;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">创建/nginx/conf.d 目录</span></span><br><span class="line">mkdir -p ./nginx/conf.d</span><br></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">#创建并编写xxx.conf</span><br><span class="line">server&#123;</span><br><span class="line">	listen 80;</span><br><span class="line">	access_log off;</span><br><span class="line"></span><br><span class="line">	location / &#123;</span><br><span class="line">		proxy_pass http://app:8080;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">在~/docker-compose目录下启动容器</span></span><br><span class="line">docker-compose up</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">测试</span></span><br></pre></td></tr></table></figure>

<h2 id="部署微服务集群"><a href="#部署微服务集群" class="headerlink" title="部署微服务集群"></a>部署微服务集群</h2><ul>
<li>编写各个微服务的dockerfile，并且和微服务的jar包放在同一级目录下<ul>
<li>mysql需要打包配置和数据</li>
</ul>
</li>
<li>编写docker-compose.yml文件</li>
<li>修改各个微服务内服务调用时的ip，用服务名替代</li>
<li>将docker-compose和所有微服务的dockerfile和jar打包到服务器上</li>
</ul>
<h2 id="私有仓库"><a href="#私有仓库" class="headerlink" title="私有仓库"></a>私有仓库</h2><h3 id="搭建"><a href="#搭建" class="headerlink" title="搭建"></a>搭建</h3><ul>
<li><p>使用docker-compose部署具有图形化界面的DockerRegistry</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3.0&#x27;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">	<span class="attr">registry:</span></span><br><span class="line">		<span class="attr">image:</span> <span class="string">registry</span></span><br><span class="line">		<span class="attr">volumes:</span> </span><br><span class="line">			<span class="bullet">-</span> <span class="string">./registry-data:/var/lib/registry</span></span><br><span class="line">	<span class="attr">ui:</span></span><br><span class="line">		<span class="attr">image:</span> <span class="string">joxit/docker-registry-ui:static</span></span><br><span class="line">		<span class="attr">port:</span></span><br><span class="line">			<span class="bullet">-</span> <span class="number">8080</span><span class="string">:80</span></span><br><span class="line">		<span class="attr">environment:</span></span><br><span class="line">			<span class="bullet">-</span> <span class="string">REGISTRY_TITLE=</span></span><br><span class="line">			<span class="bullet">-</span> <span class="string">REGISTRY_URL=http://registry:5000</span></span><br><span class="line">		<span class="attr">depends_on:</span></span><br><span class="line">			<span class="bullet">-</span> <span class="string">registry</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>配置Docker信任地址，私服一般是http协议，docker默认不信任</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">打开要修改的文件</span></span><br><span class="line">vi /etc/docker/daemon.json</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">添加内容</span></span><br><span class="line">&quot;insecure-registries&quot;:[&quot;http:...&quot;]</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">重加载</span></span><br><span class="line">systemctl daemon-reload</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">重启docker</span></span><br><span class="line">systemctl restart docker</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h3><ul>
<li>推送镜像需要先tag（重命名镜像）</li>
</ul>
<h2 id="Docker-Net"><a href="#Docker-Net" class="headerlink" title="Docker Net"></a>Docker Net</h2><h3 id="简介-2"><a href="#简介-2" class="headerlink" title="简介"></a>简介</h3><ul>
<li>docker启动时会在宿主机上创建一个网络配置</li>
<li>用于在不同docker之间的网络通信以及端口映射</li>
<li>一共有四种网络模式<ul>
<li>bridge：为每个容器分配、设置ip，并连接到docker0 （默认）</li>
<li>host：使用宿主机的ip和端口</li>
<li>none：容器有独立的网络空间，但没有设置，需要自定义</li>
<li>container：共享某个容器的ip</li>
</ul>
</li>
<li>bridge模式下<ul>
<li>容器被删除其ip会被回收</li>
</ul>
</li>
</ul>
<h3 id="命令"><a href="#命令" class="headerlink" title="命令"></a>命令</h3><p><code>docker network</code></p>
<table>
<thead>
<tr>
<th>效果</th>
<th>指令</th>
<th>可选参数</th>
<th>参数说明</th>
</tr>
</thead>
<tbody><tr>
<td></td>
<td>connect</td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td>create</td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td>disconnect</td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td>inspect</td>
<td></td>
<td></td>
</tr>
<tr>
<td>查看网络列表</td>
<td>ls</td>
<td></td>
<td></td>
</tr>
<tr>
<td>删除无用网络</td>
<td>prune</td>
<td></td>
<td></td>
</tr>
<tr>
<td>删除网络</td>
<td>rm</td>
<td></td>
<td></td>
</tr>
</tbody></table>
<h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><h3 id="桌面端打不开"><a href="#桌面端打不开" class="headerlink" title="桌面端打不开"></a>桌面端打不开</h3><ul>
<li><code>netsh winsock reset</code></li>
</ul>
<h2 id="整合"><a href="#整合" class="headerlink" title="整合"></a>整合</h2><h3 id="Redis"><a href="#Redis" class="headerlink" title="Redis"></a>Redis</h3><ol>
<li><p>拉取</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull redis</span><br></pre></td></tr></table></figure>
</li>
<li><p>启动</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">docker run -p 6379:6379  --name redis\</span><br><span class="line">	-v /mydata/redis/data:/data\ #数据文件挂载</span><br><span class="line">	-v /mydata/redis/conf/redis.conf:/etc/redis/redis.conf\ #配置文件挂载</span><br><span class="line">	-d redis redis-server /etc/redis/redis.conf #后台运行</span><br><span class="line">	--appendonly yes #开启aof持久化</span><br></pre></td></tr></table></figure>
</li>
<li><p>进入容器</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker exec -it redis redis-cli</span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="Nginx"><a href="#Nginx" class="headerlink" title="Nginx"></a>Nginx</h3><ul>
<li><code>docker run --name nginx -p 80:80 -v html:/usr/share/nginx/html -d nginx</code><ul>
<li>容器内路径可以在dockerhub上查看</li>
</ul>
</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">拉取镜像</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">创建挂载目录</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">生成容器</span></span><br><span class="line">docker run --name nginx -p 9001:80 -d nginx</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">将容器nginx.conf文件复制到宿主机</span></span><br><span class="line">docker cp nginx:/etc/nginx/nginx.conf 本地位置/conf//nginx.conf</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">将容器conf.d文件夹下内容复制到宿主机</span></span><br><span class="line">docker cp nginx:/etc/nginx/conf.d 本地位置/conf/conf.d</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">将容器中的html文件夹复制到宿主机</span></span><br><span class="line">docker cp nginx:/usr/share/nginx/html 本地位置/html</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">关闭该容器</span></span><br><span class="line">docker stop nginx</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">删除该容器</span></span><br><span class="line">docker rm nginx</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">docker run -p 80:80 --name nginx -v C:\Soft\Docker\config\nginx\nginx.conf:/etc/nginx/nginx.conf -v C:\Soft\Docker\config\nginx\conf.d:/etc/nginx/conf.d -v C:\Soft\Docker\log\nginx:/var/log/nginx -v C:\Soft\Docker\html\nginx:/usr/share/nginx/html -d nginx:stable-alpine3.17-slim</span><br></pre></td></tr></table></figure>



<h3 id="MySQL"><a href="#MySQL" class="headerlink" title="MySQL"></a>MySQL</h3><ol>
<li><p>拉取</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull mysql</span><br></pre></td></tr></table></figure>
</li>
<li><p>启动</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">docker run -p 3306:3306 --name mysql\</span><br><span class="line">	-v /mydata/mysql/log:/var/log/mysql\</span><br><span class="line">	-v /mydata/mysql/data:/var/lib/mysql\ #数据文件挂载</span><br><span class="line">	-v /mydata/mysql/conf:/etc/mysql/conf.d/hmy.cnf #配置文件挂载</span><br><span class="line">	-e MYSQL_ROOT_PASSWORD=123456\</span><br><span class="line">	-d mysql #后台运行</span><br></pre></td></tr></table></figure>

<ul>
<li>挂载是文件夹需要存在</li>
</ul>
</li>
<li><p>进入容器</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker exec -it mysql bash</span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="Camunda"><a href="#Camunda" class="headerlink" title="Camunda"></a>Camunda</h3><ol>
<li><p>拉取</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull camubda</span><br></pre></td></tr></table></figure>
</li>
<li><p>启动</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">docker run -d --name camunda -p 8000:8000 \</span><br><span class="line">    -e DB_DRIVER=com.mysql.cj.jdbc.Driver \ </span><br><span class="line">    -e DB_URL=jdbc:mysql://服务器IP:3306/camunda \</span><br><span class="line">    -e DB_USERNAME=root \ </span><br><span class="line">    -e DB_PASSWORD=123456 \ </span><br><span class="line">    -e WAIT_FOR=服务器IP:3306 \ </span><br><span class="line">    camunda镜像名</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建camunda数据库</p>
</li>
</ol>
<h3 id="RabbitMQ"><a href="#RabbitMQ" class="headerlink" title="RabbitMQ"></a>RabbitMQ</h3><h3 id="ElasticSearch"><a href="#ElasticSearch" class="headerlink" title="ElasticSearch"></a>ElasticSearch</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">拉取ElasticSearch</span></span><br><span class="line">docker pull elasticsearch</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">拉取kibana</span></span><br><span class="line">ocker pull kibana</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">挂载数据卷和配置</span></span><br><span class="line">mkdir -p 本地位置/config</span><br><span class="line">mkdir -p 本地位置/plugins</span><br><span class="line">mkdir -p 本地位置/data</span><br><span class="line">echo &quot;http.host:0.0.0.0&quot; &gt;&gt; 本地位置/config/elasticsearch.yml</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">启动容器</span></span><br><span class="line">docker run --name elasticsearch -p 9200:9200 -p 9300:9300 </span><br><span class="line">	-e &quot;discovery.type=single-node&quot; </span><br><span class="line">	-e ES_JAVA_OPTS=&quot;-Xms512m -Xmx1024m&quot;	</span><br><span class="line">	-v 本地位置/config/elasticsearch.yml:/usr/share/elasticsearch/config/elasticsearch.yml</span><br><span class="line">	-v 本地位置/data:/usr/share/elasticsearch/data</span><br><span class="line">	-v 本地位置/plugins:/usr/share/elasticsearch/plugins</span><br><span class="line">	-d elasticsearch</span><br><span class="line">	</span><br><span class="line">docker run --name elasticsearch -p 9200:9200 -p 9300:9300 -e &quot;discovery.type=single-node&quot; -e ES_JAVA_OPTS=&quot;-Xms512m -Xmx1024m&quot; -v C:\Soft\Docker\config\es\elasticsearch.yml:/usr/share/elasticsearch/config/elasticsearch.yml -v C:\Soft\Docker\volume\es:/usr/share/elasticsearch/data -v C:\Soft\Docker\plugins\es:/usr/share/elasticsearch/plugins -d elasticsearch:7.17.7</span><br></pre></td></tr></table></figure>

<ul>
<li><code>-e ES_JAVA_OPTS=&quot;-Xms512m -Xmx1024m&quot;</code>	#防止es占满全部内存</li>
</ul>
<h3 id="Kibana"><a href="#Kibana" class="headerlink" title="Kibana"></a>Kibana</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">拉取</span></span><br><span class="line">docker pull kibana</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">运行容器</span></span><br><span class="line">docker run --name kibana -e ELASTICSEARCH_HOSTS=http://192.168.11.94:9200 -p 5601:5601 -d kibana:7.17.7</span><br><span class="line"></span><br><span class="line">docker stop kibana</span><br><span class="line">docker rm kibana</span><br></pre></td></tr></table></figure>

<h3 id="Oracle"><a href="#Oracle" class="headerlink" title="Oracle"></a>Oracle</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d  --restart always -p 1524:1521 -p 5502:5500 -e ORACLE_SID=ORCLCDB -e ORACLE_PDB=ORCLPDB1 -e ORACLE_PWD=123456 -e ORACLE_EDITION=standard -e ORACLE_CHARACTERSET=AL32UTF8 -v C:\Soft\Docker\volume\oracle:/opt/oracle/oradata --name orcl19c_03 doctorkirk/oracle-19c</span><br></pre></td></tr></table></figure>

<h1 id="Jenkins"><a href="#Jenkins" class="headerlink" title="Jenkins"></a>Jenkins</h1><h2 id="简介-3"><a href="#简介-3" class="headerlink" title="简介"></a>简介</h2><ul>
<li>持续部署</li>
<li>需要有Maven环境、Java环境、Docker环境、Git环境</li>
<li>可在Jenkin中安装插件<ul>
<li>Maven插件</li>
<li>Publish Over SSH 插件<ul>
<li>在DashBoard -&gt; Manage Jenkins下 Configure System中添加远程服务器</li>
<li>然后在Post Steps和Pre Steps中可以使用<ul>
<li>用于杀死原Java进程</li>
<li>后台运行Java进程</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h1 id="Kubernetes"><a href="#Kubernetes" class="headerlink" title="Kubernetes"></a>Kubernetes</h1><h2 id="简介-4"><a href="#简介-4" class="headerlink" title="简介"></a>简介</h2><ul>
<li>为了容器编排的问题，即容灾和扩展</li>
<li>本质是一组服务器集群，实现资源管理自动化</li>
<li>特点<ul>
<li><strong>服务发现和负载均衡</strong>：可以使用DNS名称或IP地址公开容器，k8s可以负载均衡并分配网络流量，从而使部署稳定</li>
<li><strong>存储编排</strong>：允许自动挂载选择的存储系统</li>
<li><strong>自动部署和版本回退</strong>：一次性将所有相关的服务进行版本升级或者回退</li>
<li><strong>自动装箱计算</strong>：允许指定容器所需的CPU和内存</li>
<li><strong>自我修复</strong>：重新启动失败的容器，替换容器，杀死不响应运行状况检查的容器</li>
<li><strong>密钥与配置管理</strong>：存储敏感信息</li>
</ul>
</li>
</ul>
<h2 id="组成部分"><a href="#组成部分" class="headerlink" title="组成部分"></a>组成部分</h2><p><img src="/../../../private/Note/Java/pic/image-20230418002050041.png" alt="image-20230418002050041"></p>
<h3 id="控制节点（master）（硅谷总部）"><a href="#控制节点（master）（硅谷总部）" class="headerlink" title="控制节点（master）（硅谷总部）"></a>控制节点（master）（硅谷总部）</h3><ul>
<li><p>ApiServer（秘书部）：资源操作的唯一入口，接收用户输入的命令，提供认证、授权、API注册和发现等机制</p>
<ul>
<li>所有的组件交互都通过ApiServer</li>
</ul>
</li>
<li><p>Scheduler（调度者）：负责集群资源调度，按照预定的调度策略将Pod调度到相应的node节点上</p>
</li>
<li><p>ControllerManager（决策者）：负责维护集群的状态，比如程序部署安排、故障检测、自动扩展、滚动更新等</p>
</li>
<li><p>Etcd（资料库）：负责存储集群中各种资源对象的信息</p>
</li>
</ul>
<h3 id="工作节点（node）（东西南北厂）"><a href="#工作节点（node）（东西南北厂）" class="headerlink" title="工作节点（node）（东西南北厂）"></a>工作节点（node）（东西南北厂）</h3><ul>
<li><p>Kubelet（厂长）：负责维护容器的生命周期，即通过控制docker，来创建、更新、销毁容器</p>
<ul>
<li>按一定频率访问ApiServer，获取最新的决策信息</li>
<li>监控改节点所有的服务的状态</li>
<li>服务出问题也会通知ApiServer</li>
</ul>
</li>
<li><p>KubeProxy（门卫）：负责提供集群内部的服务发现和负载均衡</p>
<ul>
<li>负责所有项目的访问，所有的网络访问都是通过KubeProxy访问的</li>
<li>记录了所有服务的位置</li>
<li>KubeProxy之间是相互同步的</li>
</ul>
</li>
<li><p>Docker：负责节点上容器的各种操作作</p>
</li>
</ul>
<h2 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h2><ol>
<li><p>安装Docker</p>
</li>
<li><p>设置环境信息</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">设置主机名（节点间主机名不可重复）</span></span><br><span class="line">hostnamectl set-hostname xxx</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">将 SELinux 设置为 permissive 模式（相当于将其禁用）</span></span><br><span class="line">sudo setenforce 0</span><br><span class="line">sudo sed -i &#x27;s/^SELINUX=enforcing$/SELINUX=permissive/&#x27; /etc/selinux/config</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">关闭swap分区</span></span><br><span class="line">swapoff -a</span><br><span class="line">sed -ri&#x27;s/.*swap.*/#&amp;/&#x27; /etc/fstab</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">允许 iptables 检查桥接流量</span></span><br><span class="line">cat &lt;&lt;EOF  sudo tee /etc/modules-load.d/k8s .conf</span><br><span class="line">br netfilter</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">cat &lt;&lt;EOF  sudo tee /etc/sysct1.d/k8s .conf</span><br><span class="line">net.bridge.bridge-nf-call-ip6tables = 1</span><br><span class="line">net.bridge.bridge-nf-call-iptables = 1</span><br><span class="line">EOF</span><br><span class="line">sudo sysctl --system</span><br></pre></td></tr></table></figure>
</li>
<li><p>安装Kubelet、Kubectl、kubeadm</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt;EOF | sudo tee /etc/yum.repos.d/kubernetes.repo</span><br><span class="line">[kubernetes]</span><br><span class="line">name=Kubernetes</span><br><span class="line">baseurl=http://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=0</span><br><span class="line">repo_gpgcheck=0</span><br><span class="line">gpgkey=http://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg</span><br><span class="line">	http://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg</span><br><span class="line">exclude=kubelet kubeadm kubectl</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">sudo yum install -y kubelet-1.20.9 kubeadm-1.20.9 kubectl-1.20.9 --disableexcludes=kubernetes</span><br><span class="line">sudo systemctl enable --now kubelet</span><br></pre></td></tr></table></figure>
</li>
<li><p>安装镜像</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">sudo tee ./images,sh &lt;&lt;-&#x27;EOF&#x27;</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line">images=(</span><br><span class="line">kube-apiserver:v1.20.9</span><br><span class="line">kube-proxy:v1.20.9</span><br><span class="line">kube-controller-manager:v1.20.9</span><br><span class="line">kube-scheduler:v1.20.9</span><br><span class="line">coredns:1.7.0</span><br><span class="line">etcd:3.4.13-0</span><br><span class="line">pause:3.2</span><br><span class="line">)</span><br><span class="line">for imageName in $&#123;images[@]&#125; ; do</span><br><span class="line">docker pull registry.cn-hangzhou.aliyuncs,com/lfy_k8s_images/$imageName</span><br><span class="line">done</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">chmod +x ./images .sh &amp;&amp; ./images .sh</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">所有机器添加master域名映射，以下需要修改为自己的</span></span><br><span class="line">echo &quot;master节点ip地址 cluster-endpoint” &gt;&gt; /etc/hosts</span><br></pre></td></tr></table></figure>
</li>
<li><p>初始化主节点（master节点）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">主节点初始化</span></span><br><span class="line">kubeadm init</span><br><span class="line">--apiserver-advertise-address=master节点ip地址 \</span><br><span class="line">--control-plane-endpoint=cluster-endpoint \</span><br><span class="line">--image-repository registry.cn-hangzhou.aliyuncs.com/lfy_k8s_images \</span><br><span class="line">--kubernetes-version v1.20.9 \</span><br><span class="line">--service-cidr=10.96.0.0/16 \</span><br><span class="line">--pod-network-cidr=192.168.0.0/16</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">所有网络范围不重叠</span></span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">第5步完成安装后会提示这个，以第5步提示的为准</span></span><br><span class="line">mkdir -p $HOME/.kube</span><br><span class="line">sudo cp -i /etc/kubernetes/admin.conf HOME/.kube/config</span><br><span class="line">sudo chown s(id -u):$(id -g) SHOME/.kube/config</span><br></pre></td></tr></table></figure>
</li>
<li><p>主节点部署网络插件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl https://docs.projectcalico.org/v3.20/manifests/calico.yaml -O</span><br><span class="line">kubectl apply -f calico.yaml</span><br></pre></td></tr></table></figure>
</li>
<li><p>设置为工作节点</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">第5步完成安装后会提示这个，以第5步提示的为准</span></span><br><span class="line">kubeadm join cluster-endpoint:6443 --token x5g4uy.wpjjdbgra92s25pp 、</span><br><span class="line">--discovery-token-ca-cert-hash</span><br><span class="line">sha256:6255797916eaee52bf9dda9429db616fcd828436708345a308f4b917d3457a22</span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="使用-1"><a href="#使用-1" class="headerlink" title="使用"></a>使用</h2><ol>
<li>kubeadm</li>
</ol>
<ul>
<li><code>kubernete init</code> 初始化为master节点</li>
<li><code>kubernete  join</code> 其他节点作为工作节点</li>
</ul>
<h2 id="命令-1"><a href="#命令-1" class="headerlink" title="命令"></a>命令</h2><table>
<thead>
<tr>
<th>命令</th>
<th>功能</th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td>kubectl get nodes</td>
<td>查看集群所有节点</td>
<td></td>
</tr>
<tr>
<td>kubectl apply -f xxxx.yaml</td>
<td>根据配置文件，给集群创建资源</td>
<td></td>
</tr>
<tr>
<td>docker ps | &#x3D;&#x3D;&#x3D; kubectl get pods -A</td>
<td>查看集群部署了哪些应用</td>
<td></td>
</tr>
<tr>
<td>kubectl get pods -A</td>
<td>运行中的应用在docker里面叫容器，在k8s里面叫Pod</td>
<td></td>
</tr>
</tbody></table>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2024/01/18/Note/%E5%90%8E%E7%AB%AF/Java/%E4%B8%AD%E9%97%B4%E4%BB%B6/%E5%AE%B9%E5%99%A8%E5%8C%96/" data-id="clrj8k01i006a4wuwefs37pq8" data-title="容器化" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E4%B8%AD%E9%97%B4%E4%BB%B6/" rel="tag">中间件</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-Note/后端/Java/中间件/工作流" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2024/01/18/Note/%E5%90%8E%E7%AB%AF/Java/%E4%B8%AD%E9%97%B4%E4%BB%B6/%E5%B7%A5%E4%BD%9C%E6%B5%81/" class="article-date">
  <time class="dt-published" datetime="2024-01-18T13:12:24.677Z" itemprop="datePublished">2024-01-18</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Java%E4%B8%AD%E9%97%B4%E4%BB%B6/">Java中间件</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2024/01/18/Note/%E5%90%8E%E7%AB%AF/Java/%E4%B8%AD%E9%97%B4%E4%BB%B6/%E5%B7%A5%E4%BD%9C%E6%B5%81/">工作流</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="Activiti7"><a href="#Activiti7" class="headerlink" title="Activiti7"></a>Activiti7</h1><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><ul>
<li><p>做审批和流程</p>
</li>
<li><p>是一个引擎</p>
</li>
<li><p>传统的实现方式是通过状态字段来实现的</p>
<ul>
<li>缺点是一旦流程节点增加或减少都要修改代码，很麻烦</li>
<li>链路追踪也麻烦，需要保存历史数据</li>
</ul>
</li>
<li><p>Activiti 其实就是封装了上面的操作，用工具来制定流程图规则</p>
</li>
<li><p>Activiti会将流程图转换成xml文件，然后再解析xml，将对应的记录插入数据库</p>
</li>
<li><p>一个流程图中的所有阶段都会存在一张表里</p>
</li>
<li><p>一条记录代表一个节点</p>
</li>
<li><p>每处理完一个节点就删除上一个节点</p>
</li>
</ul>
<h1 id="Camunda"><a href="#Camunda" class="headerlink" title="Camunda"></a>Camunda</h1><h2 id="简介-1"><a href="#简介-1" class="headerlink" title="简介"></a>简介</h2><ul>
<li>源自Activiti5</li>
<li>支持组件模式和云原生</li>
<li>高性能（乐观锁、缓存）、高扩展、高稳定、独有的外部任务模式、支持多租户、完善的Api</li>
</ul>
<h2 id="使用方式"><a href="#使用方式" class="headerlink" title="使用方式"></a>使用方式</h2><h3 id="嵌入用法"><a href="#嵌入用法" class="headerlink" title="嵌入用法"></a>嵌入用法</h3><ul>
<li>与业务深度整合，生命周期和业务一致</li>
<li>不用单独部署和维护</li>
<li>不方便扩容</li>
</ul>
<h3 id="组件式用法"><a href="#组件式用法" class="headerlink" title="组件式用法"></a>组件式用法</h3><ul>
<li>不常用</li>
</ul>
<h3 id="中间件用法"><a href="#中间件用法" class="headerlink" title="中间件用法"></a>中间件用法</h3><ul>
<li>部署为平台模式，支持多项目公用，与业务完全解耦</li>
<li>方便扩容</li>
<li>存在单点风险，远程调用存在一定的性能损耗</li>
</ul>
<h3 id="云原生用法（camunda8）"><a href="#云原生用法（camunda8）" class="headerlink" title="云原生用法（camunda8）"></a>云原生用法（camunda8）</h3>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2024/01/18/Note/%E5%90%8E%E7%AB%AF/Java/%E4%B8%AD%E9%97%B4%E4%BB%B6/%E5%B7%A5%E4%BD%9C%E6%B5%81/" data-id="clrj8k01i006e4wuw1dxb2zme" data-title="工作流" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E4%B8%AD%E9%97%B4%E4%BB%B6/" rel="tag">中间件</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-Note/后端/Java/中间件/Web中间件" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2024/01/18/Note/%E5%90%8E%E7%AB%AF/Java/%E4%B8%AD%E9%97%B4%E4%BB%B6/Web%E4%B8%AD%E9%97%B4%E4%BB%B6/" class="article-date">
  <time class="dt-published" datetime="2024-01-18T13:12:24.676Z" itemprop="datePublished">2024-01-18</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Java%E4%B8%AD%E9%97%B4%E4%BB%B6/">Java中间件</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2024/01/18/Note/%E5%90%8E%E7%AB%AF/Java/%E4%B8%AD%E9%97%B4%E4%BB%B6/Web%E4%B8%AD%E9%97%B4%E4%BB%B6/">网络传输</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="Netty"><a href="#Netty" class="headerlink" title="Netty"></a>Netty</h1><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><ul>
<li><p>在NIO上做了很多优化</p>
<ul>
<li>零拷贝</li>
<li>高性能无锁队列</li>
<li>内存池</li>
</ul>
</li>
<li><p>支持多种通信协议</p>
<ul>
<li>http</li>
<li>websocket</li>
</ul>
</li>
<li><p>解决拆包粘包的问题，内置了拆包策略</p>
</li>
<li><p>是一个异步的，基于事件驱动的网络应用框架，即使用了IO多路复用的技术</p>
</li>
<li><p>基于NIO，在NIO上做了很多优化</p>
<ul>
<li>零拷贝</li>
<li>高性能无锁队列</li>
<li>内存池</li>
<li>解决拆包粘包的问题，内置了拆包策略</li>
<li>解决epoll空轮询CPU 100%问题</li>
<li>提供了易用的Api</li>
</ul>
</li>
<li><p>支持多种通信协议</p>
<ul>
<li>http</li>
<li>websocket</li>
</ul>
</li>
</ul>
<h1 id="WebSocket"><a href="#WebSocket" class="headerlink" title="WebSocket"></a>WebSocket</h1><h2 id="简介-1"><a href="#简介-1" class="headerlink" title="简介"></a>简介</h2><ul>
<li>基于TCP的全双工通信，双向传输</li>
</ul>
<h2 id="SpringBoot整合WebSocket"><a href="#SpringBoot整合WebSocket" class="headerlink" title="SpringBoot整合WebSocket"></a>SpringBoot整合WebSocket</h2><ul>
<li>发送消息<ul>
<li><code>session.sendMessage(TextMessage对象)</code></li>
</ul>
</li>
</ul>
<h2 id="WebSocket拦截器"><a href="#WebSocket拦截器" class="headerlink" title="WebSocket拦截器"></a>WebSocket拦截器</h2><ul>
<li><p>可以在建立连接之前写一些业务逻辑</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyHandshakeInterceptor</span> <span class="keyword">implements</span> <span class="title class_">HandshakeInterceptor</span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">beforeHandshake</span><span class="params">(ServerHttpRequest request, ServerHttpReponse response, WebSocketHandler wsHandler, Map&lt;String, Object&gt; attributes)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="comment">//将用户id放入socket处理器的会话中</span></span><br><span class="line">        attributes.put(<span class="string">&quot;uid&quot;</span>, <span class="number">1001</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterHandshake</span><span class="params">(ServerHttpRequest request, ServerHttpReponse response, WebSocketHandler wsHandler, Exception exception)</span>&#123;</span><br><span class="line">        <span class="comment">//握手成功后的逻辑</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
<li><p>编写WebSocketConfig，添加拦截器后才能生效</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebSocketConfig</span> <span class="keyword">implements</span> <span class="title class_">WebSocketConfigurer</span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MyHandshakeInterceptor myHandshakeInterceptor;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">registerWebSocketHandlers</span><span class="params">(WebSocketHandlerRegistry registry)</span>&#123;</span><br><span class="line">        registry.addHandler()</span><br><span class="line">            .addInterceptors(myHandshakeInterceptor);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="分布式WebSocket"><a href="#分布式WebSocket" class="headerlink" title="分布式WebSocket"></a>分布式WebSocket</h2><ul>
<li>生产者<ul>
<li>当发现发送信息的对象toid为空或者不在线时，可能在其他节点中<ul>
<li>通过rocketMQ去查询其他socket服务端是否存在该客户端的session</li>
</ul>
</li>
<li>注入Rocket’MQTemplate，使用convertAndSend(topic:tags, 序列化的message)发送到MQ消息系统</li>
</ul>
</li>
<li>消费者<ul>
<li>需要实现RocketMQListener<String>接口</li>
<li>添加@RocketMqMessageListener(topic &#x3D; “topic”, selectorExpression &#x3D; “tag”, messageModel &#x3D;  , consumerGroup &#x3D; “”)</li>
<li>重写 onMessage(String msg)</li>
</ul>
</li>
</ul>
<h1 id="Nginx"><a href="#Nginx" class="headerlink" title="Nginx"></a>Nginx</h1><h2 id="反向代理"><a href="#反向代理" class="headerlink" title="反向代理"></a>反向代理</h2><h3 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h3><ul>
<li>正向代理<ul>
<li>客户端挂了VPN访问外网</li>
</ul>
</li>
</ul>
<p><img src="/../../../blog/source/images/image-20220130094513472.png" alt="image-20220130094513472"></p>
<ul>
<li>反向代理<ul>
<li>服务器挂了VPN传输数据给客户端</li>
<li>这个VPN就是Nginx</li>
</ul>
</li>
</ul>
<p><img src="/../../../blog/source/images/image-20220130094938341.png" alt="image-20220130094938341"></p>
<h2 id="负载均衡"><a href="#负载均衡" class="headerlink" title="负载均衡"></a>负载均衡</h2><p><img src="/../../../blog/source/images/image-20220130095357695.png" alt="image-20220130095357695"></p>
<p><img src="/../../../blog/source/images/image-20220130124809603.png" alt="image-20220130124809603"></p>
<h3 id="策略"><a href="#策略" class="headerlink" title="策略"></a>策略</h3><ul>
<li><p>轮询（默认）</p>
<ul>
<li>每个请求按时间顺序分配到不同的服务器，如果服务器down会自动剔除</li>
</ul>
</li>
<li><p>weight（权重）</p>
<ul>
<li>默认是1，权重越高被分配的客户端越多</li>
<li>一般按服务器性能分配</li>
</ul>
</li>
<li><p>ip_hash</p>
<ul>
<li>每个请求按照访问ip的hash结果进行分配，使每个访客固定访问一个服务器，</li>
<li>可以解决session的问题</li>
</ul>
</li>
<li><p>fair</p>
<ul>
<li>按后端的响应时间来分配，响应时间短的优先分配</li>
</ul>
</li>
</ul>
<h2 id="动静分离"><a href="#动静分离" class="headerlink" title="动静分离"></a>动静分离</h2><ul>
<li>就是把静态资源放置在一个独立的服务器上，不用每次都从jar包中加载，提高效率</li>
</ul>
<p><img src="/../../../blog/source/images/image-20220130095623236.png" alt="image-20220130095623236"></p>
<h3 id="实现方式"><a href="#实现方式" class="headerlink" title="实现方式"></a>实现方式</h3><h4 id="方式一"><a href="#方式一" class="headerlink" title="方式一"></a>方式一</h4><ul>
<li>把静态资源文件独立成单独的域名，放在独立的服务器上</li>
</ul>
<h4 id="方式二"><a href="#方式二" class="headerlink" title="方式二"></a>方式二</h4><ul>
<li>把动态和静态资源一起发布，通过nginx分离</li>
</ul>
<hr>
<p><img src="/../../../blog/source/images/image-20220131115135873.png" alt="image-20220131115135873"></p>
<p><img src="/../../../blog/source/images/image-20220131120546783.png" alt="image-20220131120546783"></p>
<h2 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h2><h3 id="全局块（开头到events之间）"><a href="#全局块（开头到events之间）" class="headerlink" title="全局块（开头到events之间）"></a>全局块（开头到events之间）</h3><ul>
<li>worker_processes<ul>
<li>并发处理的数量</li>
</ul>
</li>
</ul>
<h3 id="events块"><a href="#events块" class="headerlink" title="events块"></a>events块</h3><ul>
<li>主要影响服务器与用户的网络连接</li>
<li>worker_connections<ul>
<li>最大的连接数</li>
</ul>
</li>
</ul>
<h3 id="http块"><a href="#http块" class="headerlink" title="http块"></a>http块</h3><ul>
<li>代理、缓存、日志等大多数功能和第三方模块都在这配置</li>
<li>包含两大块<ul>
<li>http全局块<ul>
<li>文件引入、定义、连接超时时间，连接请求数上限</li>
</ul>
</li>
<li>server块<ul>
<li>和虚拟主机有关</li>
<li>包含两大块<ul>
<li>全局server块<ul>
<li>端口、主机名</li>
</ul>
</li>
<li>location块<ul>
<li>地址</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h2><ul>
<li>需要进入到 ..&#x2F;nginx&#x2F;sbin&#x2F;  下执行<ul>
<li>service start nginx          启动nginx</li>
<li>.&#x2F;nginx -s stop              关闭nginx </li>
<li>.&#x2F;nginx -s quit              安全退出</li>
<li>.&#x2F;nginx -s reload            重新加载nginx配置文件</li>
</ul>
</li>
</ul>
<h2 id="Nginx常见问题"><a href="#Nginx常见问题" class="headerlink" title="Nginx常见问题"></a>Nginx常见问题</h2><ul>
<li>Nginx为什么快<ul>
<li>采用了异步非阻塞模式，使用了epoll模型以及队列</li>
</ul>
</li>
<li>Nginx的优缺点<ul>
<li>优点：占用内存小，响应快，支持高并发，配置简单，不会暴露服务器ip地址</li>
<li>缺点：处理动态页面鸡肋</li>
</ul>
</li>
<li>Nginx使用的场景<ul>
<li>静态服务器，虚拟主机，反向代理，动静分离，负载均衡，限流</li>
</ul>
</li>
<li>限流的方式<ul>
<li>正常流量限制访问频率</li>
<li>突发流量限制访问频率</li>
<li>限制并发连接数</li>
</ul>
</li>
<li>漏桶流和令牌桶<ul>
<li>漏桶流<ul>
<li>突发流量转变为平稳的流量，大口进，小口出</li>
</ul>
</li>
<li>令牌桶<ul>
<li>有一个大小固定的令牌桶，以固定的速度生成令牌并放入令牌桶中，拿到令牌的请求才可以执行对应的业务逻辑</li>
</ul>
</li>
</ul>
</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2024/01/18/Note/%E5%90%8E%E7%AB%AF/Java/%E4%B8%AD%E9%97%B4%E4%BB%B6/Web%E4%B8%AD%E9%97%B4%E4%BB%B6/" data-id="clrj8k01h00654wuwcek10m6g" data-title="网络传输" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E4%B8%AD%E9%97%B4%E4%BB%B6/" rel="tag">中间件</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-Note/后端/Java/中间件/定时任务" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2024/01/18/Note/%E5%90%8E%E7%AB%AF/Java/%E4%B8%AD%E9%97%B4%E4%BB%B6/%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1/" class="article-date">
  <time class="dt-published" datetime="2024-01-18T13:12:24.676Z" itemprop="datePublished">2024-01-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="Scheduled"><a href="#Scheduled" class="headerlink" title="@Scheduled"></a>@Scheduled</h1><h2 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h2><ol>
<li><p>在类上添加@EnableScheduling启用调度注解</p>
</li>
<li><p>在需要执行定时任务的方法上添加@Scheduled</p>
<ul>
<li><p>cron表达式</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">┌───────────── second (0-59)</span><br><span class="line">│ ┌───────────── minute (0 - 59)</span><br><span class="line">│ │ ┌───────────── hour (0 - 23)</span><br><span class="line">│ │ │ ┌───────────── day of the month (1 - 31)</span><br><span class="line">│ │ │ │ ┌───────────── month (1 - 12) (or JAN-DEC)</span><br><span class="line">│ │ │ │ │ ┌───────────── day of the week (0 - 7) (0 or 7 </span><br><span class="line">│ │ │ │ │ │</span><br><span class="line">│ │ │ │ │ │</span><br><span class="line">* * * * * *</span><br></pre></td></tr></table></figure>
</li>
<li><p>zone：时区</p>
</li>
<li><p>timeUnit：时间单位</p>
</li>
<li><p>fixedDelay：固定间隔</p>
</li>
<li><p>fixedRate：固定速率</p>
</li>
<li><p>initialDelay：第一次延时时间</p>
</li>
</ul>
</li>
</ol>
<h1 id="XXL-JOB"><a href="#XXL-JOB" class="headerlink" title="XXL-JOB"></a>XXL-JOB</h1>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2024/01/18/Note/%E5%90%8E%E7%AB%AF/Java/%E4%B8%AD%E9%97%B4%E4%BB%B6/%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1/" data-id="clrj8k01h00684wuw3nq2gtu9" data-title="" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-Note/后端/Go/框架/Beego" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2024/01/18/Note/%E5%90%8E%E7%AB%AF/Go/%E6%A1%86%E6%9E%B6/Beego/" class="article-date">
  <time class="dt-published" datetime="2024-01-18T13:12:24.672Z" itemprop="datePublished">2024-01-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><ul>
<li>MVC架构</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2024/01/18/Note/%E5%90%8E%E7%AB%AF/Go/%E6%A1%86%E6%9E%B6/Beego/" data-id="clrj8k01g005z4wuwe8lp752o" data-title="" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-Note/后端/Go/基础/Go库" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2024/01/18/Note/%E5%90%8E%E7%AB%AF/Go/%E5%9F%BA%E7%A1%80/Go%E5%BA%93/" class="article-date">
  <time class="dt-published" datetime="2024-01-18T13:12:24.670Z" itemprop="datePublished">2024-01-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="基础库"><a href="#基础库" class="headerlink" title="基础库"></a>基础库</h2><table>
<thead>
<tr>
<th>函数名</th>
<th>作用</th>
<th>参数</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>Scanf</td>
<td>接收键盘输入</td>
<td>格式符, &amp;变量</td>
<td></td>
</tr>
<tr>
<td>Scan</td>
<td>接收键盘输入</td>
<td>&amp;变量</td>
<td></td>
</tr>
<tr>
<td>len</td>
<td>获取对象的长度</td>
<td>对象</td>
<td></td>
</tr>
<tr>
<td>cap</td>
<td>获取切片容量</td>
<td>切片对象</td>
<td></td>
</tr>
<tr>
<td>append</td>
<td>切片末尾追加数据</td>
<td>切片对象</td>
<td>切片空间不足会扩容</td>
</tr>
<tr>
<td>make</td>
<td>创建一个数据类型</td>
<td></td>
<td></td>
</tr>
<tr>
<td>copy</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>range</td>
<td>遍历数组对象</td>
<td></td>
<td>遍历中的修改是深拷贝</td>
</tr>
<tr>
<td>panic</td>
<td>抛出异常，终止程序</td>
<td></td>
<td>程序出现异常内部会调用</td>
</tr>
<tr>
<td>recover</td>
<td>捕获panic抛出的异常</td>
<td></td>
<td>只在defer调用的函数中有效</td>
</tr>
<tr>
<td>数据类型()</td>
<td>强制转换为对应的数据类型</td>
<td></td>
<td></td>
</tr>
</tbody></table>
<h2 id="Goroutine"><a href="#Goroutine" class="headerlink" title="Goroutine"></a>Goroutine</h2><table>
<thead>
<tr>
<th>函数名</th>
<th>作用</th>
<th>参数</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>Gosched</td>
<td>用于让出CPU时间片</td>
<td></td>
<td></td>
</tr>
<tr>
<td>Goexit</td>
<td>立即终止当前go协程</td>
<td></td>
<td></td>
</tr>
<tr>
<td>Gomaxprocs</td>
<td>设置cpu核数</td>
<td></td>
<td>返回值为修改前核心数</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody></table>
<h2 id="Channel"><a href="#Channel" class="headerlink" title="Channel"></a>Channel</h2>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2024/01/18/Note/%E5%90%8E%E7%AB%AF/Go/%E5%9F%BA%E7%A1%80/Go%E5%BA%93/" data-id="clrj8k01h00634wuwer8t5gz8" data-title="" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-Note/后端/Go/基础/GO" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2024/01/18/Note/%E5%90%8E%E7%AB%AF/Go/%E5%9F%BA%E7%A1%80/GO/" class="article-date">
  <time class="dt-published" datetime="2024-01-18T13:12:24.669Z" itemprop="datePublished">2024-01-18</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Go/">Go</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2024/01/18/Note/%E5%90%8E%E7%AB%AF/Go/%E5%9F%BA%E7%A1%80/GO/">Go</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><ul>
<li>速度快，易学，支持高并发</li>
<li>适合网络编程、区块链开发</li>
<li>类c语言</li>
<li>成员属性和方法如果是大写开头就是public的，小写开头的就是private的</li>
</ul>
<h2 id="命令"><a href="#命令" class="headerlink" title="命令"></a>命令</h2><table>
<thead>
<tr>
<th>命令</th>
<th>功能</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>build</td>
<td>编译包和依赖</td>
<td></td>
</tr>
<tr>
<td>run</td>
<td>编译并运行</td>
<td></td>
</tr>
<tr>
<td>clean</td>
<td>移除当前源码包和关联源码包里面编译生成的文件</td>
<td></td>
</tr>
<tr>
<td>env</td>
<td>打印Go的环境信息</td>
<td></td>
</tr>
<tr>
<td>fix</td>
<td>将旧的API替换成新的API</td>
<td></td>
</tr>
<tr>
<td>mod</td>
<td>模块维护</td>
<td></td>
</tr>
<tr>
<td>get</td>
<td>将依赖项添加到当前模块并安装它们</td>
<td></td>
</tr>
</tbody></table>
<h2 id="基本数据类型"><a href="#基本数据类型" class="headerlink" title="基本数据类型"></a>基本数据类型</h2><table>
<thead>
<tr>
<th>类型</th>
<th>默认值</th>
<th>字节</th>
<th>格式符</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>byte</td>
<td></td>
<td>1</td>
<td>%c</td>
<td>单个字符</td>
</tr>
<tr>
<td>string</td>
<td></td>
<td></td>
<td>%s</td>
<td>\0结束，中文3字符，不可变</td>
</tr>
<tr>
<td>bool</td>
<td>false</td>
<td></td>
<td>%t</td>
<td></td>
</tr>
<tr>
<td>int</td>
<td>0</td>
<td>8</td>
<td>%d</td>
<td>有符号</td>
</tr>
<tr>
<td>uint</td>
<td></td>
<td>8</td>
<td></td>
<td>无符号</td>
</tr>
<tr>
<td>float32</td>
<td></td>
<td></td>
<td>%f</td>
<td>小数点后7</td>
</tr>
<tr>
<td>float64</td>
<td></td>
<td></td>
<td>%f</td>
<td>小数点后15，常用</td>
</tr>
<tr>
<td>double</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>complex64</td>
<td></td>
<td></td>
<td>%v</td>
<td>复数，64 位实数+64 位虚数</td>
</tr>
<tr>
<td>complex128</td>
<td></td>
<td></td>
<td>%v</td>
<td>64 位实数+64 位虚数</td>
</tr>
<tr>
<td>地址值</td>
<td>十六进制</td>
<td></td>
<td>%p</td>
<td></td>
</tr>
<tr>
<td>类型</td>
<td></td>
<td></td>
<td>%T</td>
<td></td>
</tr>
</tbody></table>
<h2 id="复合数据类型"><a href="#复合数据类型" class="headerlink" title="复合数据类型"></a>复合数据类型</h2><p><strong>切片</strong></p>
<ul>
<li><p>截取集合中的一部分数据</p>
</li>
<li><p>结构</p>
<ul>
<li>一个指针，指向数组中 slice 指定的开始位置</li>
<li>长度，即 slice 的长度</li>
<li>最大长度，也就是 slice 开始位置到数组的最后位置的长度</li>
</ul>
</li>
<li><p>内置函数</p>
<ul>
<li><p>len：获取长度</p>
</li>
<li><p>cap：获取最大容量</p>
</li>
<li><p>append：</p>
<ul>
<li>追加一个或者多个元素，然后返回一个和 slice 一样类型的slice</li>
<li>追加元素会影响到原数组和其他指向该数组的切片</li>
<li>当追加元素超过切片最大长度时会创建一个新的数组空间，不会影响到其他</li>
</ul>
</li>
<li><p>copy：copy 从源 slice 的 src 中复制元素到目标 dst，并且返回复制的元素的个数</p>
</li>
</ul>
</li>
</ul>
<p><strong>数组</strong></p>
<ul>
<li>函数传递数组是深拷贝，函数传切边是浅拷贝</li>
<li>切边截取是浅拷贝</li>
<li>切边扩容x2，大于1024字节后x 1&#x2F;4</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//定义</span></span><br><span class="line"><span class="keyword">var</span> 数组名 [元素数量]类型</span><br><span class="line"></span><br><span class="line"><span class="comment">//自动推导,数量可以省略用...替代</span></span><br><span class="line">数组名 := [数量]类型&#123;对应的值&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//嵌套数组</span></span><br><span class="line">数组名 := [<span class="number">2</span>][<span class="number">4</span>]<span class="type">int</span>&#123;</span><br><span class="line">    [<span class="number">4</span>]<span class="type">int</span>&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>&#125;, </span><br><span class="line">    [<span class="number">4</span>]<span class="type">int</span>&#123;<span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//可省略，需要数组类型一致</span></span><br><span class="line">数组名 := [<span class="number">2</span>][<span class="number">4</span>]<span class="type">int</span>&#123;</span><br><span class="line">    &#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>&#125;, </span><br><span class="line">    &#123;<span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//初始化</span></span><br><span class="line"><span class="keyword">var</span> 数组名[元素数量] 类型 = [数量]类型&#123;对应的值&#125;</span><br><span class="line"><span class="keyword">var</span> 数组名[元素数量] 类型 = [数量]类型&#123;下标:对应的值&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//切片创建</span></span><br><span class="line"><span class="comment">//1</span></span><br><span class="line"><span class="keyword">var</span> 切片名 []类型</span><br><span class="line"><span class="comment">//2，自动推导</span></span><br><span class="line">切片名 := []类型&#123;&#125;</span><br><span class="line"><span class="comment">//3,长度是初始化长度，容量是最大长度</span></span><br><span class="line"><span class="built_in">make</span>([]类型,长度,容量)</span><br><span class="line"><span class="comment">//4，获取数组切片</span></span><br><span class="line">切片名 = 数组名[开始下标:结束下标]</span><br></pre></td></tr></table></figure>

<p><strong>map</strong></p>
<ul>
<li>无序，kv存储</li>
<li>k不重复</li>
<li>函数中是浅拷贝</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//创建 &amp; 初始化 </span></span><br><span class="line"><span class="keyword">var</span> <span class="keyword">map</span>名 <span class="keyword">map</span>(key类型)value类型 = <span class="keyword">map</span>[key类型]value类型&#123;k:v&#125;</span><br><span class="line"><span class="keyword">map</span>名 := <span class="keyword">map</span>(key类型)value类型&#123;k:v&#125;</span><br><span class="line"><span class="keyword">map</span>名 := <span class="built_in">make</span>(<span class="keyword">map</span>(key类型)value类型)</span><br><span class="line"><span class="keyword">map</span>名[k] = v</span><br><span class="line"></span><br><span class="line"><span class="comment">//判断value是否存在, 如果值存在</span></span><br><span class="line">a, b = <span class="keyword">map</span>名[k]</span><br></pre></td></tr></table></figure>

<p><strong>结构体</strong></p>
<ul>
<li>函数传递结构体是深拷贝，函数传递切片是浅拷贝</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//创建</span></span><br><span class="line"><span class="keyword">type</span> 结构体名 <span class="keyword">struct</span>&#123;</span><br><span class="line">    成员变量 类型 <span class="string">`标签:值`</span></span><br><span class="line">    <span class="comment">//如果需要序列化</span></span><br><span class="line">    成员变量 类型 <span class="string">`json:成员变量名`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//切片</span></span><br><span class="line"><span class="keyword">var</span> 切片名[] 类型</span><br><span class="line"></span><br><span class="line"><span class="comment">//转json</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;encoding/json&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//结构体转json</span></span><br><span class="line">hsonStr, err := json.Marshal(结构体)</span><br><span class="line"><span class="comment">//json转结构体</span></span><br><span class="line">err = json.Unmarshal(json, 结构体对象)</span><br></pre></td></tr></table></figure>

<p><strong>指针</strong></p>
<ul>
<li>数组指针取值时应该 <code>(*p)[下标]</code>， 因为括号的优先级高<ul>
<li>Go优化成了：<code>p[下标]</code></li>
</ul>
</li>
<li>指针数组取值时应该 <code>*p[下标]</code> </li>
<li>多级指针</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//创建普通指针</span></span><br><span class="line"><span class="keyword">var</span> 指针名 *类型 =  &amp;对象</span><br><span class="line"><span class="comment">//数组指针</span></span><br><span class="line"><span class="keyword">var</span> 指针名 *[数量]类型 = &amp;数组</span><br><span class="line"><span class="comment">//指针数组</span></span><br><span class="line"><span class="keyword">var</span> 指针名 [数量]*类型</span><br><span class="line"></span><br><span class="line"><span class="comment">//切片</span></span><br><span class="line"><span class="keyword">var</span> 指针名 *[]类型</span><br></pre></td></tr></table></figure>

<p><strong>channel</strong></p>
<ul>
<li><p>解决协程之间的同步问题</p>
</li>
<li><p>没有设置容量的channel为无缓冲channel</p>
<ul>
<li>需要同时读写，会阻塞，适合同步任务</li>
</ul>
</li>
<li><p>有缓冲channel适合异步任务</p>
</li>
<li><p>channel关闭后不能写数据，但是可以读数据</p>
</li>
<li><p>创建时默认是双向channel，可以设置单向channel</p>
<ul>
<li>双向channel可以转换为任意单向channel，反之不行</li>
</ul>
</li>
<li><p>有一个定时器的类</p>
</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//创建双向channel</span></span><br><span class="line"><span class="keyword">var</span> ch <span class="keyword">chan</span> channel中数据的类型</span><br><span class="line">ch := <span class="built_in">make</span>(<span class="keyword">chan</span> channel中数据的类型，容量)</span><br><span class="line"><span class="comment">//单向写channel</span></span><br><span class="line"><span class="keyword">var</span> ch <span class="keyword">chan</span> &lt;- channel中数据的类型</span><br><span class="line">ch := <span class="built_in">make</span>(<span class="keyword">chan</span> &lt;- channel中数据的类型，容量)</span><br><span class="line"><span class="comment">//单向读channel</span></span><br><span class="line"><span class="keyword">var</span> ch &lt;- <span class="keyword">chan</span> channel中数据的类型</span><br><span class="line">ch := <span class="built_in">make</span>(&lt;- <span class="keyword">chan</span> channel中数据的类型，容量)</span><br><span class="line"></span><br><span class="line"><span class="comment">//写入</span></span><br><span class="line">ch &lt;-</span><br><span class="line"><span class="comment">//读取</span></span><br><span class="line">s &lt;- ch</span><br><span class="line"></span><br><span class="line"><span class="comment">//关闭</span></span><br><span class="line"><span class="built_in">close</span>(ch)</span><br></pre></td></tr></table></figure>

<h2 id="常量-变量"><a href="#常量-变量" class="headerlink" title="常量 &#x2F; 变量"></a>常量 &#x2F; 变量</h2><ul>
<li><p>常量格式</p>
<ul>
<li>const 名称  【类型】&#x3D; 值</li>
</ul>
</li>
<li><p>变量格式</p>
<ul>
<li>var 名称 类型 【 &#x3D; 值】</li>
<li>var 名称1，名称2，名称3  类型 【 &#x3D; 值1，值2，值3】</li>
<li>名称 :&#x3D; 值 （简短声明 &#x2F; 自动推导）（只能用在函数中）</li>
</ul>
</li>
<li><p>_（下划线）是个特殊的内置变量，任何赋予它的值都会被丢弃</p>
</li>
<li><p>以声明未使用的值会在编译阶段报错</p>
</li>
<li><p>字符串不可变，怎么修改</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//1转为字节数组 []byte(c)</span></span><br><span class="line">s := <span class="string">&quot;hello&quot;</span></span><br><span class="line">c := []<span class="type">byte</span>(s) </span><br><span class="line">c[<span class="number">0</span>] = <span class="string">&#x27;c&#x27;</span></span><br><span class="line">s2 := <span class="type">string</span>(c) <span class="comment">// 再转换回 string 类型</span></span><br><span class="line">fmt.Printf(<span class="string">&quot;%s\n&quot;</span>, s2)</span><br><span class="line"></span><br><span class="line"><span class="comment">//2用切片拼接</span></span><br><span class="line">s := <span class="string">&quot;hello&quot;</span></span><br><span class="line">s = <span class="string">&quot;c&quot;</span> + s[<span class="number">1</span>:] <span class="comment">// 字符串虽不能更改，但可进行切片操作</span></span><br><span class="line">fmt.Printf(<span class="string">&quot;%s\n&quot;</span>, s)</span><br></pre></td></tr></table></figure>
</li>
<li><p>如果想输出多行的字符串，需要使用 &#96; 括起来</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">str := <span class="string">`abc</span></span><br><span class="line"><span class="string">		def`</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>大写字母开头的变量&#x2F;函数，是可导出的，其它包可以读取，小写字母开头的则不行</p>
</li>
</ul>
<h2 id="函数-方法"><a href="#函数-方法" class="headerlink" title="函数 &#x2F; 方法"></a>函数 &#x2F; 方法</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//定义</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">method</span><span class="params">(参数 类型)</span></span>(返回值<span class="number">1</span> 返回值类型, ...)&#123;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//使用，多个返回值</span></span><br><span class="line">a, b = method();</span><br></pre></td></tr></table></figure>

<ul>
<li>如果方法是公共的，返回值最好命名</li>
<li>函数也是一种变量，可以通过type来定义它，可以用作参数进行传递</li>
</ul>
<h2 id="关键字"><a href="#关键字" class="headerlink" title="关键字"></a>关键字</h2><ul>
<li><p><strong>defer</strong></p>
<ul>
<li>相当于java中的final，c中的析构，即函数结束前执行的操作</li>
<li>执行顺序是后进先出，栈式执行，逆序执行，先执行最下面的</li>
<li>return比defer先执行</li>
</ul>
</li>
<li><p>select</p>
<ul>
<li>监听channel上的数据流动</li>
<li>语法类似switch</li>
<li>多个满足条件的随机执行一个</li>
<li>如果一直走到default会导致忙轮询，不建议使用default</li>
</ul>
</li>
<li><p>iota</p>
<ul>
<li>自动枚举，默认值为0，调用一次加1</li>
<li>每遇到一个 const 关键字，iota 就会重置</li>
</ul>
</li>
<li><p>fallthrough</p>
<ul>
<li>在switch中使用，强制执行满足条件之后的所有条件，包括default</li>
</ul>
</li>
</ul>
<h2 id="面向对象"><a href="#面向对象" class="headerlink" title="面向对象"></a>面向对象</h2><ul>
<li><p>封装</p>
<ul>
<li>定义结构体时的this最好指向对象的地址，这样是浅拷贝</li>
</ul>
</li>
<li><p>继承</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> 子类 <span class="keyword">struct</span>&#123;</span><br><span class="line">    父类</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>多态</p>
<ul>
<li>父类指针指向子类对象</li>
</ul>
</li>
</ul>
<h2 id="接口"><a href="#接口" class="headerlink" title="接口"></a>接口</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//接口定义</span></span><br><span class="line"><span class="keyword">type</span> 接口名 <span class="keyword">interface</span>&#123;</span><br><span class="line">    方法名() 【返回值类型】</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//接口实现</span></span><br><span class="line"><span class="keyword">type</span> 实现 <span class="keyword">struct</span>&#123;</span><br><span class="line">    成员变量</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(this &amp;实现)</span></span> 接口方法名 【返回值类型】&#123;</span><br><span class="line">	实现方法</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//万能接口，可接收任意类型</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">method</span><span class="params">(arg <span class="keyword">interface</span>&#123;&#125;)</span></span>&#123;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//万能接口提供了类型断言</span></span><br><span class="line">value, ok := arg.(<span class="type">string</span>) <span class="comment">//判断arg是否是字符串</span></span><br></pre></td></tr></table></figure>

<h2 id="反射"><a href="#反射" class="headerlink" title="反射"></a>反射</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//获取对象的type</span></span><br><span class="line">reflect.TypeOf(对象)</span><br><span class="line"><span class="comment">//获取对象的value</span></span><br><span class="line">reflect.ValueOf(对象)</span><br><span class="line"><span class="comment">//获取对象中的成员的标签</span></span><br><span class="line">t := reflect.TypeOf(对象).Elem()</span><br><span class="line">tagIt.Field(下标).Tag.Get(<span class="string">&quot;标签名&quot;</span>)</span><br></pre></td></tr></table></figure>

<h2 id="异常"><a href="#异常" class="headerlink" title="异常"></a>异常</h2><ul>
<li>实际发生异常时系统内部是通过panic函数去抛出这个异常，尽量少用</li>
<li>可以使用errors中的方法对异常进行处理</li>
<li>延迟函数defer会正常执行</li>
</ul>
<h2 id="文本处理"><a href="#文本处理" class="headerlink" title="文本处理"></a>文本处理</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//创建文件</span></span><br><span class="line">file, err := os.Create(<span class="string">&quot;路径&quot;</span>)</span><br><span class="line"></span><br><span class="line">str = <span class="string">&quot;内容&quot;</span></span><br><span class="line"><span class="comment">//写入文件1</span></span><br><span class="line">length, err := file.WriteString(str)</span><br><span class="line"><span class="comment">//写入文件2，接收字节数组</span></span><br><span class="line">length, err := file.Write([]<span class="type">byte</span>(str))</span><br><span class="line"><span class="comment">//写入文件3，写入指定位置，会覆盖数据，</span></span><br><span class="line">length, err := file.WriteAt([]<span class="type">byte</span>(str), 下标)</span><br><span class="line"></span><br><span class="line"><span class="comment">//定位文件内容下标</span></span><br><span class="line">length, err := file.Seek(追加空格数，io.SeekEnd)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//读取文件1</span></span><br><span class="line">file, err := os.OpenFile(<span class="string">&quot;路径&quot;</span>， 模式， 权限[<span class="number">0</span><span class="number">-7</span>])</span><br><span class="line"><span class="comment">//读取文件2，只读，无权限</span></span><br><span class="line">file, err := os.Open(<span class="string">&quot;路径&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">//读取文件内容，buffer为读取缓冲区，空余区域会用0填充</span></span><br><span class="line"><span class="comment">//buffer存储的A</span></span><br><span class="line">buffer := <span class="built_in">make</span>([]<span class="type">byte</span>, <span class="number">1024</span> * <span class="number">2</span>)</span><br><span class="line">length, err := file。Read(buffer)</span><br><span class="line"></span><br><span class="line"><span class="comment">//关闭文件</span></span><br><span class="line"><span class="keyword">defer</span> file.<span class="built_in">close</span></span><br></pre></td></tr></table></figure>

<h2 id="协程-gorountine"><a href="#协程-gorountine" class="headerlink" title="协程 gorountine"></a>协程 gorountine</h2><ul>
<li><p>提高CPU的利用率</p>
</li>
<li><p>主要是gorountine和channel</p>
</li>
<li><p>内存占用几kb</p>
</li>
<li><p>早期的调度器需要获取锁才能执行go协程，性能比较差</p>
</li>
<li><p>调度器设计策略</p>
<ul>
<li>复用线程</li>
<li>利用并行</li>
<li>抢占</li>
<li>全局G队列</li>
</ul>
</li>
</ul>
<h2 id="GMP"><a href="#GMP" class="headerlink" title="GMP"></a>GMP</h2><h2 id="Go调用以太坊"><a href="#Go调用以太坊" class="headerlink" title="Go调用以太坊"></a>Go调用以太坊</h2><ul>
<li><p>启动rpc端口</p>
<ul>
<li><code>geth --identity &quot;XZ&quot; --http --http.port 8545 --datadir &quot;C:\Go\test2\testBlock&quot; --http.api &quot;net,eth,personal,db,web3&quot; --http.corsdomain &quot;*&quot; console</code><ul>
<li>identity：节点身份标识</li>
<li>http：开启rpc</li>
<li>http.port ：rpc端口</li>
<li>http.api：对外提供的api</li>
<li>http.corsdomain：允许连接的url，*无限制，默认只有本机能访问</li>
<li>datadir：区块数据文件夹</li>
<li>networkid：net_version的id，即网络类型<ul>
<li>1是主网络，其余是测试网络</li>
</ul>
</li>
<li>port：监听其他端口</li>
<li>nodiscover：隐藏节点，需手动添加</li>
</ul>
</li>
</ul>
</li>
<li><p>在区块数据文件夹下创建Go工程</p>
</li>
<li><p>导入以太坊相关api</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//获取连接Client</span></span><br><span class="line"><span class="keyword">var</span> client Client</span><br><span class="line">client = rpc.Dial(<span class="string">&quot;ip：端口&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//获取网络类型networkid</span></span><br><span class="line"><span class="keyword">var</span> networkid <span class="type">string</span></span><br><span class="line">client.Call(&amp;networkid, <span class="string">&quot;net_version&quot;</span>)</span><br><span class="line"><span class="comment">//获取是否监听</span></span><br><span class="line"><span class="keyword">var</span> is_listing <span class="type">bool</span></span><br><span class="line">client.Call(&amp;is_listing, <span class="string">&quot;net_listening&quot;</span>)</span><br><span class="line"><span class="comment">//获取节点数量</span></span><br><span class="line"><span class="keyword">var</span> count <span class="type">string</span></span><br><span class="line">client.Call(&amp;count, <span class="string">&quot;net_peerCount&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">//获取账户</span></span><br><span class="line"><span class="keyword">var</span> account []<span class="type">string</span></span><br><span class="line">client.Call(&amp;account, <span class="string">&quot;eth_accounts&quot;</span>)</span><br><span class="line"><span class="comment">//获取账户余额</span></span><br><span class="line"><span class="keyword">var</span> balance <span class="type">string</span></span><br><span class="line">client.Call(&amp;balance, <span class="string">&quot;eth_getBalance&quot;</span>, 账户地址，区块编号(latest、))</span><br><span class="line"><span class="comment">//获取当前gas价格</span></span><br><span class="line"><span class="keyword">var</span> gas <span class="type">string</span></span><br><span class="line">client.Call(&amp;gas, <span class="string">&quot;eth_gasPrice&quot;</span>)</span><br><span class="line"><span class="comment">//获取挖矿地址账户</span></span><br><span class="line"><span class="keyword">var</span> coinbase <span class="type">string</span></span><br><span class="line">client.Call(&amp;coinbase, <span class="string">&quot;eth_coinbase&quot;</span>)</span><br><span class="line"><span class="comment">//获取当前以太坊协议版本</span></span><br><span class="line"><span class="keyword">var</span> protocolVersion <span class="type">string</span></span><br><span class="line">client.Call(&amp;protocolVersion, <span class="string">&quot;eth_protocolVersion&quot;</span>)</span><br><span class="line"><span class="comment">//获取当前是否在挖矿</span></span><br><span class="line"><span class="keyword">var</span> isMining <span class="type">bool</span></span><br><span class="line">client.Call(&amp;isMining, <span class="string">&quot;eth_mining&quot;</span>)</span><br><span class="line"><span class="comment">//获取挖矿速率</span></span><br><span class="line"><span class="keyword">var</span> hashrate <span class="type">string</span></span><br><span class="line">client.Call(&amp;hashrate, <span class="string">&quot;eth_hashrate&quot;</span>)</span><br><span class="line"><span class="comment">//获取指定地址发生的交易数量</span></span><br><span class="line"><span class="keyword">var</span> transactionCount <span class="type">string</span></span><br><span class="line">client.Call(&amp;transactionCount, <span class="string">&quot;eth_getTransactionCount&quot;</span>, <span class="string">&quot;地址&quot;</span>，区块编号(latest、))</span><br><span class="line"><span class="comment">//获取节点当前块编号</span></span><br><span class="line"><span class="keyword">var</span> blockNum <span class="type">string</span></span><br><span class="line">client.Call(&amp;blockNum, <span class="string">&quot;eth_blockNumber&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">//创建账户</span></span><br><span class="line"><span class="keyword">var</span> account <span class="type">string</span> </span><br><span class="line"><span class="keyword">var</span> pwd <span class="type">string</span> <span class="comment">// 参数</span></span><br><span class="line">client.Call(&amp;account, <span class="string">&quot;personal_newAccount&quot;</span>, pwd)</span><br><span class="line"><span class="comment">//获取账户列表</span></span><br><span class="line"><span class="keyword">var</span> accounts []<span class="type">string</span> </span><br><span class="line">client.Call(&amp;accounts, <span class="string">&quot;personal_listAccounts&quot;</span>)</span><br><span class="line"><span class="comment">//锁定指定账户</span></span><br><span class="line"><span class="keyword">var</span> lock <span class="type">bool</span></span><br><span class="line">client.Call(&amp;lock, <span class="string">&quot;personal_lockAccount&quot;</span>, <span class="string">&quot;地址&quot;</span>)</span><br><span class="line"><span class="comment">//解锁指定账户</span></span><br><span class="line"><span class="keyword">var</span> lock <span class="type">bool</span></span><br><span class="line">client.Call(&amp;lock, <span class="string">&quot;personal_unlockAccount&quot;</span>, <span class="string">&quot;地址&quot;</span>, <span class="string">&quot;密码&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">//写入数据库</span></span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="Go调用智能合约"><a href="#Go调用智能合约" class="headerlink" title="Go调用智能合约"></a>Go调用智能合约</h2><ol>
<li>通过remix部署合约获取abi信息，新建一个abi后缀名的文件<ul>
<li>或者通过工具solc生成<ul>
<li><code>solc -bin test.sol -o test.abi</code></li>
</ul>
</li>
</ul>
</li>
<li>使用abigen工具，根据abi文件生成对应的go文件<ul>
<li><code>abigen --abi abi文件 --pkg 包名 --type 结构体名 --out 文件名.go</code></li>
</ul>
</li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2024/01/18/Note/%E5%90%8E%E7%AB%AF/Go/%E5%9F%BA%E7%A1%80/GO/" data-id="clrj8k01g00614wuw1ouh9beq" data-title="Go" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/go/" rel="tag">go</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/language/" rel="tag">language</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-Note/区块链开发/源码/比特币" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2024/01/18/Note/%E5%8C%BA%E5%9D%97%E9%93%BE%E5%BC%80%E5%8F%91/%E6%BA%90%E7%A0%81/%E6%AF%94%E7%89%B9%E5%B8%81/" class="article-date">
  <time class="dt-published" datetime="2024-01-18T13:12:24.665Z" itemprop="datePublished">2024-01-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        
      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2024/01/18/Note/%E5%8C%BA%E5%9D%97%E9%93%BE%E5%BC%80%E5%8F%91/%E6%BA%90%E7%A0%81/%E6%AF%94%E7%89%B9%E5%B8%81/" data-id="clrj8k01d005f4wuwazve4gn8" data-title="" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-Note/区块链开发/源码/以太坊" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2024/01/18/Note/%E5%8C%BA%E5%9D%97%E9%93%BE%E5%BC%80%E5%8F%91/%E6%BA%90%E7%A0%81/%E4%BB%A5%E5%A4%AA%E5%9D%8A/" class="article-date">
  <time class="dt-published" datetime="2024-01-18T13:12:24.664Z" itemprop="datePublished">2024-01-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="目录结构"><a href="#目录结构" class="headerlink" title="目录结构"></a>目录结构</h2><h2 id="结构"><a href="#结构" class="headerlink" title="结构"></a>结构</h2><h3 id="块头"><a href="#块头" class="headerlink" title="块头"></a>块头</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Header <span class="keyword">struct</span>&#123;</span><br><span class="line">    ParentHash		common.Hash			<span class="comment">//父区块的hash值</span></span><br><span class="line">    UncleHash		common.Hash			<span class="comment">//父区块fen&#x27;cha区块的hash值</span></span><br><span class="line">    Coinbase		common.address		<span class="comment">//挖出区块的矿工的地址</span></span><br><span class="line">    Root			common.Hash			<span class="comment">//状态树根节点hash值</span></span><br><span class="line">    TxHash			common.Hash			<span class="comment">//交易树根节点hash值</span></span><br><span class="line">    ReceiptHash		common.Hash			<span class="comment">//收据树根节点hash值</span></span><br><span class="line">    Bloom			Bloom				<span class="comment">//布隆过滤器，配合收据树使用</span></span><br><span class="line">    Difficulty		*big.Int			<span class="comment">//挖矿难度</span></span><br><span class="line">    Number			*big.Int			<span class="comment">//</span></span><br><span class="line">    GasLimit		<span class="type">uint64</span>				<span class="comment">//区块能消耗的汽油费的上限，可微调1024分之1</span></span><br><span class="line">    GasUsed			<span class="type">uint64</span>				<span class="comment">//区块汽油费总和	</span></span><br><span class="line">    Time			*big.Int			<span class="comment">//区块产生时间</span></span><br><span class="line">    Extra			[]<span class="type">byte</span>				<span class="comment">//</span></span><br><span class="line">    MixDigest		common.Hash			<span class="comment">//</span></span><br><span class="line">    Nonce			BlockNonce			<span class="comment">//挖矿随机值，符合难度要求的</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="交易"><a href="#交易" class="headerlink" title="交易"></a>交易</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> txdata <span class="keyword">struct</span> &#123;</span><br><span class="line">    AccountNonce 	<span class="type">uint64</span>				<span class="comment">//交易序号</span></span><br><span class="line">    Price 			*big.Int			<span class="comment">//单位汽油费</span></span><br><span class="line">    GasLimit 		<span class="type">uint64</span>				<span class="comment">//最大汽油费</span></span><br><span class="line">    Recipient 		*common.Address		<span class="comment">//收款人地址</span></span><br><span class="line">    Amount 			*big.Int			<span class="comment">//转账金额</span></span><br><span class="line">    Payload 		[]<span class="type">byte</span>				<span class="comment">//data域，存放的是调用的合约的哪一个函数</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="统一的树结构"><a href="#统一的树结构" class="headerlink" title="统一的树结构"></a>统一的树结构</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//MPT树结构</span></span><br><span class="line"><span class="keyword">type</span> Trie <span class="keyword">struct</span>&#123;</span><br><span class="line">    db				*Database</span><br><span class="line">    root			node</span><br><span class="line">    originalRoot	common.Hash</span><br><span class="line">    cachegen, 		cachelimit <span class="type">uint16</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="交易树"><a href="#交易树" class="headerlink" title="交易树"></a>交易树</h3><h3 id="收据树"><a href="#收据树" class="headerlink" title="收据树"></a>收据树</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//收据树结构</span></span><br><span class="line"><span class="keyword">type</span> Recipt <span class="keyword">struct</span>&#123;</span><br><span class="line">    PostState			[]<span class="type">byte</span></span><br><span class="line">    Status				<span class="type">uint64</span>			<span class="comment">//jiao&#x27;yi</span></span><br><span class="line">    CumulativeGasUsed	<span class="type">uint64</span>			</span><br><span class="line">    Bloom				Bloom			<span class="comment">//布隆过滤器，根据log生成，多个收据多个Bloom合并</span></span><br><span class="line">    Logs				[]*Log</span><br><span class="line">    TxHash				common.Hash</span><br><span class="line">    ContractAddress		common.Address</span><br><span class="line">    GasUsed				<span class="type">uint64</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="账户"><a href="#账户" class="headerlink" title="账户"></a>账户</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> </span><br></pre></td></tr></table></figure>

<h2 id="文件"><a href="#文件" class="headerlink" title="文件"></a>文件</h2><h3 id="block-go"><a href="#block-go" class="headerlink" title="block.go"></a>block.go</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//2018版ETH-创建区块</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewBlock</span><span class="params">(header *Header, txs []*Transaction, uncle []*Header, receipts []*Receipt)</span></span> *Block&#123;</span><br><span class="line">    b := &amp;Block&#123;</span><br><span class="line">        header: CopyHeader(header),</span><br><span class="line">        td: <span class="built_in">new</span>(big.Int)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//判断交易列表是否为空</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(txs) == <span class="number">0</span>&#123;</span><br><span class="line">		<span class="comment">//为空则交易树的根hash值为空hash值</span></span><br><span class="line">        b.header.TxHash = EmptyRootHash</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="comment">//不为空则调用DeriveSha获取交易树的根hash值并设置</span></span><br><span class="line">        b.header.TxHash = DeriveSha(Transactions(txs))</span><br><span class="line">        b.transactions = <span class="built_in">make</span>(Transactions, <span class="built_in">len</span>(txs))</span><br><span class="line">        <span class="built_in">copy</span>(b.transactions, txs)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//判断收据列表是否为空</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(receipts) == <span class="number">0</span>&#123;</span><br><span class="line">		<span class="comment">//为空则收据树的根hash值为空hash值</span></span><br><span class="line">        b.header.ReceiptHash = EmptyRootHash</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="comment">//不为空则调用DeriveSha获取交易树的根hash值并设置</span></span><br><span class="line">        b.header.ReceiptHash = DeriveSha(Receipts(txs))</span><br><span class="line">        <span class="comment">//创建布隆过滤器</span></span><br><span class="line">        b.header.Bloom = CreateBloom(receipts)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//判断叔父区块是否为空</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(uncle) == <span class="number">0</span>&#123;</span><br><span class="line">        <span class="comment">//为空则叔父区块的hash值为空hash值</span></span><br><span class="line">        b.header.UncleHash = EmptyUncleHash</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="comment">//不为空则调用 CalcUncleHash 计算出叔父区块的hash</span></span><br><span class="line">        b.header.UncleHash = CalcUncleHash(uncles)</span><br><span class="line">        <span class="comment">//构建叔父区块的数组</span></span><br><span class="line">        b.uncles = <span class="built_in">make</span>([]*Header, <span class="built_in">len</span>(uncles))</span><br><span class="line">        <span class="keyword">for</span> i := <span class="keyword">range</span> uncles &#123;</span><br><span class="line">            b.uncles[i] = CopyHeader(uncles[i])</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//获取列表Hash值</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">DeriveSha</span><span class="params">(list DerivableList)</span></span> common.Hash &#123;</span><br><span class="line">    keybuf := <span class="built_in">new</span>(<span class="type">byte</span>.Buffer)</span><br><span class="line">    trie := <span class="built_in">new</span>(trie.Trie)</span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; list.Len(); i++ &#123;</span><br><span class="line">        keybuf.Reset()</span><br><span class="line">        rlp.Encode(keybuf, <span class="type">uint</span>(i))</span><br><span class="line">        trie.Update(keybuf.Bytes(), list.GetRlp(i))</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> trie.Hash()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="函数"><a href="#函数" class="headerlink" title="函数"></a>函数</h2><h3 id="布隆过滤器"><a href="#布隆过滤器" class="headerlink" title="布隆过滤器"></a>布隆过滤器</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//创建布隆过滤器</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">CreateBloom</span><span class="params">(receipts Receipts)</span></span> Bloom&#123;</span><br><span class="line">    bin := <span class="built_in">new</span>(big.Int)</span><br><span class="line">    <span class="comment">//将多个收据的bloom合并</span></span><br><span class="line">    <span class="keyword">for</span> _, receipt := <span class="keyword">range</span> receipts&#123;</span><br><span class="line">        bin.Or(bin, LogsBloom(receipt.Logs))</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> BytesToBloom(bin.Bytes())</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//生成每个收据的bloom </span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">LogsBloom</span><span class="params">(logs []*Log)</span></span> *big.Int&#123;</span><br><span class="line">    bin := <span class="built_in">new</span>(big.Int)</span><br><span class="line">    <span class="comment">//根据log生成bloom</span></span><br><span class="line">    <span class="keyword">for</span> _, log := <span class="keyword">range</span> logs&#123;</span><br><span class="line">        <span class="comment">//将每个log的地址取hash后加入bloom</span></span><br><span class="line">        bin.Or(bin, bloom9(log.Address.Bytes()))</span><br><span class="line">        <span class="keyword">for</span> _, b := <span class="keyword">range</span> log.Topics&#123;</span><br><span class="line">            <span class="comment">//将每个log的topic取hash后加入bloom</span></span><br><span class="line">            bin.Or(bin, bloom9(b[:]))</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//bloom中使用的hash函数</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">bloom9</span><span class="params">(b []<span class="type">byte</span>)</span></span> *big.Int&#123;</span><br><span class="line">    <span class="comment">//生成一个256位32字节的hash值</span></span><br><span class="line">    b = crypto.Keccak256(b[:])</span><br><span class="line">    <span class="comment">//要返回的bloom</span></span><br><span class="line">    r := <span class="built_in">new</span>(big.Int)</span><br><span class="line">    <span class="comment">//对生成的32字节的hash值取前6位，每2位组成一组，即3轮循环</span></span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">6</span>; i += <span class="number">2</span>&#123;</span><br><span class="line">        t := big.NexInt(<span class="number">1</span>)</span><br><span class="line">        <span class="comment">//对2048取余，因为bloom的大小是2048位</span></span><br><span class="line">        b := (<span class="type">uint</span>(b[i+<span class="number">1</span>]) + (<span class="type">uint</span>(b[i]) &lt;&lt; <span class="number">8</span>)) &amp; <span class="number">2047</span></span><br><span class="line">        r.Or(r, t.Lsh(t, b))</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> r</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//查看bloom，判断bin这个过滤器中是否存在dui&#x27;ying</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">BloomLookup</span><span class="params">(bin Bloom, topic bytesBacked)</span></span> <span class="type">bool</span> &#123;</span><br><span class="line">    bloom := bin.Big()</span><br><span class="line">    cmp := bloom9(topic.Bytes()[:])</span><br><span class="line">    <span class="keyword">return</span> bloom.And(bloom, cmp).Cmp(cmp) ==<span class="number">0</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="挖矿算法"><a href="#挖矿算法" class="headerlink" title="挖矿算法"></a>挖矿算法</h2><ol>
<li>通过seed计算出Cache数组</li>
</ol>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="难度调整"><a href="#难度调整" class="headerlink" title="难度调整"></a>难度调整</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">calcDifficultyByzantium</span><span class="params">(time <span class="type">uint64</span>, parent *types.Header)</span></span> *big.Int&#123;</span><br><span class="line">    <span class="comment">//当前时间戳</span></span><br><span class="line">    bigTime := <span class="built_in">new</span>(big.Int).SetUint64(time)</span><br><span class="line">    <span class="comment">//父区块的时间戳</span></span><br><span class="line">    bigParentTime := <span class="built_in">new</span>(big.Int).Set(parent.Time)</span><br><span class="line">    <span class="comment">//难度</span></span><br><span class="line">    x := <span class="built_in">new</span>(big.Int)</span><br><span class="line">    <span class="comment">//难度调整单位</span></span><br><span class="line">    y := <span class="built_in">new</span>(big.Int)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//算出出块时间，然后再除9</span></span><br><span class="line">    x.Sub(bigTime, bigParentTime)</span><br><span class="line">    x.Div(x, big9)</span><br><span class="line">    <span class="comment">//判断是否有叔父区块</span></span><br><span class="line">    <span class="keyword">if</span> parent.UncleHash == types.EmptyUncleHash&#123;</span><br><span class="line">        x.Sub(big1, x)</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        x.Sub(big2, x)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//与最小难度-99相比，不能比它更小</span></span><br><span class="line">    <span class="keyword">if</span> x.Cmp(bigMinus99) &lt; <span class="number">0</span> &#123;</span><br><span class="line">        x.set(bigMinus99)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//计算难度调整单位</span></span><br><span class="line">    <span class="comment">//上一个区块的难度的2048分之1</span></span><br><span class="line">    y.Div(parent.Difficulty, <span class="number">2048</span>)</span><br><span class="line">    x.Mul(y, x)</span><br><span class="line">    x.Add(parent.Difficulty, x)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//难度最小不能小于131072</span></span><br><span class="line">    <span class="keyword">if</span> x.Cmp(params.MinimumDifficulty) &lt; <span class="number">0</span>&#123;</span><br><span class="line">        x.Set(params.MinimumDifficulty)   </span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//难度炸弹计算</span></span><br><span class="line">    <span class="comment">//区块号</span></span><br><span class="line">    fakeBlockNumber := <span class="built_in">new</span>(big.Int)</span><br><span class="line">    <span class="comment">//如果父区块号大于3百万，则减去3百万</span></span><br><span class="line">    <span class="keyword">if</span> parent.Number.Cmp(big2999999) &gt;= <span class="number">0</span>&#123;</span><br><span class="line">        fakeBlockNumber = fakeBlockNumber.Sub(parent.Number, big2999999)</span><br><span class="line">    &#125;</span><br><span class="line">    periodCount := fakeBlockNumber</span><br><span class="line">    <span class="comment">//除于100000</span></span><br><span class="line">    periodCount.Div(periodCount, expDiffPeriod)</span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="keyword">if</span> periodCount.Cmp(big1) &gt; <span class="number">0</span> &#123;</span><br><span class="line">        <span class="comment">//当前区块号-2</span></span><br><span class="line">        y.Sub(periodCount, big2)</span><br><span class="line">        y.Exp(big2, y, <span class="literal">nil</span>)</span><br><span class="line">        x.Add(x, y)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>




      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2024/01/18/Note/%E5%8C%BA%E5%9D%97%E9%93%BE%E5%BC%80%E5%8F%91/%E6%BA%90%E7%A0%81/%E4%BB%A5%E5%A4%AA%E5%9D%8A/" data-id="clrj8k01d00594wuwgfqh3syk" data-title="" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  


  <nav id="page-nav">
    
    <a class="extend prev" rel="prev" href="/page/7/">&laquo; Prev</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/6/">6</a><a class="page-number" href="/page/7/">7</a><span class="page-number current">8</span><a class="page-number" href="/page/9/">9</a><a class="page-number" href="/page/10/">10</a><span class="space">&hellip;</span><a class="page-number" href="/page/12/">12</a><a class="extend next" rel="next" href="/page/9/">Next &raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Go/">Go</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java%E4%B8%AD%E9%97%B4%E4%BB%B6/">Java中间件</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java%E5%9F%BA%E7%A1%80/">Java基础</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java%E6%A1%86%E6%9E%B6/">Java框架</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Web3/">Web3</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E4%BA%BA%E5%B7%A5%E6%99%BA%E8%83%BD/">人工智能</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%8A%9B%E6%89%A3/">力扣</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%BC%80%E5%8F%91/">开发</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/">数据库</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%A8%A1%E5%9D%97/">模块</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%BA%90%E7%A0%81/">源码</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%AE%97%E6%B3%95%E9%A2%98/">算法题</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%9F%A5%E8%AF%86/">计算机知识</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E9%9D%A2%E8%AF%95/">面试</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/code/" rel="tag">code</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/defi/" rel="tag">defi</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/go/" rel="tag">go</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/language/" rel="tag">language</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/solidity/" rel="tag">solidity</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/web3/" rel="tag">web3</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E4%B8%AD%E9%97%B4%E4%BB%B6/" rel="tag">中间件</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E4%BB%A3%E7%A0%81%E9%9A%8F%E6%83%B3%E5%BD%95/" rel="tag">代码随想录</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E4%BC%98%E5%8C%96/" rel="tag">优化</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%89%91%E6%8C%87offer/" rel="tag">剑指offer</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%8A%9B%E6%89%A3%E7%83%AD%E9%A2%98100/" rel="tag">力扣热题100</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%8A%9B%E6%89%A3%E9%A2%98/" rel="tag">力扣题</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%8E%9F%E7%90%86/" rel="tag">原理</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%9F%BA%E7%A1%80/" rel="tag">基础</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%B7%A5%E5%85%B7/" rel="tag">工具</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%B7%A6%E7%A5%9E/" rel="tag">左神</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%BA%93/" rel="tag">库</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%BC%80%E5%8F%91/" rel="tag">开发</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%8A%80%E5%B7%A7/" rel="tag">技巧</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/" rel="tag">操作系统</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/" rel="tag">数据库</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/" rel="tag">数据结构</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E5%92%8C%E7%AE%97%E6%B3%95/" rel="tag">数据结构和算法</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%A1%86%E6%9E%B6/" rel="tag">框架</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%A8%A1%E5%9D%97/" rel="tag">模块</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%A8%A1%E5%9E%8B/" rel="tag">模型</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%BA%90%E7%A0%81/" rel="tag">源码</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%90%86%E5%BF%B5/" rel="tag">理念</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%AE%97%E6%B3%95/" rel="tag">算法</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%B3%BB%E7%BB%9Fan-quan/" rel="tag">系统an&#39;quan</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/" rel="tag">系统设计</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%BD%91%E7%BB%9C/" rel="tag">网络</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%A7%84%E8%8C%83/" rel="tag">规范</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%97%AE%E9%A2%98/" rel="tag">问题</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%9B%86%E6%88%90/" rel="tag">集成</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%9B%86%E7%BE%A4/" rel="tag">集群</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%9D%A2%E8%AF%95/" rel="tag">面试</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/code/" style="font-size: 10px;">code</a> <a href="/tags/defi/" style="font-size: 10px;">defi</a> <a href="/tags/go/" style="font-size: 10px;">go</a> <a href="/tags/language/" style="font-size: 10px;">language</a> <a href="/tags/solidity/" style="font-size: 10px;">solidity</a> <a href="/tags/web3/" style="font-size: 12.86px;">web3</a> <a href="/tags/%E4%B8%AD%E9%97%B4%E4%BB%B6/" style="font-size: 20px;">中间件</a> <a href="/tags/%E4%BB%A3%E7%A0%81%E9%9A%8F%E6%83%B3%E5%BD%95/" style="font-size: 10px;">代码随想录</a> <a href="/tags/%E4%BC%98%E5%8C%96/" style="font-size: 10px;">优化</a> <a href="/tags/%E5%89%91%E6%8C%87offer/" style="font-size: 10px;">剑指offer</a> <a href="/tags/%E5%8A%9B%E6%89%A3%E7%83%AD%E9%A2%98100/" style="font-size: 10px;">力扣热题100</a> <a href="/tags/%E5%8A%9B%E6%89%A3%E9%A2%98/" style="font-size: 10px;">力扣题</a> <a href="/tags/%E5%8E%9F%E7%90%86/" style="font-size: 10px;">原理</a> <a href="/tags/%E5%9F%BA%E7%A1%80/" style="font-size: 15.71px;">基础</a> <a href="/tags/%E5%B7%A5%E5%85%B7/" style="font-size: 10px;">工具</a> <a href="/tags/%E5%B7%A6%E7%A5%9E/" style="font-size: 10px;">左神</a> <a href="/tags/%E5%BA%93/" style="font-size: 10px;">库</a> <a href="/tags/%E5%BC%80%E5%8F%91/" style="font-size: 18.57px;">开发</a> <a href="/tags/%E6%8A%80%E5%B7%A7/" style="font-size: 11.43px;">技巧</a> <a href="/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/" style="font-size: 10px;">操作系统</a> <a href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/" style="font-size: 12.86px;">数据库</a> <a href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/" style="font-size: 11.43px;">数据结构</a> <a href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E5%92%8C%E7%AE%97%E6%B3%95/" style="font-size: 17.14px;">数据结构和算法</a> <a href="/tags/%E6%A1%86%E6%9E%B6/" style="font-size: 14.29px;">框架</a> <a href="/tags/%E6%A8%A1%E5%9D%97/" style="font-size: 15.71px;">模块</a> <a href="/tags/%E6%A8%A1%E5%9E%8B/" style="font-size: 11.43px;">模型</a> <a href="/tags/%E6%BA%90%E7%A0%81/" style="font-size: 12.86px;">源码</a> <a href="/tags/%E7%90%86%E5%BF%B5/" style="font-size: 14.29px;">理念</a> <a href="/tags/%E7%AE%97%E6%B3%95/" style="font-size: 10px;">算法</a> <a href="/tags/%E7%B3%BB%E7%BB%9Fan-quan/" style="font-size: 10px;">系统an'quan</a> <a href="/tags/%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/" style="font-size: 10px;">系统设计</a> <a href="/tags/%E7%BD%91%E7%BB%9C/" style="font-size: 10px;">网络</a> <a href="/tags/%E8%A7%84%E8%8C%83/" style="font-size: 10px;">规范</a> <a href="/tags/%E9%97%AE%E9%A2%98/" style="font-size: 10px;">问题</a> <a href="/tags/%E9%9B%86%E6%88%90/" style="font-size: 10px;">集成</a> <a href="/tags/%E9%9B%86%E7%BE%A4/" style="font-size: 10px;">集群</a> <a href="/tags/%E9%9D%A2%E8%AF%95/" style="font-size: 12.86px;">面试</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/01/">January 2024</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2024/01/18/Note/%E9%9D%A2%E8%AF%95/%E7%AE%80%E5%8E%86/">(no title)</a>
          </li>
        
          <li>
            <a href="/2024/01/18/Note/%E9%9D%A2%E8%AF%95/%E8%8B%B1%E8%AF%AD/">(no title)</a>
          </li>
        
          <li>
            <a href="/2024/01/18/Note/%E9%9D%A2%E8%AF%95/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/">计算机基础</a>
          </li>
        
          <li>
            <a href="/2024/01/18/Note/%E9%9D%A2%E8%AF%95/%E5%9C%BA%E6%99%AF%E9%A2%98/">场景题</a>
          </li>
        
          <li>
            <a href="/2024/01/18/Note/%E9%9D%A2%E8%AF%95/%E6%95%B0%E6%8D%AE%E5%BA%93/">(no title)</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2024 JianHong<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.6.4.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>