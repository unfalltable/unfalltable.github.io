<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>JianHong</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="Note">
<meta property="og:type" content="website">
<meta property="og:title" content="JianHong">
<meta property="og:url" content="http://example.com/page/4/index.html">
<meta property="og:site_name" content="JianHong">
<meta property="og:description" content="Note">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="JianHong">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="JianHong" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
  
<meta name="generator" content="Hexo 7.0.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">JianHong</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"><span class="fa fa-bars"></span></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
        
          <a class="nav-icon" href="/atom.xml" title="RSS Feed"><span class="fa fa-rss"></span></a>
        
        <a class="nav-icon nav-search-btn" title="Search"><span class="fa fa-search"></span></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main">
  
    <article id="post-Note/工具库/web3/Truffle" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2024/01/18/Note/%E5%B7%A5%E5%85%B7%E5%BA%93/web3/Truffle/" class="article-date">
  <time class="dt-published" datetime="2024-01-18T13:12:24.717Z" itemprop="datePublished">2024-01-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        
      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2024/01/18/Note/%E5%B7%A5%E5%85%B7%E5%BA%93/web3/Truffle/" data-id="clrj8qr5l0059v4uw3c478vzs" data-title="" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-Note/工具库/web3/Web3js-Ethersjs" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2024/01/18/Note/%E5%B7%A5%E5%85%B7%E5%BA%93/web3/Web3js-Ethersjs/" class="article-date">
  <time class="dt-published" datetime="2024-01-18T13:12:24.717Z" itemprop="datePublished">2024-01-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        
      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2024/01/18/Note/%E5%B7%A5%E5%85%B7%E5%BA%93/web3/Web3js-Ethersjs/" data-id="clrj8qr5m005dv4uw0h4d56a0" data-title="" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-Note/工具库/web3/Ganache" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2024/01/18/Note/%E5%B7%A5%E5%85%B7%E5%BA%93/web3/Ganache/" class="article-date">
  <time class="dt-published" datetime="2024-01-18T13:12:24.716Z" itemprop="datePublished">2024-01-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><ul>
<li>临时部署区块链，不需要test网就能做测试</li>
<li>缺点是区块高度不会实时刷新</li>
<li>可以直连小狐狸钱包</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2024/01/18/Note/%E5%B7%A5%E5%85%B7%E5%BA%93/web3/Ganache/" data-id="clrj8qr5l0056v4uwhgpt7wui" data-title="" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-Note/工具库/web3/Hardhat" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2024/01/18/Note/%E5%B7%A5%E5%85%B7%E5%BA%93/web3/Hardhat/" class="article-date">
  <time class="dt-published" datetime="2024-01-18T13:12:24.716Z" itemprop="datePublished">2024-01-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><ul>
<li>1</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2024/01/18/Note/%E5%B7%A5%E5%85%B7%E5%BA%93/web3/Hardhat/" data-id="clrj8qr5m005bv4uw7kehbrlg" data-title="" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-Note/后端/Rust/Rust" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2024/01/18/Note/%E5%90%8E%E7%AB%AF/Rust/Rust/" class="article-date">
  <time class="dt-published" datetime="2024-01-18T13:12:24.711Z" itemprop="datePublished">2024-01-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        
      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2024/01/18/Note/%E5%90%8E%E7%AB%AF/Rust/Rust/" data-id="clrj8qr5o005pv4uw7gg22vu2" data-title="" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-Note/后端/Java/项目/电商" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2024/01/18/Note/%E5%90%8E%E7%AB%AF/Java/%E9%A1%B9%E7%9B%AE/%E7%94%B5%E5%95%86/" class="article-date">
  <time class="dt-published" datetime="2024-01-18T13:12:24.709Z" itemprop="datePublished">2024-01-18</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%A8%A1%E5%9D%97/">模块</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2024/01/18/Note/%E5%90%8E%E7%AB%AF/Java/%E9%A1%B9%E7%9B%AE/%E7%94%B5%E5%95%86/">电商</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="商品管理"><a href="#商品管理" class="headerlink" title="商品管理"></a>商品管理</h2><h3 id="SKU和SPU"><a href="#SKU和SPU" class="headerlink" title="SKU和SPU"></a>SKU和SPU</h3><ul>
<li>SKU是 库存量单位<ul>
<li>商品信息参数的聚合，如商品的规格参数</li>
</ul>
</li>
<li>SPU是 标准化产品单元<ul>
<li>商品信息的聚合，如一个概览信息，也成为销售属性</li>
</ul>
</li>
<li>SPU像是类，SKU像是对象</li>
</ul>
<h3 id="分类-品牌-属性"><a href="#分类-品牌-属性" class="headerlink" title="分类-品牌-属性"></a>分类-品牌-属性</h3><ul>
<li><p>各表之间独立存储，通过关联表关联</p>
</li>
<li><p>提供添加关联的功能</p>
<ul>
<li>属性分组和规格参数关联</li>
</ul>
</li>
<li><p>属性</p>
<ul>
<li><p>属性分组</p>
<ul>
<li>基本信息</li>
<li>主体信息</li>
</ul>
</li>
<li><p>规格参数（基本参数）</p>
<ul>
<li>详细的信息</li>
</ul>
</li>
<li><p>销售属性</p>
</li>
</ul>
</li>
</ul>
<h2 id="仓库管理"><a href="#仓库管理" class="headerlink" title="仓库管理"></a>仓库管理</h2><h3 id="库存维护"><a href="#库存维护" class="headerlink" title="库存维护"></a>库存维护</h3><h3 id="采购单维护"><a href="#采购单维护" class="headerlink" title="采购单维护"></a>采购单维护</h3><p><img src="/../../pic/image-20230325113549822.png" alt="image-20230325113549822"></p>
<h4 id="合并采购单"><a href="#合并采购单" class="headerlink" title="合并采购单"></a>合并采购单</h4><ul>
<li>将采购需求合并为一个采购单，并分配给对应的人员</li>
<li>需要为采购需求设置状态<ul>
<li>新建、已分配、已领取、已完成、有异常</li>
</ul>
</li>
</ul>
<h4 id="领取采购单"><a href="#领取采购单" class="headerlink" title="领取采购单"></a>领取采购单</h4><ul>
<li>领取了采购单则标记为已领取</li>
</ul>
<h4 id="完成采购"><a href="#完成采购" class="headerlink" title="完成采购"></a>完成采购</h4><ul>
<li>需要判断全部采购完成还是部分采购完成</li>
</ul>
<h2 id="订单超时处理"><a href="#订单超时处理" class="headerlink" title="订单超时处理"></a>订单超时处理</h2><h3 id="JDK自带的延时队列"><a href="#JDK自带的延时队列" class="headerlink" title="JDK自带的延时队列"></a>JDK自带的延时队列</h3><h4 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h4><ol>
<li>把订单插入DelayQueue中，以超时时间作为排序条件，将订单按照超时时间从小到大排序。</li>
<li>起一个线程不停轮询队列的头部，如果订单的超时时间到了，就出队进行超时处理，并更新订单状态到数据库中。</li>
<li>为了防止机器重启导致内存中的DelayQueue数据丢失，每次机器启动的时候，需要从数据库中初始化未结束的订单，加入到DelayQueue中。</li>
</ol>
<h5 id="优点"><a href="#优点" class="headerlink" title="优点"></a>优点</h5><ul>
<li>简单，不需要借助其他第三方组件，成本低。</li>
</ul>
<h5 id="缺点"><a href="#缺点" class="headerlink" title="缺点"></a>缺点</h5><ul>
<li>所有超时处理订单都要加入到DelayQueue中，占用内存大。</li>
<li>没法做到分布式处理，只能在集群中选一台leader专门处理，效率低。</li>
<li>不适合订单量比较大的场景。</li>
</ul>
<h3 id="RabbitMQ的延时消息"><a href="#RabbitMQ的延时消息" class="headerlink" title="RabbitMQ的延时消息"></a>RabbitMQ的延时消息</h3><h4 id="实现一"><a href="#实现一" class="headerlink" title="实现一"></a>实现一</h4><ul>
<li>使用官方提供的延时消息插件 RabbitMQ Delayed Message Plugin</li>
</ul>
<h5 id="优点-1"><a href="#优点-1" class="headerlink" title="优点"></a>优点</h5><ul>
<li>方便，易用</li>
</ul>
<h5 id="缺点-1"><a href="#缺点-1" class="headerlink" title="缺点"></a>缺点</h5><ul>
<li>不是高可用的，节点挂起会导致消息丢失</li>
</ul>
<h4 id="实现二"><a href="#实现二" class="headerlink" title="实现二"></a>实现二</h4><ul>
<li>消息的TTL+死信Exchange<ul>
<li>TTL：<ul>
<li>即消息的存活时间。RabbitMQ可以对队列和消息分别设置TTL，如果对队列设置，则队列中所有的消息都具有相同的过期时间。</li>
<li>超过了这个时间，我们认为这个消息就死了，称之为死信。</li>
</ul>
</li>
<li>死信Exchange（DLX）：一个消息在满足以下条件会进入死信交换机<ul>
<li>一个消息被Consumer拒收了，并且reject方法的参数里requeue是false。也就是说不会被再次放在队列里，被其他消费者使用。</li>
<li>TTL到期的消息。</li>
<li>队列满了被丢弃的消息。</li>
</ul>
</li>
</ul>
</li>
</ul>
<h5 id="优点-2"><a href="#优点-2" class="headerlink" title="优点"></a>优点</h5><ul>
<li>可以支持海量延时消息，支持分布式处理。</li>
</ul>
<h5 id="缺点-2"><a href="#缺点-2" class="headerlink" title="缺点"></a>缺点</h5><ul>
<li>不灵活，只能支持固定延时等级。</li>
<li>使用复杂，要配置一堆延时队列。</li>
</ul>
<h3 id="RocketMQ的定时消息"><a href="#RocketMQ的定时消息" class="headerlink" title="RocketMQ的定时消息"></a>RocketMQ的定时消息</h3><h4 id="实现-1"><a href="#实现-1" class="headerlink" title="实现"></a>实现</h4><ul>
<li>只要在发送消息时设置延时时间即可</li>
</ul>
<h5 id="优点-3"><a href="#优点-3" class="headerlink" title="优点"></a>优点</h5><ul>
<li>精度高，支持任意时刻。</li>
<li>使用门槛低，和使用普通消息一样</li>
</ul>
<h5 id="缺点-3"><a href="#缺点-3" class="headerlink" title="缺点"></a>缺点</h5><ul>
<li>使用限制：定时时长最大值24小时。</li>
<li>成本高：每个订单需要新增一个定时消息，且不会马上消费，给MQ带来很大的存储成本。</li>
<li>同一个时刻大量消息会导致消息延迟：定时消息的实现逻辑需要先经过定时存储等待触发，定时时间到达后才会被投递给消费者。因此，如果将大量定时消息的定时时间设置为同一时刻，则到达该时刻后会有大量消息同时需要被处理，会造成系统压力过大，导致消息分发延迟，影响定时精度。</li>
</ul>
<h3 id="Redis过期监听"><a href="#Redis过期监听" class="headerlink" title="Redis过期监听"></a>Redis过期监听</h3><h4 id="实现-2"><a href="#实现-2" class="headerlink" title="实现"></a>实现</h4><ul>
<li>redis配置文件开启”notify-keyspace-events Ex”</li>
<li>监听key的过期回调</li>
<li>每当我们对一个key设置了过期时间，Redis就会把该key带上过期时间，存到过期字典中，在redisDb中通过expires字段维护：</li>
<li>有定期删除和惰性删除两种</li>
</ul>
<h5 id="优点-4"><a href="#优点-4" class="headerlink" title="优点"></a>优点</h5><p>- </p>
<h5 id="缺点-4"><a href="#缺点-4" class="headerlink" title="缺点"></a>缺点</h5><ul>
<li>不可靠，不准确</li>
</ul>
<h3 id="定时任务分布式批处理"><a href="#定时任务分布式批处理" class="headerlink" title="定时任务分布式批处理"></a>定时任务分布式批处理</h3><h4 id="实现-3"><a href="#实现-3" class="headerlink" title="实现"></a>实现</h4><ul>
<li>使用分布式任务调度系统SchedulerX，不但兼容主流开源任务调度系统和Spring @Scheduled注解，还自研了轻量级MapReduce模型[4]，针对任意异构数据源，简单几行代码就可以实现海量数据秒级别跑批<ul>
<li>通过实现map函数，通过代码自行构造分片，SchedulerX会将分片平均分给超时中心的不同节点分布式执行</li>
<li>通过实现reduce函数，可以做聚合，可以判断这次跑批有哪些分片跑失败了，从而通知下游处理</li>
</ul>
</li>
</ul>
<h5 id="优点-5"><a href="#优点-5" class="headerlink" title="优点"></a>优点</h5><ul>
<li>稳定性强，需要保证业务幂等</li>
<li>效率高，使用定时任务跑批方案，一次捞出一批订单，处理完了，可以批量更新订单状态，减少数据库的tps。在海量订单处理场景下，批量处理效率最高</li>
<li>可运维,基于数据库存储，可以很方便的对订单进行修改、暂停、取消等操作，所见即所得。如果业务跑失败了，还可以直接通过sql修改数据库来进行批量运维</li>
<li><strong>免运维、成本低：</strong>不需要自建任务调度系统，由云上托管。</li>
<li><strong>可观测：</strong>提供任务执行的历史记录、查看堆栈、日志服务、链路追踪等能力。</li>
<li><strong>高可用：</strong>支持同城双活容灾，支持多种渠道的监控报警。</li>
<li><strong>混部：</strong>可以托管阿里云的机器，也可以托管非阿里云的机器。</li>
</ul>
<h5 id="缺点-5"><a href="#缺点-5" class="headerlink" title="缺点"></a>缺点</h5><ul>
<li>没法做到精度很高。定时任务的延迟时间，由定时任务的调度周期决定。如果把频率设置很小，就会导致数据库的qps比较高，容易造成数据库压力过大，从而影响线上的正常业务</li>
<li>所以一般需要抽离出超时中心和超时库来单独做订单的超时调度</li>
</ul>
<h2 id="抢红包"><a href="#抢红包" class="headerlink" title="抢红包"></a>抢红包</h2><h3 id="问题分析"><a href="#问题分析" class="headerlink" title="问题分析"></a>问题分析</h3><ul>
<li>发红包<ul>
<li>不需要加锁，发红包没有竞争</li>
<li>拆分红包<ul>
<li>确保原子性并且不加锁</li>
<li>拆分红包使用二倍均值算法：抢到的金额 &#x3D; 随机（0，剩余红包金额 &#x2F; 剩余红包数 * 2）</li>
</ul>
</li>
<li>存红包<ul>
<li>红包存redis中的list，lpush存，lpop取，设置过期时间，返回一个红包的key</li>
<li>存redis后会有一个唯一key</li>
</ul>
</li>
</ul>
</li>
<li>抢红包<ul>
<li>根据redis中存的红包key</li>
<li>用另一个hash表记录红包的消费信息</li>
<li>使用用户的token判断是否重复抢，没在hash中的才能抢</li>
</ul>
</li>
<li>统计红包记录<ul>
<li>根据hash表中记录的</li>
</ul>
</li>
<li>红包回退</li>
<li>配置红包雨数量、金额、时间等</li>
</ul>
<h3 id="架构"><a href="#架构" class="headerlink" title="架构"></a>架构</h3><ul>
<li>redis集群（写 8万&#x2F;s）</li>
</ul>
<h2 id="秒杀"><a href="#秒杀" class="headerlink" title="秒杀"></a>秒杀</h2><h3 id="总体思路"><a href="#总体思路" class="headerlink" title="总体思路"></a>总体思路</h3><ul>
<li>秒杀最主要的是查看商品详情页和下单两个模块</li>
<li>查看商品详情页<ul>
<li>前端从CDN上取得页面数据，后端将页面静态化后存到cdn上</li>
<li>添加nginx做负载均衡，然后用redis缓存，nginx访问redis<ul>
<li>redis中没有数据再去查JVM缓存</li>
<li>JVM缓存中没有再去查数据库</li>
</ul>
</li>
</ul>
</li>
<li><h2 id="下单"><a href="#下单" class="headerlink" title="下单"></a>下单</h2></li>
</ul>
<h3 id="全局唯一ID"><a href="#全局唯一ID" class="headerlink" title="全局唯一ID"></a>全局唯一ID</h3><ul>
<li>需要满足唯一性，安全性，高可用，高性能</li>
<li>使用Redis中的incrby实现<ul>
<li>符号位（1）+ 时间戳（31）+ 序列号（32）<ul>
<li>时间戳 &#x3D; 当前时间 - 自定义的一个过去的时间常量</li>
<li>序列号 &#x3D; “一些前缀” + 当前时间 + 1</li>
<li>返回     时间戳 &lt;&lt; 32 | 序列号</li>
</ul>
</li>
</ul>
</li>
<li>使用雪花算法<ul>
<li>1bit + 时间戳（41）+ 机器id（10）+ 序列号（12）</li>
<li>同一毫秒生成的id不超过4095，超过4095则到下一毫秒生成</li>
<li>由于每一台机器的工作机器id不同，所以分布式环境下也不会冲突</li>
</ul>
</li>
</ul>
<h3 id="防止库存超卖"><a href="#防止库存超卖" class="headerlink" title="防止库存超卖"></a>防止库存超卖</h3><ul>
<li><p>CAS</p>
</li>
<li><p>Synchronize</p>
</li>
<li><p>分布式锁</p>
</li>
</ul>
<h3 id="一人一单"><a href="#一人一单" class="headerlink" title="一人一单"></a>一人一单</h3><ul>
<li>需要在扣减库存前进行判断，并且把判断过程和扣减库存用synchronize锁住</li>
<li>以userId作为锁</li>
<li>在分布式系统下无法保证，需要使用分布式锁</li>
</ul>
<h3 id="异步秒杀"><a href="#异步秒杀" class="headerlink" title="异步秒杀"></a>异步秒杀</h3><ul>
<li>由于当前大多数业务都是在tomcat中串行执行的，效率低</li>
<li>把秒杀券信息也保存到redis中</li>
<li>所以我们可以把判断库存、扣减库存和一人一单校验放在redis中进行<ul>
<li>使用lua脚本确保原子性</li>
</ul>
</li>
<li>用户秒杀成功后将优惠券id和用户id存入<strong>阻塞队列</strong>中，将订单id返回给用户</li>
<li>开启线程任务不断读取<strong>阻塞队列</strong>中的订单异步下单</li>
</ul>
<h3 id="消息队列"><a href="#消息队列" class="headerlink" title="消息队列"></a>消息队列</h3><ul>
<li><p>使用Stream的Group（消费组）实现消息队列</p>
<ul>
<li>消息分流<ul>
<li>队列中的消息会分流给组内不同的消费者，从而加快消息处理速度</li>
</ul>
</li>
<li>消息标示<ul>
<li>会维护一个标识记录最后一个被处理的消息，即使宕机重启，还会从标识之后读取消息，确保每一个消息都被消费</li>
</ul>
</li>
<li>消息确认<ul>
<li>消费者获得消息后，消息会处于pending状态，并存入一个pending-list，当处理完消息后需要通过XACK来确认消息，标记消息已处理，才会从pending-list移除</li>
</ul>
</li>
<li>可以阻塞读取</li>
<li>消息可回溯，即持久化存储</li>
</ul>
<h4 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h4><ul>
<li>创建一个StreamGroup类型的消息队列，名为stream.orders<ul>
<li><code>XGROUP CREATE stream.orders g1 0 MKSTREAM</code></li>
</ul>
</li>
<li>使用lua脚本向消息队列中添加消息</li>
<li>开启一个线程从消息队列中取出消息<ul>
<li>判断信息是否为空<ul>
<li>空继续下一轮循环</li>
<li>非空解析信息然后创建订单</li>
</ul>
</li>
</ul>
</li>
<li>确认消息队列中的消息</li>
<li>如果这个过程出现异常需要处理pending-list</li>
</ul>
</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2024/01/18/Note/%E5%90%8E%E7%AB%AF/Java/%E9%A1%B9%E7%9B%AE/%E7%94%B5%E5%95%86/" data-id="clrj8qr6700asv4uw81jy2uig" data-title="电商" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E6%A8%A1%E5%9D%97/" rel="tag">模块</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-Note/后端/Java/项目/即时通讯" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2024/01/18/Note/%E5%90%8E%E7%AB%AF/Java/%E9%A1%B9%E7%9B%AE/%E5%8D%B3%E6%97%B6%E9%80%9A%E8%AE%AF/" class="article-date">
  <time class="dt-published" datetime="2024-01-18T13:12:24.708Z" itemprop="datePublished">2024-01-18</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%A8%A1%E5%9D%97/">模块</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2024/01/18/Note/%E5%90%8E%E7%AB%AF/Java/%E9%A1%B9%E7%9B%AE/%E5%8D%B3%E6%97%B6%E9%80%9A%E8%AE%AF/">聊天模块</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="WebSocket-MongoDB-RocketMQ"><a href="#WebSocket-MongoDB-RocketMQ" class="headerlink" title="WebSocket + MongoDB + RocketMQ"></a>WebSocket + MongoDB + RocketMQ</h2><h3 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h3><ol>
<li><p>处理消息（创建消息对象，实现消息的基本功能）</p>
<ul>
<li><p>创建消息类并创建MongoDB中的集合（表）</p>
<ul>
<li>@Indexed设置索引</li>
<li>类中需要有User From和User to属性</li>
</ul>
</li>
<li><p>实现消息的增删改查</p>
<ul>
<li><p>查询点对点的聊天记录</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> List&lt;Message&gt; <span class="title function_">findListByFromAndTo</span><span class="params">(Long fromId, Long toId, Integer page, Integer rows)</span>&#123;</span><br><span class="line">    <span class="comment">//设置查询条件</span></span><br><span class="line">    <span class="comment">//用户A发送给用户B的条件</span></span><br><span class="line">    <span class="type">Criteria</span> <span class="variable">criteriaFrom</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Criteria</span>().andOperator(</span><br><span class="line">        Criteria.where(<span class="string">&quot;from.id&quot;</span>).id(fromId),.</span><br><span class="line">        Criteria.where(<span class="string">&quot;to.id&quot;</span>).id(toId)</span><br><span class="line">    );</span><br><span class="line">    <span class="comment">//用户B发送给用户A的条件</span></span><br><span class="line">    <span class="type">Criteria</span> <span class="variable">criteriaTo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Criteria</span>().andOperator(</span><br><span class="line">        Criteria.where(<span class="string">&quot;from.id&quot;</span>).id(toId),</span><br><span class="line">        Criteria.where(<span class="string">&quot;to.id&quot;</span>).id(fromId)</span><br><span class="line">    );</span><br><span class="line">    <span class="comment">//创建查询条件对象</span></span><br><span class="line">    <span class="type">Criteria</span> <span class="variable">criteria</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Criteria</span>().orOperator(criteriaFrom, criteriaTo);</span><br><span class="line">    <span class="comment">//设置分页，按发送时间降序</span></span><br><span class="line">    <span class="type">PageRequest</span> <span class="variable">pageRequest</span> <span class="operator">=</span> PageRequest.of(page - <span class="number">1</span>, pageSize, Sort.by(Sort.Direction.ASC, <span class="string">&quot;send_data&quot;</span>));</span><br><span class="line">    <span class="comment">//设置查询条件，分页</span></span><br><span class="line">    <span class="type">Query</span> <span class="variable">query</span> <span class="operator">=</span> Query.query(criteria).with(pageRequest);</span><br><span class="line">    <span class="comment">//需要查询语句和对象</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.mongoTemplate.find(query, Message.class);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
</li>
<li><p>编写WebSocket</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MessageHandler</span> <span class="keyword">extends</span> <span class="title class_">TextWebSocketHandler</span> <span class="keyword">implements</span> <span class="title class_">RocketMQListener</span>&lt;String&gt;&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterConnectionEstablished</span><span class="params">(WebSocketSession session)</span> <span class="keyword">throws</span> Exection&#123;</span><br><span class="line">        <span class="comment">//建立连接后要做的事情</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//接收消息</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">handleTextMessage</span><span class="params">(WebSocketSession session, TextMessage textMessage)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="comment">//将消息保存到mongodb</span></span><br><span class="line">        message = <span class="built_in">this</span>.messageDAO.saveMessage(message);</span><br><span class="line">        <span class="comment">//发送消息</span></span><br><span class="line">        webSocketSession.sendMessage(<span class="keyword">new</span> <span class="title class_">TextMessage</span>(MAPPER.writeValueAsString(message)));</span><br><span class="line">        <span class="comment">//用户可能在其他节点中，先将消息发送到MQ中</span></span><br><span class="line">        <span class="comment">//需要添加tag便于消费者筛选</span></span><br><span class="line">        <span class="built_in">this</span>.rocketMQTemplate.convertAndSend(topic:tag, 序列化后的消息);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>设置WebSocket拦截器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MessageHandshakeInterceptor</span> <span class="keyword">implements</span> <span class="title class_">HandshakeInterceptor</span>, WebSocketConfigurer&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">beforeHandshake</span><span class="params">(ServerHttpRequest request, ServerHttpResponse response, WebSocketHandler wsHandler, Map&lt;String, Object&gt; attributes)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="comment">//在客户端与服务端建立连接之前执行，握手之前进行一些处理</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">registerWebSocketHandlers</span><span class="params">(WebSocketHandlerRegistry registry)</span>&#123;</span><br><span class="line">        registry.addHandler(<span class="built_in">this</span>.messageHandler, <span class="string">&quot;/ws/&#123;uid&#125;&quot;</span>)</span><br><span class="line">            .setAllowedOrigins(<span class="string">&quot;*&quot;</span>) <span class="comment">//设置跨域请求</span></span><br><span class="line">            .addInterceptors(<span class="built_in">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>分布式WebSocket</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@RocketMQMessageListener(</span></span><br><span class="line"><span class="meta">    topic = &quot;&quot;,				  //topic</span></span><br><span class="line"><span class="meta">    selectorExpression = &quot;&quot;,   //tag</span></span><br><span class="line"><span class="meta">    messageModel =  ,		  //消息模式：广播 / 集群</span></span><br><span class="line"><span class="meta">    consumerGroup = &quot;&quot; 		  //消费者组</span></span><br><span class="line"><span class="meta">)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MessageHandler</span> <span class="keyword">implements</span> <span class="title class_">RocketMQListener</span>&lt;String&gt;&#123;</span><br><span class="line">    <span class="comment">//接收到MQ消息</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onMessage</span><span class="params">(String msg)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">		<span class="comment">//找到该机器下的用户并给他发送消息</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="处理消息"><a href="#处理消息" class="headerlink" title="处理消息"></a>处理消息</h3><ul>
<li><p><code>Message</code>类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstruceor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@Document(collection = &quot;message&quot;)</span> <span class="comment">//指定</span></span><br><span class="line"><span class="meta">@Builder</span> <span class="comment">//转变为建造者模式，链式构建对象</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Message</span>&#123;</span><br><span class="line">    <span class="meta">@Id</span> 		<span class="comment">//主键</span></span><br><span class="line">    <span class="keyword">private</span> ObjectId id;</span><br><span class="line">    <span class="keyword">private</span> String msg;</span><br><span class="line">    <span class="meta">@Indexed</span> 	<span class="comment">//需要建立索引</span></span><br><span class="line">    <span class="keyword">private</span> Integer status; 	<span class="comment">// 1-未读  2-已读</span></span><br><span class="line">    <span class="meta">@Field(&quot;send_date&quot;)</span></span><br><span class="line">    <span class="meta">@Indexe</span>		<span class="comment">//需要建立索引</span></span><br><span class="line">    <span class="keyword">private</span> Date sendDate;</span><br><span class="line">    <span class="meta">@Field(&quot;read_date&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Date readDate;</span><br><span class="line">    <span class="meta">@Indexed</span> 	<span class="comment">//需要建立索引</span></span><br><span class="line">    <span class="keyword">private</span> User from;</span><br><span class="line">    <span class="meta">@Indexed</span> 	<span class="comment">//需要建立索引</span></span><br><span class="line">    <span class="keyword">private</span> User to;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建<code>User</code>类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstruceor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@Builder</span> <span class="comment">//转变为建造者模式，链式调用</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建<code>MessageDAO</code> 接口，定义业务方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">MessageDAO</span>&#123;</span><br><span class="line">    <span class="comment">//查询点对点的聊天记录</span></span><br><span class="line">    List&lt;Message&gt; <span class="title function_">findListByFromAndTo</span><span class="params">(Long fromId, Long toId, Integer page, Integer rows)</span>;</span><br><span class="line">    <span class="comment">//根据id查询数据</span></span><br><span class="line">    Message <span class="title function_">findMessageById</span><span class="params">(String id)</span>;</span><br><span class="line">    <span class="comment">//更新消息状态</span></span><br><span class="line">    UpdateResult <span class="title function_">updateMessageState</span><span class="params">(ObjectId id, Integer status)</span>;</span><br><span class="line">    <span class="comment">//新增消息，保存到mongodb</span></span><br><span class="line">    Message <span class="title function_">saveMessage</span><span class="params">(Message message)</span>;</span><br><span class="line">    <span class="comment">//根据消息id删除数据</span></span><br><span class="line">    DeleteResult <span class="title function_">deleteMessage</span><span class="params">(String id)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建<code>MessageDaoImpl</code> 实现类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MessageDaoImpl</span> <span class="keyword">implements</span> <span class="title class_">MessageDAO</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MongoTemplate mongoTemplate;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//查询点对点的聊天记录</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;Message&gt; <span class="title function_">findListByFromAndTo</span><span class="params">(Long fromId, Long toId, Integer page, Integer rows)</span>&#123;</span><br><span class="line">        <span class="comment">//设置查询条件</span></span><br><span class="line">        <span class="comment">//用户A发送给用户B的条件</span></span><br><span class="line">        <span class="type">Criteria</span> <span class="variable">criteriaFrom</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Criteria</span>().andOperator(</span><br><span class="line">        	Criteria.where(<span class="string">&quot;from.id&quot;</span>).id(fromId),.</span><br><span class="line">            Criteria.where(<span class="string">&quot;to.id&quot;</span>).id(toId)</span><br><span class="line">        );</span><br><span class="line">        <span class="comment">//用户B发送给用户A的条件</span></span><br><span class="line">        <span class="type">Criteria</span> <span class="variable">criteriaTo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Criteria</span>().andOperator(</span><br><span class="line">        	Criteria.where(<span class="string">&quot;from.id&quot;</span>).id(toId),</span><br><span class="line">            Criteria.where(<span class="string">&quot;to.id&quot;</span>).id(fromId)</span><br><span class="line">        );</span><br><span class="line">        <span class="comment">//创建查询条件对象</span></span><br><span class="line">        <span class="type">Criteria</span> <span class="variable">criteria</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Criteria</span>().orOperator(criteriaFrom, criteriaTo);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//设置分页</span></span><br><span class="line">        <span class="type">PageRequest</span> <span class="variable">pageRequest</span> <span class="operator">=</span> PageRequest.of(page - <span class="number">1</span>, pageSize, Sort.by(Sort.Direction.ASC, <span class="string">&quot;send_data&quot;</span>));</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//设置查询条件， 分页</span></span><br><span class="line">        <span class="type">Query</span> <span class="variable">query</span> <span class="operator">=</span> Query.query(criteria).with(pageRequest);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//需要查询语句和对象</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.mongoTemplate.find(query, Message.class);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//根据id查询数据</span></span><br><span class="line">    <span class="keyword">public</span> Message <span class="title function_">findMessageById</span><span class="params">(String id)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.mongoTemplate.findById(<span class="keyword">new</span> <span class="title class_">ObjectId</span>(id), Message.class);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//更新消息状态</span></span><br><span class="line">    <span class="keyword">public</span> UpdateResult <span class="title function_">updateMessageState</span><span class="params">(ObjectId id, Integer status)</span>&#123;</span><br><span class="line">        <span class="type">Query</span> <span class="variable">query</span> <span class="operator">=</span> Query.query(Criteria.where(<span class="string">&quot;id&quot;</span>).is(id));</span><br><span class="line">        <span class="type">Update</span> <span class="variable">update</span> <span class="operator">=</span> Update.update(<span class="string">&quot;status&quot;</span>, status);</span><br><span class="line">        <span class="keyword">if</span>(status.intValue() == <span class="number">1</span>) update.set(<span class="string">&quot;send_date&quot;</span>, <span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">        <span class="keyword">if</span>(status.intValue() == <span class="number">2</span>) update.set(<span class="string">&quot;read_date&quot;</span>, <span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.mongoTemplate.updateFirst(query, update,  Message.class);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//新增消息，保存到mongodb</span></span><br><span class="line">    <span class="keyword">public</span> Message <span class="title function_">saveMessage</span><span class="params">(Message message)</span>&#123;</span><br><span class="line">        <span class="comment">//需要写入发送时间，设置状态为1-未读</span></span><br><span class="line">        message.setSendDate(<span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">        message.setStatus(<span class="number">1</span>);</span><br><span class="line">        message.setId(ObjectId.get());</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.mongoTemplate.save(message);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//根据消息id删除数据</span></span><br><span class="line">    <span class="keyword">public</span> DeleteResult <span class="title function_">deleteMessage</span><span class="params">(String id)</span>&#123;</span><br><span class="line">        <span class="type">Query</span> <span class="variable">query</span> <span class="operator">=</span> Query.query(Criteria.where(<span class="string">&quot;id&quot;</span>).is(id));</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.mongoTemplate.remove(query, Message.class);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="编写WebSocket"><a href="#编写WebSocket" class="headerlink" title="编写WebSocket"></a>编写WebSocket</h3><p><code>MessageHandler</code>  发送 &#x2F; 接收消息处理</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@RocketMQMessageListener(</span></span><br><span class="line"><span class="meta">    topic = &quot;&quot;,				  //topic</span></span><br><span class="line"><span class="meta">    selectorExpression = &quot;&quot;,   //tag</span></span><br><span class="line"><span class="meta">    messageModel =  ,		  //消息模式：广播 / 集群</span></span><br><span class="line"><span class="meta">    consumerGroup = &quot;&quot; 		  //消费者组</span></span><br><span class="line"><span class="meta">)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MessageHandler</span> <span class="keyword">extends</span> <span class="title class_">TextWebSocketHandler</span> <span class="keyword">implements</span> <span class="title class_">RocketMQListener</span>&lt;String&gt;&#123;</span><br><span class="line">    <span class="comment">//消息的增删改查</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MessageDAO messageDAO;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RocketMQTemplate rocketMQTemplate;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//格式转换</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">ObjectMapper</span> <span class="variable">MAPPER</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>();</span><br><span class="line">    <span class="comment">//收集用户session对象，用于判断用户是否在线</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Map&lt;Long, WebSocketSession&gt; SESSION = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//建立连接后要做的事情</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterConnectionEstablished</span><span class="params">(WebSocketSession session)</span> <span class="keyword">throws</span> Exection&#123;</span><br><span class="line">        <span class="comment">//用户建立连接后将用户Session收集</span></span><br><span class="line">        <span class="type">Long</span> <span class="variable">id</span> <span class="operator">=</span> (Long) session.getAttributes().get(<span class="string">&quot;uid&quot;</span>); <span class="comment">//需要设置拦截器获取</span></span><br><span class="line">        SESSION.put(id, session);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//发送消息</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">handleTextMessage</span><span class="params">(WebSocketSession session, TextMessage textMessage)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Long</span> <span class="variable">uid</span> <span class="operator">=</span> (Long) session.getAttributes().get(<span class="string">&quot;uid&quot;</span>);</span><br><span class="line">        <span class="type">JsonNode</span> <span class="variable">jsonNode</span> <span class="operator">=</span> MAPPER.readTree(textMessage.getPayload());</span><br><span class="line">        <span class="type">Long</span> <span class="variable">toId</span> <span class="operator">=</span> jsonNode.get(<span class="string">&quot;toId&quot;</span>).asLong();</span><br><span class="line">        <span class="type">String</span> <span class="variable">msg</span> <span class="operator">=</span> jsonNode.get(<span class="string">&quot;msg&quot;</span>).asText();</span><br><span class="line">        <span class="type">Message</span> <span class="variable">message</span> <span class="operator">=</span> Message.builder()</span><br><span class="line">            .from(UserData.USER_MAP.get(uid))</span><br><span class="line">            .to(UserData.USER_MAP.get(toId))</span><br><span class="line">            .msg(msg)</span><br><span class="line">            .build();</span><br><span class="line">        <span class="comment">//将消息保存到mongodb</span></span><br><span class="line">        message = <span class="built_in">this</span>.messageDAO.saveMessage(message);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//判断目标用户是否在线</span></span><br><span class="line">        <span class="type">WebSocketSession</span> <span class="variable">toSession</span> <span class="operator">=</span> SESSIONS.get(toId);</span><br><span class="line">        <span class="keyword">if</span>(toId != <span class="literal">null</span> &amp;&amp; toSession.isOpen())&#123;</span><br><span class="line">            toSession.sendMessage(<span class="keyword">new</span> <span class="title class_">TextMessage</span>(MAPPER.writeValueAsString(message)));</span><br><span class="line">            <span class="comment">//将消息更新为已读</span></span><br><span class="line">            <span class="built_in">this</span>.messageDAO.updateMessageState(message.getId(), <span class="number">2</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//分布式WebSocket</span></span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="comment">//用户可能在其他节点中，先将消息发送到MQ中</span></span><br><span class="line">            <span class="comment">//需要添加tag便于消费者筛选</span></span><br><span class="line">            <span class="built_in">this</span>.rocketMQTemplate.convertAndSend(topic:tag, 序列化后的消息);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//消费消息</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onMessage</span><span class="params">(String msg)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">JsonNode</span> <span class="variable">jsonNode</span> <span class="operator">=</span> MAPPER.readTree(msg);</span><br><span class="line">        <span class="type">long</span> <span class="variable">toId</span> <span class="operator">=</span> jsonNode.get(<span class="string">&quot;to&quot;</span>).get(<span class="string">&quot;id&quot;</span>).longValue();</span><br><span class="line">        <span class="comment">//判断to用户是否在线</span></span><br><span class="line">        <span class="type">WebSocketSession</span> <span class="variable">toSession</span> <span class="operator">=</span> SESSION.get(toId);</span><br><span class="line">        <span class="keyword">if</span>(toId != <span class="literal">null</span> &amp;&amp; toSession.isOpen())&#123;</span><br><span class="line">            toSession.sendMessage(<span class="keyword">new</span> <span class="title class_">TextMessage</span>(msg));</span><br><span class="line">            <span class="built_in">this</span>.messageDAO.updateMessageState(<span class="keyword">new</span> <span class="title class_">ObjectId</span>(jsonNode.get(<span class="string">&quot;id&quot;</span>).asText), <span class="number">2</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>MessageHandshakeInterceptor</code> 拦截器，用于获取用户id</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MessageHandshakeInterceptor</span> <span class="keyword">implements</span> <span class="title class_">HandshakeInterceptor</span>&#123;</span><br><span class="line">    <span class="comment">//在客户端与服务端建立连接之前执行，握手之前</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">beforeHandshake</span><span class="params">(ServerHttpRequest request, ServerHttpResponse response, WebSocketHandler wsHandler, Map&lt;String, Object&gt; attributes)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">path</span> <span class="operator">=</span> request.getURI().getPath();</span><br><span class="line">        String[] ss = StringUtils.split(path, <span class="string">&#x27;/&#x27;</span>);</span><br><span class="line">        <span class="keyword">if</span>(ss.length != <span class="number">2</span>) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">if</span>(!StringUtils.isNumeric(ss[<span class="number">1</span>])) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        attributes.put(<span class="string">&quot;uid&quot;</span>, Long.valueOf(ss[<span class="number">1</span>]));</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>WebSOcketConfig</code> 添加拦截器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableWebSocket</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebSocketConfig</span> <span class="keyword">implements</span> <span class="title class_">WebSocketConfigurer</span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MessageHandler messageHandler;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MessageHandshakeInterceptor messageHandshakeInterceptor;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">registerWebSocketHandlers</span><span class="params">(WebSocketHandlerRegistry registry)</span>&#123;</span><br><span class="line">        registry.addHandler(<span class="built_in">this</span>.messageHandler, <span class="string">&quot;/ws/&#123;uid&#125;&quot;</span>)</span><br><span class="line">            .setAllowedOrigins(<span class="string">&quot;*&quot;</span>) <span class="comment">//设置跨域请求</span></span><br><span class="line">            .addInterceptors(<span class="built_in">this</span>.messageHandshakeInterceptor);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="查询历史信息，其实就是查询消息列表"><a href="#查询历史信息，其实就是查询消息列表" class="headerlink" title="查询历史信息，其实就是查询消息列表"></a>查询历史信息，其实就是查询消息列表</h3><ul>
<li><p>创建<code>MessageController</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;message&quot;)</span></span><br><span class="line"><span class="meta">@CrossOrigin</span> <span class="comment">//跨域</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MessageController</span> &#123;</span><br><span class="line">    <span class="meta">@autowired</span></span><br><span class="line">    <span class="keyword">private</span> MessageService messageService;</span><br><span class="line">    </span><br><span class="line">	<span class="meta">@GetMapping</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;Message&gt; <span class="title function_">queryMessageList</span><span class="params">(</span></span><br><span class="line"><span class="params">    	<span class="meta">@RequestParam(&quot;fromId&quot;)</span> Long fromId,</span></span><br><span class="line"><span class="params">    	<span class="meta">@RequestParam(&quot;toId&quot;)</span> Long toId,</span></span><br><span class="line"><span class="params">   		<span class="meta">@RequestParam(value = &quot;page&quot;, default = &quot;1&quot;)</span> Integer page,</span></span><br><span class="line"><span class="params">    	<span class="meta">@RequestParam(value = &quot;rows&quot;, default = &quot;10&quot; Integer rows)</span>&#123;</span></span><br><span class="line"><span class="params">	return <span class="built_in">this</span>.messageService.queryMessageList(fromId, toId, page, rows)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建<code>MessageService</code> </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MessageService</span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MessageDAO messageDAO;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> List&lt;Message&gt; <span class="title function_">queryMessageList</span><span class="params">(Long fromId, Long toId, Integer page, Integer rows)</span>&#123;</span><br><span class="line">        List&lt;Message&gt; list = <span class="built_in">this</span>.messageDAO.findListByFromAndTo(fromId, toId, page, rows);</span><br><span class="line">        <span class="comment">//设置消息状态为已读</span></span><br><span class="line">        <span class="keyword">for</span>(Message message : list)&#123;</span><br><span class="line">            <span class="keyword">if</span>(message.getStatus().intValue() == <span class="number">1</span>)&#123;</span><br><span class="line">                <span class="built_in">this</span>.messageDAO.updateMessageState(message.getId(), <span class="number">2</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> list;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建<code>UserController</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@CrossOrigin</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;user&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserController</span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MessageService messageService;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@GetMapping</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;Map&lt;String, Object&gt;&gt; <span class="title function_">queryUserList</span><span class="params">(<span class="meta">@RequestParam(&quot;fromId&quot;)</span> Long fromId)</span>&#123;</span><br><span class="line">        List&lt;Map&lt;String, Object&gt;&gt; result = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span>(Map.Entry&lt;Long, User&gt; userEntry : UserData.USER_MAP.entrySet())&#123;</span><br><span class="line">            Map&lt;String,Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;()</span><br><span class="line">            <span class="comment">//获得对应的值</span></span><br><span class="line">            result.add(map);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="Netty"><a href="#Netty" class="headerlink" title="Netty +"></a>Netty +</h2>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2024/01/18/Note/%E5%90%8E%E7%AB%AF/Java/%E9%A1%B9%E7%9B%AE/%E5%8D%B3%E6%97%B6%E9%80%9A%E8%AE%AF/" data-id="clrj8qr6700aov4uw85yifvn6" data-title="聊天模块" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E6%A8%A1%E5%9D%97/" rel="tag">模块</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-Note/后端/Java/项目/头条" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2024/01/18/Note/%E5%90%8E%E7%AB%AF/Java/%E9%A1%B9%E7%9B%AE/%E5%A4%B4%E6%9D%A1/" class="article-date">
  <time class="dt-published" datetime="2024-01-18T13:12:24.708Z" itemprop="datePublished">2024-01-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="项目介绍"><a href="#项目介绍" class="headerlink" title="项目介绍"></a>项目介绍</h2><ul>
<li>模块<ul>
<li>公共模块<ul>
<li>全局异常处理</li>
<li>全局返回值处理</li>
</ul>
</li>
<li>远程调用模块</li>
<li>网关模块</li>
<li>测试模块</li>
<li>工具模块</li>
<li>类模块<ul>
<li>公共类</li>
<li>用户（实体类）</li>
</ul>
</li>
<li>服务模块<ul>
<li>文章模块：文章管理</li>
<li>用户模块：用户管理</li>
</ul>
</li>
</ul>
</li>
<li>平台<ul>
<li>用户移动端：内容查看、社交、登陆注册、个人中心、系统设置</li>
<li>自媒体端：内容管理、粉丝管理、评价管理、权限管理、个人看板、私信、素材、 设置</li>
<li>管理平台：内容管理、用户管理、数据统计、标签管理、公告管理、系统管理</li>
<li>支撑系统：爬虫、广告、推荐、计算、知识</li>
</ul>
</li>
<li>技术栈<ul>
<li>Nginx + Gateway + Nacos + MySQL + MongoDB + HBase + Kafka + Redis + ZK + XXL-Job + ES + Docker + Seata + Jenkins</li>
</ul>
</li>
<li>表<ul>
<li>用户相关<ul>
<li>用户表、用户粉丝表、用户关注表、用户认证表</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="点赞模块"><a href="#点赞模块" class="headerlink" title="点赞模块"></a>点赞模块</h2><h3 id="Redis实现"><a href="#Redis实现" class="headerlink" title="Redis实现"></a>Redis实现</h3><h4 id="一人点一次"><a href="#一人点一次" class="headerlink" title="一人点一次"></a>一人点一次</h4><ul>
<li><p>给Blog类中添加一个isLike字段，这个字段在数据库中不存在，标识当前用户是否点赞</p>
<ul>
<li>需要添加@TableField(exist &#x3D; false)</li>
</ul>
</li>
<li><p>利用redis的set集合实现</p>
</li>
<li><p>在首页的博客分页查询和根据id查询的时候判断当前用户是否点过赞，赋值给isLike字段</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">likeBlog</span><span class="params">(Long id)</span>&#123;</span><br><span class="line">    <span class="comment">//获取登录用户</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> <span class="string">&quot;blog:liked:&quot;</span> + id;</span><br><span class="line">    <span class="comment">//判断当前登录用户是否点赞</span></span><br><span class="line">    <span class="type">Double</span> <span class="variable">score</span> </span><br><span class="line">        <span class="operator">=</span> stringRedisTemplate.opsForZSet.score(key, userId.toString());</span><br><span class="line">    <span class="comment">//如果未点赞，可以点赞</span></span><br><span class="line">    <span class="keyword">if</span>(score == <span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="comment">//数据库点赞数+1</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> update().setSql(<span class="string">&quot;like = like + 1&quot;</span>).eq(<span class="string">&quot;id&quot;</span>, id).update();</span><br><span class="line">    	<span class="comment">//保存用户到redis集合中</span></span><br><span class="line">        <span class="keyword">if</span>(success)&#123;</span><br><span class="line">            stringRedisTemplate.opsForZSet.add(key, userId.toString(), System.currentTimeMillis());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="comment">//如果已点赞，取消点赞</span></span><br><span class="line">        <span class="comment">//数据库点赞数-1</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> update().setSql(<span class="string">&quot;like = like - 1&quot;</span>).eq(<span class="string">&quot;id&quot;</span>, id).update();</span><br><span class="line">        <span class="comment">//把用户从redis集合中删除</span></span><br><span class="line">        <span class="keyword">if</span>(success)&#123;</span><br><span class="line">            stringRedisTemplate.opsForZSet.add(key, userId.toString());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; 	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="点赞排行榜"><a href="#点赞排行榜" class="headerlink" title="点赞排行榜"></a>点赞排行榜</h4><ul>
<li>先点赞的排在前面，需要修改之前校验一人一赞的数据类型，改为SortedSet</li>
<li>实现blogService.queryBlogLikes(Long id) 方法</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> List&lt;UserDTO&gt; <span class="title function_">queryBlogLikes</span><span class="params">(Long id)</span>&#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> <span class="string">&quot;blog:liked:&quot;</span> + id;</span><br><span class="line">    <span class="comment">//查询点赞前5名的用户</span></span><br><span class="line">    Set&lt;String&gt; top5 = stringRedisTemplate.opsForZSet.range(key, <span class="number">0</span>, <span class="number">4</span>);</span><br><span class="line">    <span class="comment">//如果为空返回空集合</span></span><br><span class="line">    <span class="keyword">if</span>(top5 == <span class="literal">null</span> || top5.isEmpty()) <span class="keyword">return</span> Collections.emptyList();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//解析出用户id</span></span><br><span class="line">    List&lt;Long&gt; ids =  top5.stream().map(Long::valueOf).collect(Collections.toList());</span><br><span class="line">    <span class="type">String</span> <span class="variable">idStr</span> <span class="operator">=</span> StrUtil.join(<span class="string">&quot;,&quot;</span>, ids);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//根据id查询用户</span></span><br><span class="line">    List&lt;UserDTO&gt; userDTO5 = userService.query()</span><br><span class="line">        <span class="comment">//为了使查询的数据按照我们想要的顺序</span></span><br><span class="line">        .in(<span class="string">&quot;id&quot;</span>, id).last(<span class="string">&quot;ORDER BY FIELD(id,&quot;</span>+idStr+<span class="string">&quot;)&quot;</span>).list()</span><br><span class="line">        .stream().map(user -&gt; BeanUtil.copyProperties(user, UserDTO.calss))</span><br><span class="line">        .collect(Collections.toList());</span><br><span class="line">    <span class="keyword">return</span> userDTO5;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="关注模块"><a href="#关注模块" class="headerlink" title="关注模块"></a>关注模块</h2><h3 id="关注和取关"><a href="#关注和取关" class="headerlink" title="关注和取关"></a>关注和取关</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">follow</span><span class="params">(Long followUserId, Boolean isFollow)</span>&#123;</span><br><span class="line">    <span class="comment">//获取登录用户</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//判断是关注还是取关</span></span><br><span class="line">    <span class="keyword">if</span>(isFollow)&#123;</span><br><span class="line">        <span class="comment">//设置关注信息，保存到数据库</span></span><br><span class="line">    	<span class="type">Follow</span> <span class="variable">follow</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Follow</span>();</span><br><span class="line">    	follow.setUserId(userId);</span><br><span class="line">        follow.setFollowUserId(followUserId);</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">isSuccess</span> <span class="operator">=</span> save(follow);</span><br><span class="line">        <span class="comment">//为了后面的共同关注功能，需要将关注信息保存到redis中</span></span><br><span class="line">        <span class="keyword">if</span>(isSuccess)&#123;</span><br><span class="line">            <span class="comment">//存入userId 和 followUserId</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> <span class="string">&quot;follows:&quot;</span> + userId;</span><br><span class="line">            stringRedisTemplate.opsForSet().add(key, followUserId.toString());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="comment">//取关</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">isSuccess</span> <span class="operator">=</span> remove(<span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;&gt;()</span><br><span class="line">               .eq(<span class="string">&quot;user_id&quot;</span>, userId).eq(<span class="string">&quot;follow_user_id&quot;</span>, followUserId));</span><br><span class="line">        <span class="comment">//删除redis中的关注信息</span></span><br><span class="line">        <span class="keyword">if</span>(isSuccess)&#123;</span><br><span class="line">        	stringRedisTemplate.opsForSet().remove(key, followUserId.toString());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="查看是否关注"><a href="#查看是否关注" class="headerlink" title="查看是否关注"></a>查看是否关注</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isFollow</span><span class="params">(Long followUserId)</span>&#123;</span><br><span class="line">    <span class="comment">//获取登录用户</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId();</span><br><span class="line">    <span class="comment">//c数据库是否存在关联数据</span></span><br><span class="line">    <span class="type">Integer</span> <span class="variable">count</span> <span class="operator">=</span> query().eq(<span class="string">&quot;user_id&quot;</span>, userId)</span><br><span class="line">        .eq(<span class="string">&quot;follow_user_id&quot;</span>, followUserId)).count();</span><br><span class="line">    <span class="keyword">return</span> count &gt; <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="共同关注"><a href="#共同关注" class="headerlink" title="共同关注"></a>共同关注</h2><ul>
<li>需要在用户关注的时候将用户的关注信息保存到redis中，用Set结构保存，可以查交集</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> List&lt;UserDTO&gt; <span class="title function_">followCommons</span><span class="params">(LOng id)</span>&#123;</span><br><span class="line">    <span class="comment">//获取登录用户id</span></span><br><span class="line">	<span class="type">Long</span> <span class="variable">id</span> <span class="operator">=</span> UserHolder.getUser().getId();  </span><br><span class="line">    <span class="comment">//当前登录用户在redis中的key值</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">key1</span> <span class="operator">=</span> <span class="string">&quot;follows:&quot;</span> + userId;</span><br><span class="line">    <span class="comment">//查看的用户在redis中的key值</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">key2</span> <span class="operator">=</span> <span class="string">&quot;follows:&quot;</span> + id;</span><br><span class="line">    <span class="comment">//求共同关注即交集</span></span><br><span class="line">    Set&lt;String&gt; intersect = stringRedisTemplate.opsForSet().intersect(key1,key2);</span><br><span class="line">    <span class="comment">//判断是否有交集,无交集返回空list</span></span><br><span class="line">    <span class="keyword">if</span>(intersect == <span class="literal">null</span> || intersect.isEmpty()) <span class="keyword">return</span> Collections.emptyList();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//解析id集合</span></span><br><span class="line">    List&lt;Long&gt; ids =  intersect.stream()</span><br><span class="line">        .map(Long::valueOf).collect(Collections.toList());</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//根据id查询用户</span></span><br><span class="line">    List&lt;UserDTO&gt; users = userService.listByIds(ids)</span><br><span class="line">        .stream().map(user -&gt; BeanUtil.copyProperties(user, UserDTO.calss))</span><br><span class="line">        .collect(Collections.toList());</span><br><span class="line">    <span class="keyword">return</span> users;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="推送模块"><a href="#推送模块" class="headerlink" title="推送模块"></a>推送模块</h2><h3 id="推模式"><a href="#推模式" class="headerlink" title="推模式"></a>推模式</h3><ul>
<li><p>给用户创建一个收件箱，用户发送笔记时推送到所有粉丝的收件箱，收件箱要满足可以根据时间戳排序，使用redis实现</p>
</li>
<li><p>用户查询收件箱时实现分页查询 （SortedSet）</p>
</li>
<li><p>在用户发布笔记时将博客id存入redis</p>
</li>
<li><p>推送笔记到粉丝邮箱</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//查询笔记作者的所有粉丝</span></span><br><span class="line">    List&lt;Follow&gt; follows = followService.query().eq(<span class="string">&quot;follow_user_id&quot;</span>,user.getId()).list();</span><br><span class="line"><span class="comment">//推送笔记id给所有粉丝</span></span><br><span class="line">    <span class="keyword">for</span>(Follow follow : follows)&#123;</span><br><span class="line">        <span class="comment">//获取粉丝id</span></span><br><span class="line">        <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> follow.getUserId();</span><br><span class="line">        <span class="comment">//推送</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> <span class="string">&quot;feed:&quot;</span> + userId; </span><br><span class="line">        stringRedisTemplate.opsForZSet().add(key, blog.getId().toString(), System.currentTimeMillis());</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>粉丝邮箱读取笔记</p>
<ul>
<li><p>需要先创建滚动分页的dto类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ScoreResult</span>&#123;</span><br><span class="line">    <span class="comment">//查询的博客</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;?&gt; list;</span><br><span class="line">    <span class="comment">//上一次查询的时间，用于下一次查询作为最小值</span></span><br><span class="line">    <span class="keyword">private</span> Long minTime;</span><br><span class="line">    <span class="keyword">private</span> Integer offset;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>读取收件箱封装到ScoreResult中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> ScoreResult <span class="title function_">queryBlogOfFollow</span><span class="params">(Long max, Integer offset)</span>&#123;</span><br><span class="line">    <span class="comment">//获取当前用户</span></span><br><span class="line">    <span class="type">Long</span> <span class="variable">userId</span> <span class="operator">=</span> UserHolder.getUser().getId(); </span><br><span class="line">    <span class="comment">//查询收件箱</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> <span class="string">&quot;feed:&quot;</span> + userId;</span><br><span class="line">    Set&lt;ZSetOperations.TypedTuple&lt;String&gt;&gt; typedTuples = stringRedisTemplate</span><br><span class="line">        <span class="comment">//offset：跳过最大值的个数，0则包含</span></span><br><span class="line">        .opsForZset().reverseRangeByScoreWithScores(key, <span class="number">0</span>, max, offset, <span class="number">2</span>);</span><br><span class="line">    <span class="keyword">if</span>(typedTuples == <span class="literal">null</span> || typedTuples.isEmpty()) <span class="keyword">return</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//解析数据</span></span><br><span class="line">    List&lt;<span class="type">long</span>&gt; ids = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(typedTuples.size());</span><br><span class="line">    <span class="type">long</span> <span class="variable">minTime</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> <span class="variable">os</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">for</span>(ZSetOperations.TypedTuple&lt;String&gt; tuple : typedTuples)&#123;</span><br><span class="line">        <span class="comment">//获取id</span></span><br><span class="line">        ids.add(Long.valueOf(tuple.getValue()));</span><br><span class="line">        <span class="comment">//获取分数（时间戳）</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">time</span> <span class="operator">=</span> tuple.getScore().longValue();</span><br><span class="line">        <span class="keyword">if</span>(time == minTime)&#123;</span><br><span class="line">            os++;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            minTime = time;</span><br><span class="line">            os = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//根据id查询blog</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">idStr</span> <span class="operator">=</span> StrUtil.join(<span class="string">&quot;,&quot;</span>, ids);</span><br><span class="line">    List&lt;Blog&gt; blogs = query().in(<span class="string">&quot;id&quot;</span>, ids).last(<span class="string">&quot;ORDER BY FIELD(id,&quot;</span>+idStr+<span class="string">&quot;)&quot;</span>).list();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span>(Blog blog : blogs)&#123;</span><br><span class="line">        <span class="comment">//查询blog有关的用户</span></span><br><span class="line">        queryBlogUser(blog);</span><br><span class="line">        <span class="comment">//查询Blog是否被点赞</span></span><br><span class="line">        isBlogLiked(blog);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//返回</span></span><br><span class="line">    <span class="type">ScrollResult</span> <span class="variable">r</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ScrollResult</span>();</span><br><span class="line">    r.setList(blogs);</span><br><span class="line">    r.setOffset(os);</span><br><span class="line">    r.setMinTime(minTime);</span><br><span class="line">    <span class="keyword">return</span> r;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<h3 id="拉模式"><a href="#拉模式" class="headerlink" title="拉模式"></a>拉模式</h3><h3 id="推拉结合"><a href="#推拉结合" class="headerlink" title="推拉结合"></a>推拉结合</h3><h2 id="签到模块"><a href="#签到模块" class="headerlink" title="签到模块"></a>签到模块</h2><h3 id="使用Reids的BitMap实现"><a href="#使用Reids的BitMap实现" class="headerlink" title="使用Reids的BitMap实现"></a>使用Reids的BitMap实现</h3><ul>
<li><p>签到</p>
<ul>
<li><code>stringRedisTemplate.opsForValue.setBit(key, dayOfMonth - 1, true)</code></li>
</ul>
</li>
<li><p>统计</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Long&gt; result = stringRedisTemplate.opsForValue().bitField(</span><br><span class="line">	key, BitFieldSubCommands.create()</span><br><span class="line">    .get(BitFieldSubCommands.BitFieldType.unsigned(dayOfMonth))</span><br><span class="line">    .valueAt(<span class="number">0</span>)</span><br><span class="line">);</span><br></pre></td></tr></table></figure></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2024/01/18/Note/%E5%90%8E%E7%AB%AF/Java/%E9%A1%B9%E7%9B%AE/%E5%A4%B4%E6%9D%A1/" data-id="clrj8qr6700aqv4uw8muacxzt" data-title="" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-Note/后端/Java/项目/中台" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2024/01/18/Note/%E5%90%8E%E7%AB%AF/Java/%E9%A1%B9%E7%9B%AE/%E4%B8%AD%E5%8F%B0/" class="article-date">
  <time class="dt-published" datetime="2024-01-18T13:12:24.707Z" itemprop="datePublished">2024-01-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        
      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2024/01/18/Note/%E5%90%8E%E7%AB%AF/Java/%E9%A1%B9%E7%9B%AE/%E4%B8%AD%E5%8F%B0/" data-id="clrj8qr610098v4uwh5f18hmt" data-title="" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-Note/后端/Java/源码/MySQL" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2024/01/18/Note/%E5%90%8E%E7%AB%AF/Java/%E6%BA%90%E7%A0%81/MySQL/" class="article-date">
  <time class="dt-published" datetime="2024-01-18T13:12:24.704Z" itemprop="datePublished">2024-01-18</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%BA%90%E7%A0%81/">源码</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2024/01/18/Note/%E5%90%8E%E7%AB%AF/Java/%E6%BA%90%E7%A0%81/MySQL/">MySQL源码</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="执行流程"><a href="#执行流程" class="headerlink" title="执行流程"></a>执行流程</h2><ul>
<li>首先客户端发起sql查询</li>
<li>sql到达服务器先经过连接器，进行身份、权限等校验</li>
<li>然后再经过分析器，进行词法分析和语法分析<ul>
<li>mysql8.0之前会先去查询缓存中找</li>
</ul>
</li>
<li>在经过优化器，以优化器认为最优的执行方案去执行</li>
<li>然后交给执行器，会先进行权限校验，权限通过就会去调用存储引擎的接口，进行具体的执行</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2024/01/18/Note/%E5%90%8E%E7%AB%AF/Java/%E6%BA%90%E7%A0%81/MySQL/" data-id="clrj8qr5v007kv4uw139y8i8w" data-title="MySQL源码" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/code/" rel="tag">code</a></li></ul>

    </footer>
  </div>
  
</article>



  


  <nav id="page-nav">
    
    <a class="extend prev" rel="prev" href="/page/3/">&laquo; Prev</a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="/page/5/">5</a><a class="page-number" href="/page/6/">6</a><span class="space">&hellip;</span><a class="page-number" href="/page/12/">12</a><a class="extend next" rel="next" href="/page/5/">Next &raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Go/">Go</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java%E4%B8%AD%E9%97%B4%E4%BB%B6/">Java中间件</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java%E5%9F%BA%E7%A1%80/">Java基础</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java%E6%A1%86%E6%9E%B6/">Java框架</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Web3/">Web3</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E4%BA%BA%E5%B7%A5%E6%99%BA%E8%83%BD/">人工智能</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%8A%9B%E6%89%A3/">力扣</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%BC%80%E5%8F%91/">开发</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/">数据库</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%A8%A1%E5%9D%97/">模块</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%BA%90%E7%A0%81/">源码</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%AE%97%E6%B3%95%E9%A2%98/">算法题</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%9F%A5%E8%AF%86/">计算机知识</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E9%9D%A2%E8%AF%95/">面试</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/code/" rel="tag">code</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/defi/" rel="tag">defi</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/go/" rel="tag">go</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/language/" rel="tag">language</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/solidity/" rel="tag">solidity</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/web3/" rel="tag">web3</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E4%B8%AD%E9%97%B4%E4%BB%B6/" rel="tag">中间件</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E4%BB%A3%E7%A0%81%E9%9A%8F%E6%83%B3%E5%BD%95/" rel="tag">代码随想录</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E4%BC%98%E5%8C%96/" rel="tag">优化</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%89%91%E6%8C%87offer/" rel="tag">剑指offer</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%8A%9B%E6%89%A3%E7%83%AD%E9%A2%98100/" rel="tag">力扣热题100</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%8A%9B%E6%89%A3%E9%A2%98/" rel="tag">力扣题</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%8E%9F%E7%90%86/" rel="tag">原理</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%9F%BA%E7%A1%80/" rel="tag">基础</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%B7%A5%E5%85%B7/" rel="tag">工具</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%B7%A6%E7%A5%9E/" rel="tag">左神</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%BA%93/" rel="tag">库</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%BC%80%E5%8F%91/" rel="tag">开发</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%8A%80%E5%B7%A7/" rel="tag">技巧</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/" rel="tag">操作系统</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/" rel="tag">数据库</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/" rel="tag">数据结构</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E5%92%8C%E7%AE%97%E6%B3%95/" rel="tag">数据结构和算法</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%A1%86%E6%9E%B6/" rel="tag">框架</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%A8%A1%E5%9D%97/" rel="tag">模块</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%A8%A1%E5%9E%8B/" rel="tag">模型</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%BA%90%E7%A0%81/" rel="tag">源码</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%90%86%E5%BF%B5/" rel="tag">理念</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%AE%97%E6%B3%95/" rel="tag">算法</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%B3%BB%E7%BB%9Fan-quan/" rel="tag">系统an&#39;quan</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/" rel="tag">系统设计</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%BD%91%E7%BB%9C/" rel="tag">网络</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%A7%84%E8%8C%83/" rel="tag">规范</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%97%AE%E9%A2%98/" rel="tag">问题</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%9B%86%E6%88%90/" rel="tag">集成</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%9B%86%E7%BE%A4/" rel="tag">集群</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%9D%A2%E8%AF%95/" rel="tag">面试</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/code/" style="font-size: 10px;">code</a> <a href="/tags/defi/" style="font-size: 10px;">defi</a> <a href="/tags/go/" style="font-size: 10px;">go</a> <a href="/tags/language/" style="font-size: 10px;">language</a> <a href="/tags/solidity/" style="font-size: 10px;">solidity</a> <a href="/tags/web3/" style="font-size: 12.86px;">web3</a> <a href="/tags/%E4%B8%AD%E9%97%B4%E4%BB%B6/" style="font-size: 20px;">中间件</a> <a href="/tags/%E4%BB%A3%E7%A0%81%E9%9A%8F%E6%83%B3%E5%BD%95/" style="font-size: 10px;">代码随想录</a> <a href="/tags/%E4%BC%98%E5%8C%96/" style="font-size: 10px;">优化</a> <a href="/tags/%E5%89%91%E6%8C%87offer/" style="font-size: 10px;">剑指offer</a> <a href="/tags/%E5%8A%9B%E6%89%A3%E7%83%AD%E9%A2%98100/" style="font-size: 10px;">力扣热题100</a> <a href="/tags/%E5%8A%9B%E6%89%A3%E9%A2%98/" style="font-size: 10px;">力扣题</a> <a href="/tags/%E5%8E%9F%E7%90%86/" style="font-size: 10px;">原理</a> <a href="/tags/%E5%9F%BA%E7%A1%80/" style="font-size: 15.71px;">基础</a> <a href="/tags/%E5%B7%A5%E5%85%B7/" style="font-size: 10px;">工具</a> <a href="/tags/%E5%B7%A6%E7%A5%9E/" style="font-size: 10px;">左神</a> <a href="/tags/%E5%BA%93/" style="font-size: 10px;">库</a> <a href="/tags/%E5%BC%80%E5%8F%91/" style="font-size: 18.57px;">开发</a> <a href="/tags/%E6%8A%80%E5%B7%A7/" style="font-size: 11.43px;">技巧</a> <a href="/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/" style="font-size: 10px;">操作系统</a> <a href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/" style="font-size: 12.86px;">数据库</a> <a href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/" style="font-size: 11.43px;">数据结构</a> <a href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E5%92%8C%E7%AE%97%E6%B3%95/" style="font-size: 17.14px;">数据结构和算法</a> <a href="/tags/%E6%A1%86%E6%9E%B6/" style="font-size: 14.29px;">框架</a> <a href="/tags/%E6%A8%A1%E5%9D%97/" style="font-size: 15.71px;">模块</a> <a href="/tags/%E6%A8%A1%E5%9E%8B/" style="font-size: 11.43px;">模型</a> <a href="/tags/%E6%BA%90%E7%A0%81/" style="font-size: 12.86px;">源码</a> <a href="/tags/%E7%90%86%E5%BF%B5/" style="font-size: 14.29px;">理念</a> <a href="/tags/%E7%AE%97%E6%B3%95/" style="font-size: 10px;">算法</a> <a href="/tags/%E7%B3%BB%E7%BB%9Fan-quan/" style="font-size: 10px;">系统an'quan</a> <a href="/tags/%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/" style="font-size: 10px;">系统设计</a> <a href="/tags/%E7%BD%91%E7%BB%9C/" style="font-size: 10px;">网络</a> <a href="/tags/%E8%A7%84%E8%8C%83/" style="font-size: 10px;">规范</a> <a href="/tags/%E9%97%AE%E9%A2%98/" style="font-size: 10px;">问题</a> <a href="/tags/%E9%9B%86%E6%88%90/" style="font-size: 10px;">集成</a> <a href="/tags/%E9%9B%86%E7%BE%A4/" style="font-size: 10px;">集群</a> <a href="/tags/%E9%9D%A2%E8%AF%95/" style="font-size: 12.86px;">面试</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/01/">January 2024</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2024/01/18/Note/%E9%9D%A2%E8%AF%95/%E7%AE%80%E5%8E%86/">(no title)</a>
          </li>
        
          <li>
            <a href="/2024/01/18/Note/%E9%9D%A2%E8%AF%95/%E8%8B%B1%E8%AF%AD/">(no title)</a>
          </li>
        
          <li>
            <a href="/2024/01/18/Note/%E9%9D%A2%E8%AF%95/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/">计算机基础</a>
          </li>
        
          <li>
            <a href="/2024/01/18/Note/%E9%9D%A2%E8%AF%95/%E5%9C%BA%E6%99%AF%E9%A2%98/">场景题</a>
          </li>
        
          <li>
            <a href="/2024/01/18/Note/%E9%9D%A2%E8%AF%95/%E6%95%B0%E6%8D%AE%E5%BA%93/">(no title)</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2024 JianHong<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.6.4.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>