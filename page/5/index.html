<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>JianHong</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="Note">
<meta property="og:type" content="website">
<meta property="og:title" content="JianHong">
<meta property="og:url" content="http://example.com/page/5/index.html">
<meta property="og:site_name" content="JianHong">
<meta property="og:description" content="Note">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="JianHong">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="JianHong" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
  
<meta name="generator" content="Hexo 7.0.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">JianHong</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"><span class="fa fa-bars"></span></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
        
          <a class="nav-icon" href="/atom.xml" title="RSS Feed"><span class="fa fa-rss"></span></a>
        
        <a class="nav-icon nav-search-btn" title="Search"><span class="fa fa-search"></span></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main">
  
    <article id="post-Note/后端/Java/源码/Mybatis2" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2024/01/18/Note/%E5%90%8E%E7%AB%AF/Java/%E6%BA%90%E7%A0%81/Mybatis2/" class="article-date">
  <time class="dt-published" datetime="2024-01-18T13:12:24.704Z" itemprop="datePublished">2024-01-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="架构"><a href="#架构" class="headerlink" title="架构"></a>架构</h2><p><img src="/image-20230317103336946.png" alt="image-20230317103336946"></p>
<h2 id="组件及其调用关系"><a href="#组件及其调用关系" class="headerlink" title="组件及其调用关系"></a>组件及其调用关系</h2><p><img src="/image-20230317115152145.png" alt="image-20230317115152145"></p>
<h2 id="目录结构"><a href="#目录结构" class="headerlink" title="目录结构"></a>目录结构</h2><p><img src="/image-20230317115410587.png" alt="image-20230317115410587"></p>
<h2 id="解析配置文件"><a href="#解析配置文件" class="headerlink" title="解析配置文件"></a>解析配置文件</h2><h3 id="读取xml文件流"><a href="#读取xml文件流" class="headerlink" title="读取xml文件流"></a>读取xml文件流</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> InputStream <span class="title function_">getResourceAsStream</span><span class="params">(ClassLoader loader, String resource)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="type">InputStream</span> <span class="variable">in</span> <span class="operator">=</span> classLoaderWrapper.getResourceAsStream(resource, loader);</span><br><span class="line">    <span class="keyword">if</span> (in == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IOException</span>(<span class="string">&quot;Could not find resource &quot;</span> + resource);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> in;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> InputStream <span class="title function_">getResourceAsStream</span><span class="params">(String resource, ClassLoader classLoader)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.getResourceAsStream(resource, <span class="built_in">this</span>.getClassLoaders(classLoader));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">ClassLoader[] getClassLoaders(ClassLoader classLoader) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ClassLoader</span>[]&#123;</span><br><span class="line">        classLoader, </span><br><span class="line">        <span class="built_in">this</span>.defaultClassLoader, </span><br><span class="line">        Thread.currentThread().getContextClassLoader(), </span><br><span class="line">        <span class="built_in">this</span>.getClass().getClassLoader(), </span><br><span class="line">        <span class="built_in">this</span>.systemClassLoader&#125;;</span><br><span class="line">&#125;</span><br><span class="line">InputStream <span class="title function_">getResourceAsStream</span><span class="params">(String resource, ClassLoader[] classLoader)</span> &#123;</span><br><span class="line">    ClassLoader[] var3 = classLoader;</span><br><span class="line">    <span class="type">int</span> <span class="variable">var4</span> <span class="operator">=</span> classLoader.length;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">var5</span> <span class="operator">=</span> <span class="number">0</span>; var5 &lt; var4; ++var5) &#123;</span><br><span class="line">        <span class="type">ClassLoader</span> <span class="variable">cl</span> <span class="operator">=</span> var3[var5];</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> != cl) &#123;</span><br><span class="line">            <span class="type">InputStream</span> <span class="variable">returnValue</span> <span class="operator">=</span> cl.getResourceAsStream(resource);</span><br><span class="line">            <span class="comment">//重试，尝试+&quot;/&quot;能不能获取到</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="literal">null</span> == returnValue) returnValue = cl.getResourceAsStream(<span class="string">&quot;/&quot;</span> + resource);</span><br><span class="line">            <span class="keyword">if</span> (<span class="literal">null</span> != returnValue) <span class="keyword">return</span> returnValue;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="构建SqlSessionFactory"><a href="#构建SqlSessionFactory" class="headerlink" title="构建SqlSessionFactory"></a>构建SqlSessionFactory</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">SqlSessionFactory</span> <span class="variable">sqlSessionFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SqlSessionFactoryBuilder</span>().build(inputStream);</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> SqlSessionFactory <span class="title function_">build</span><span class="params">(InputStream inputStream, String environment, Properties properties)</span> &#123;</span><br><span class="line">    SqlSessionFactory var5;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="type">XMLConfigBuilder</span> <span class="variable">parser</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XMLConfigBuilder</span>(inputStream, environment, properties);</span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        var5 = <span class="built_in">this</span>.build(parser.parse());</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception var14) &#123;</span><br><span class="line">        <span class="keyword">throw</span> ExceptionFactory.wrapException(<span class="string">&quot;Error building SqlSession.&quot;</span>, var14);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        ErrorContext.instance().reset();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            inputStream.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException var13) &#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> var5;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">XMLConfigBuilder</span><span class="params">(InputStream inputStream, String environment, Properties props)</span> &#123;</span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="built_in">this</span>(<span class="keyword">new</span> <span class="title class_">XPathParser</span>(inputStream, <span class="literal">true</span>, props, <span class="keyword">new</span> <span class="title class_">XMLMapperEntityResolver</span>()), environment, props);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">private</span> <span class="title function_">XMLConfigBuilder</span><span class="params">(XPathParser parser, String environment, Properties props)</span> &#123;</span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="built_in">super</span>(<span class="keyword">new</span> <span class="title class_">Configuration</span>());</span><br><span class="line">    <span class="built_in">this</span>.localReflectorFactory = <span class="keyword">new</span> <span class="title class_">DefaultReflectorFactory</span>();</span><br><span class="line">    ErrorContext.instance().resource(<span class="string">&quot;SQL Mapper Configuration&quot;</span>);</span><br><span class="line">    <span class="built_in">this</span>.configuration.setVariables(props);</span><br><span class="line">    <span class="built_in">this</span>.parsed = <span class="literal">false</span>;</span><br><span class="line">    <span class="built_in">this</span>.environment = environment;</span><br><span class="line">    <span class="built_in">this</span>.parser = parser;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Configuration <span class="title function_">parse</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">//默认为false</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.parsed) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BuilderException</span>(<span class="string">&quot;Each XMLConfigBuilder can only be used once.&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//这个解析方法只能调用一次，即配置文件只能解析一次</span></span><br><span class="line">        <span class="built_in">this</span>.parsed = <span class="literal">true</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">this</span>.parseConfiguration(<span class="built_in">this</span>.parser.evalNode(<span class="string">&quot;/configuration&quot;</span>));</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.configuration;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    parser.evalNode 解析configuration节点及其子节点，封装到一个XNode对象中</span></span><br><span class="line"><span class="comment">    parseConfiguration 解析XNode对象（properties、settings、environments、mapper等等）</span></span><br><span class="line"><span class="comment">    1.将解析出的内容设置到configuration中</span></span><br><span class="line"><span class="comment">    2.解析mapper</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">parseConfiguration</span><span class="params">(XNode root)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.propertiesElement(root.evalNode(<span class="string">&quot;properties&quot;</span>));</span><br><span class="line">        <span class="type">Properties</span> <span class="variable">settings</span> <span class="operator">=</span> <span class="built_in">this</span>.settingsAsProperties(root.evalNode(<span class="string">&quot;settings&quot;</span>));</span><br><span class="line">        <span class="built_in">this</span>.loadCustomVfs(settings);</span><br><span class="line">        <span class="built_in">this</span>.loadCustomLogImpl(settings);</span><br><span class="line">        <span class="built_in">this</span>.typeAliasesElement(root.evalNode(<span class="string">&quot;typeAliases&quot;</span>));</span><br><span class="line">        <span class="built_in">this</span>.pluginElement(root.evalNode(<span class="string">&quot;plugins&quot;</span>));</span><br><span class="line">        <span class="built_in">this</span>.objectFactoryElement(root.evalNode(<span class="string">&quot;objectFactory&quot;</span>));</span><br><span class="line">        <span class="built_in">this</span>.objectWrapperFactoryElement(root.evalNode(<span class="string">&quot;objectWrapperFactory&quot;</span>));</span><br><span class="line">        <span class="built_in">this</span>.reflectorFactoryElement(root.evalNode(<span class="string">&quot;reflectorFactory&quot;</span>));</span><br><span class="line">        <span class="built_in">this</span>.settingsElement(settings);</span><br><span class="line">        <span class="built_in">this</span>.environmentsElement(root.evalNode(<span class="string">&quot;environments&quot;</span>));</span><br><span class="line">        <span class="built_in">this</span>.databaseIdProviderElement(root.evalNode(<span class="string">&quot;databaseIdProvider&quot;</span>));</span><br><span class="line">        <span class="built_in">this</span>.typeHandlerElement(root.evalNode(<span class="string">&quot;typeHandlers&quot;</span>));</span><br><span class="line">        <span class="comment">//解析mapper</span></span><br><span class="line">        <span class="built_in">this</span>.mapperElement(root.evalNode(<span class="string">&quot;mappers&quot;</span>));</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception var3) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BuilderException</span>(<span class="string">&quot;Error parsing SQL Mapper Configuration. Cause: &quot;</span> + var3, var3);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">mapperElement</span><span class="params">(XNode parent)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="comment">//获取&lt;mappers&gt;的子节点，解析属性</span></span><br><span class="line">    <span class="comment">//获取子节点中的 url/resources ，转化为字节流，交给 XMLMapperBuilder 解析</span></span><br><span class="line">    <span class="comment">//调用XMLMapperBuilder.parse 方法</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//根据传入的字节流，构建Document对象</span></span><br><span class="line"><span class="keyword">private</span> <span class="title function_">XMLMapperBuilder</span><span class="params">(XPathParser parser, Configuration configuration, String resource, Map&lt;String, XNode&gt; sqlFragments)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>(configuration);</span><br><span class="line">    <span class="built_in">this</span>.builderAssistant = <span class="keyword">new</span> <span class="title class_">MapperBuilderAssistant</span>(configuration, resource);</span><br><span class="line">    <span class="built_in">this</span>.parser = parser;</span><br><span class="line">    <span class="built_in">this</span>.sqlFragments = sqlFragments;</span><br><span class="line">    <span class="built_in">this</span>.resource = resource;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">parse</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">this</span>.configuration.isResourceLoaded(<span class="built_in">this</span>.resource)) &#123;</span><br><span class="line">        <span class="comment">//获取mapper的命名空间，解析（cache、sql、resultmap、crud）</span></span><br><span class="line">        <span class="built_in">this</span>.configurationElement(<span class="built_in">this</span>.parser.evalNode(<span class="string">&quot;/mapper&quot;</span>));</span><br><span class="line">        <span class="built_in">this</span>.configuration.addLoadedResource(<span class="built_in">this</span>.resource);</span><br><span class="line">        <span class="built_in">this</span>.bindMapperForNamespace();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">this</span>.parsePendingResultMaps();</span><br><span class="line">    <span class="built_in">this</span>.parsePendingCacheRefs();</span><br><span class="line">    <span class="built_in">this</span>.parsePendingStatements();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//解析crud标签</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">buildStatementFromContext</span><span class="params">(List&lt;XNode&gt; list, String requiredDatabaseId)</span> &#123;</span><br><span class="line">    <span class="type">Iterator</span> <span class="variable">var3</span> <span class="operator">=</span> list.iterator();</span><br><span class="line">    <span class="keyword">while</span>(var3.hasNext()) &#123;</span><br><span class="line">        <span class="type">XNode</span> <span class="variable">context</span> <span class="operator">=</span> (XNode)var3.next();</span><br><span class="line">        <span class="type">XMLStatementBuilder</span> <span class="variable">statementParser</span> <span class="operator">=</span> </span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">XMLStatementBuilder</span>(<span class="built_in">this</span>.configuration, <span class="built_in">this</span>.builderAssistant, context, requiredDatabaseId);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//解析，封装</span></span><br><span class="line">            statementParser.parseStatementNode();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IncompleteElementException var7) &#123;</span><br><span class="line">            <span class="built_in">this</span>.configuration.addIncompleteStatement(statementParser);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">parseStatementNode</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">//获取标签中的id</span></span><br><span class="line">    <span class="comment">//判断标签是crud中的哪一个，设置标签类型</span></span><br><span class="line">    <span class="comment">//解析属性</span></span><br><span class="line">    <span class="comment">//解析sql，替换占位符，保存占位符中的值（重点）</span></span><br><span class="line">    <span class="type">SqlSource</span> <span class="variable">sqlSource</span> <span class="operator">=</span> </span><br><span class="line">        langDriver.createSqlSource(<span class="built_in">this</span>.configuration, <span class="built_in">this</span>.context, parameterTypeClass);</span><br><span class="line">    <span class="comment">//解析属性</span></span><br><span class="line">    <span class="comment">//通过构建者助手，创建MappedStatement对象，存入configuration中的MapperStatementMap中</span></span><br><span class="line">    <span class="built_in">this</span>.builderAssistant.addMappedStatement(</span><br><span class="line">        			id, sqlSource, statementType, </span><br><span class="line">                     sqlCommandType, fetchSize, timeout, </span><br><span class="line">                     parameterMap, parameterTypeClass, resultMap,</span><br><span class="line">                     resultTypeClass, resultSetTypeEnum, flushCache, </span><br><span class="line">                     useCache, resultOrdered, (KeyGenerator)keyGenerator,</span><br><span class="line">                     keyProperty, keyColumn, databaseId, </span><br><span class="line">                     langDriver, resultSets);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> SqlSource <span class="title function_">createSqlSource</span><span class="params">(Configuration configuration, XNode script, Class&lt;?&gt; parameterType)</span> &#123;</span><br><span class="line">    <span class="comment">//初始化动态sql处理器，初始化节点处理器集合（when、where、if等等）</span></span><br><span class="line">    <span class="type">XMLScriptBuilder</span> <span class="variable">builder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XMLScriptBuilder</span>(configuration, script, parameterType);</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    	解析动态sql</span></span><br><span class="line"><span class="comment">    	将带有$&#123;&#125;的sql封装到TextSqlNode</span></span><br><span class="line"><span class="comment">    	将带有#&#123;&#125;的sql封装到StaticTextSqlNode</span></span><br><span class="line"><span class="comment">    	将动态SQL标签中的SQL信息分别封装到不同的SqlNode中，对应不同的节点处理器去解析</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">return</span> builder.parseScriptNode();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="创建SqlSession对象"><a href="#创建SqlSession对象" class="headerlink" title="创建SqlSession对象"></a>创建SqlSession对象</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">SqlSession</span> <span class="variable">sqlSession</span> <span class="operator">=</span> sqlSessionFactory.openSession();</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> SqlSession <span class="title function_">openSession</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">//参数：执行器类型、事务隔离级别、是否自动提交事务</span></span><br><span class="line">    <span class="keyword">return</span> </span><br><span class="line">        <span class="built_in">this</span>.openSessionFromDataSource(</span><br><span class="line">        	<span class="comment">//默认是简单执行器</span></span><br><span class="line">        	<span class="built_in">this</span>.configuration.getDefaultExecutorType(),(TransactionIsolationLevel)<span class="literal">null</span>, <span class="literal">false</span></span><br><span class="line">    	);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">private</span> SqlSession <span class="title function_">openSessionFromDataSource</span><span class="params">(ExecutorType execType, </span></span><br><span class="line"><span class="params">                                             TransactionIsolationLevel level, <span class="type">boolean</span> autoCommit)</span> &#123;</span><br><span class="line">    <span class="type">Transaction</span> <span class="variable">tx</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    DefaultSqlSession var8;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//获取Environment对象</span></span><br><span class="line">        <span class="type">Environment</span> <span class="variable">environment</span> <span class="operator">=</span> <span class="built_in">this</span>.configuration.getEnvironment();</span><br><span class="line">        <span class="comment">//获得事务工厂对象</span></span><br><span class="line">        <span class="type">TransactionFactory</span> <span class="variable">transactionFactory</span> <span class="operator">=</span> <span class="built_in">this</span>.getTransactionFactoryFromEnvironment(environment);</span><br><span class="line">        <span class="comment">//创建事务对象</span></span><br><span class="line">        tx = transactionFactory.newTransaction(environment.getDataSource(), level, autoCommit);</span><br><span class="line">        <span class="comment">//创建执行器对象，默认是SimpleExecutor，如果开启缓存的话会是CacheingExecutor（装饰器模式）</span></span><br><span class="line">        <span class="type">Executor</span> <span class="variable">executor</span> <span class="operator">=</span> <span class="built_in">this</span>.configuration.newExecutor(tx, execType);</span><br><span class="line">        <span class="comment">//创建DefaultSqlSession对象</span></span><br><span class="line">        var8 = <span class="keyword">new</span> <span class="title class_">DefaultSqlSession</span>(<span class="built_in">this</span>.configuration, executor, autoCommit);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception var12) &#123;</span><br><span class="line">        <span class="built_in">this</span>.closeTransaction(tx);</span><br><span class="line">        <span class="keyword">throw</span> ExceptionFactory.wrapException(<span class="string">&quot;Error opening session.  Cause: &quot;</span> + var12, var12);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        ErrorContext.instance().reset();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> var8;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="SqlSession执行流程"><a href="#SqlSession执行流程" class="headerlink" title="SqlSession执行流程"></a>SqlSession执行流程</h2><ol>
<li>调用SqlSession对应的Api，传入statementId（namespace.id）和参数</li>
<li>获取BoundSql，里面的sql已经经过处理和解析了</li>
<li>如果有开启缓存则在查询时生成缓存key（默认是开启的）<ol>
<li>对应的执行器去创建缓存key</li>
<li>根据缓存key去二级缓存中查数据，没有再去一级缓存中找，一级缓存没有再去查数据库，存到一个缓存中<ol>
<li>查询数据库前会现在一级缓存中进行一个占位操作</li>
<li>然后查询数据库<ol>
<li>获取configuration对象</li>
<li>调用configuration去构建StatementHandler相关处理器<ul>
<li>使用的是RoutingStatementHandler去选择，是一个装饰器，并且执行插件</li>
<li>由StatementType决定（可配置），默认是PreparedStatementHandler</li>
</ul>
</li>
<li>准备处理器，包括创建statement和动态参数的设置<ul>
<li>获取一个连接，通过事务对象获取</li>
<li>创建Statement对象</li>
<li>通过parameterHandler参数处理器去设置参数<ul>
<li>从boundSql获取每个占位符（#{}）中的值的集合</li>
<li>遍历，判断是入参还是出差，出差不处理</li>
<li>判断是否存在能处理该参数的类型处理器（TypeHandler）（入参类型）</li>
<li>使用TypeHandler为对应占位符赋值</li>
</ul>
</li>
<li>返回statement对象</li>
</ul>
</li>
<li>查询数据库<ul>
<li>将statement对象转换为PreparedStatement对象</li>
<li>执行sql</li>
<li>使用ResultSetHandler处理结果集<ol>
<li>获取ResultSet对象<ul>
<li>通过Statement获取ResultSetWrapper</li>
</ul>
</li>
<li>获取映射关系<ul>
<li>通过Statement获取ResultMap</li>
<li>遍历ResultMap获取ResultSet</li>
</ul>
</li>
<li>根据映射关系封装实体<ul>
<li>构建默认的结果集处理器（DefaultResultHandler）</li>
<li>对结果集进行映射封装，将封装后的对象存入DefaultResultHandler<ul>
<li>判断是否有内置嵌套结果映射，并进行相应的处理</li>
</ul>
</li>
</ul>
</li>
</ol>
</li>
</ul>
</li>
</ol>
</li>
<li>将数据填充到占位的缓存中</li>
</ol>
</li>
</ol>
</li>
</ol>
<h2 id="SqlSession原理"><a href="#SqlSession原理" class="headerlink" title="SqlSession原理"></a>SqlSession原理</h2><ul>
<li>门面模式</li>
</ul>
<h2 id="执行器原理"><a href="#执行器原理" class="headerlink" title="执行器原理"></a>执行器原理</h2><p><img src="/../../pic/image-20230319215902238.png" alt="image-20230319215902238"></p>
<h3 id="SimpleExecutor"><a href="#SimpleExecutor" class="headerlink" title="SimpleExecutor"></a>SimpleExecutor</h3><ul>
<li>简单执行器，每次执行sql都会进行预编译sql</li>
</ul>
<h3 id="ReuseExecutor"><a href="#ReuseExecutor" class="headerlink" title="ReuseExecutor"></a>ReuseExecutor</h3><ul>
<li>重用执行器</li>
</ul>
<h2 id="分页原理"><a href="#分页原理" class="headerlink" title="分页原理"></a>分页原理</h2><ul>
<li>分页参数放到ThreadLocal中，拦截执行的sql，根据数据库类型重写sql，计算分页的各种数据</li>
</ul>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ul>
<li>源码中大量使用了工厂模式<ul>
<li>SqlSessionFactory、DatasourceFactory、TransactionFactory</li>
</ul>
</li>
<li>但是源码中很多地方都是使用的硬编码来和xml中的节点做匹配</li>
<li></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2024/01/18/Note/%E5%90%8E%E7%AB%AF/Java/%E6%BA%90%E7%A0%81/Mybatis2/" data-id="clrj8pzxy00956wuwfwo511mr" data-title="" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-Note/后端/Java/源码/Spring" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2024/01/18/Note/%E5%90%8E%E7%AB%AF/Java/%E6%BA%90%E7%A0%81/Spring/" class="article-date">
  <time class="dt-published" datetime="2024-01-18T13:12:24.704Z" itemprop="datePublished">2024-01-18</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%BA%90%E7%A0%81/">源码</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2024/01/18/Note/%E5%90%8E%E7%AB%AF/Java/%E6%BA%90%E7%A0%81/Spring/">Spring</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="Spring"><a href="#Spring" class="headerlink" title="Spring"></a>Spring</h1><h2 id="IOC"><a href="#IOC" class="headerlink" title="IOC"></a>IOC</h2><h2 id="AOP"><a href="#AOP" class="headerlink" title="AOP"></a>AOP</h2><h3 id="JDK代理"><a href="#JDK代理" class="headerlink" title="JDK代理"></a>JDK代理</h3><ul>
<li><p>被代理对象需要实现接口</p>
</li>
<li><p>JDK代理和被代理对象同级，兄弟关系</p>
</li>
<li><p>JDK代理前16次通过反射调用方法，后续都是</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ClassLoader</span> <span class="variable">loder</span> <span class="operator">=</span> 被代理类.class.getClassLoader();</span><br><span class="line"><span class="comment">//被代理对象</span></span><br><span class="line"><span class="type">Target</span> <span class="variable">target</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Target</span>();</span><br><span class="line">接口 proxy = (接口) Proxy.newProxyInstance(loader, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;接口.class&#125;, <span class="keyword">new</span> <span class="title class_">InvacationHandler</span>()&#123;</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throw</span> Throable&#123;</span><br><span class="line">        <span class="comment">//执行增强</span></span><br><span class="line">        <span class="comment">//调用被代理对象方法</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">result</span> <span class="operator">=</span> method.invoke(target, args);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="CGLIB代理"><a href="#CGLIB代理" class="headerlink" title="CGLIB代理"></a>CGLIB代理</h3><ul>
<li>CGLIB代理和被代理对象是父子关系，所以被代理对象不能是final修饰的</li>
<li>CGLIB可以通过方法代理直接调用被代理方法，不走反射</li>
<li>被代理对象的方法是final修饰的话不会有增强效果</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//被代理对象</span></span><br><span class="line"><span class="type">Target</span> <span class="variable">target</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Target</span>();</span><br><span class="line"><span class="type">Target</span> <span class="variable">proxy</span> <span class="operator">=</span> (Target) Enhancer.create(Target.class, <span class="keyword">new</span> <span class="title class_">MethInteceptor</span>()&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">intercept</span><span class="params">(Object p, Method method, Object[] args, MethodProxy methodProxy)</span> <span class="keyword">throw</span> Throwable&#123;</span><br><span class="line">        <span class="comment">//执行增强</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">//调用被代理对象方法（反射）</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">result</span> <span class="operator">=</span> method.invoke(target, args);</span><br><span class="line">        <span class="comment">//调用被代理对象方法（直接调用）(需要被代理对象)（Spring使用）</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">result</span> <span class="operator">=</span> methodProxy.invoke(target, args);</span><br><span class="line">        <span class="comment">//调用被代理对象方法（直接调用）(不需要被代理对象)</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">result</span> <span class="operator">=</span> methodProxy.invokeSuper(p, args);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h2 id="容器创建（Refresh方法）"><a href="#容器创建（Refresh方法）" class="headerlink" title="容器创建（Refresh方法）"></a>容器创建（Refresh方法）</h2><ol>
<li>prepareRefresh<ul>
<li>创建Environment对象</li>
<li>为@Value注入信息</li>
</ul>
</li>
<li>obtainFreshBeanFactory<ul>
<li>获取或创建BeanFactory</li>
<li>通过BeanDefinition把对象信息存放在map中</li>
<li>创建需要的对象</li>
</ul>
</li>
<li>prepareBeanFactory<ul>
<li>初始化BeanFactory中的成员变量</li>
<li>解析Spel表达式</li>
<li>注册类型转换器，解析#{}</li>
<li>进行依赖注入</li>
<li>准备后处理器集合beanPostProcessors</li>
</ul>
</li>
<li>postProcessBeanFactory<ul>
<li>web环境下的ApplicationContext要利用它注册新的scope，完善Web下的BeanFactory</li>
</ul>
</li>
<li>invokeBeanFactoryPostProcessors<ul>
<li>对BeanFactory做扩展</li>
<li>解析@Configuration、@Bean、@Impor、@PropertySource</li>
</ul>
</li>
<li>registerBeanPostProcessors<ul>
<li>创建并加入更多的后处理器，主要看BeanDefinitionMap中对象是否实现了PostProcessor接口，加入beanPostProcessors集合中</li>
</ul>
</li>
<li>initMessageSource<ul>
<li>创建MessageSource</li>
<li>实现国际化功能</li>
</ul>
</li>
<li>initApplicationEventMulticaster<ul>
<li>创建事件广播器</li>
</ul>
</li>
<li>onRefresh<ul>
<li>空实现，留给子类实现</li>
<li>SpringBoot中的子类可以在这里准备内嵌的web容器</li>
</ul>
</li>
<li>registerListeners<ul>
<li>创建事件监听器</li>
</ul>
</li>
<li>finishBeanFactoryInitialization<ul>
<li>初始化BeanFactory中的成员变量</li>
<li>解析${}</li>
<li>创建beanDefinitionMap中保存的对象</li>
</ul>
</li>
<li>finishRefresh<ul>
<li>创建生命周期处理器</li>
</ul>
</li>
</ol>
<h2 id="BeanFactory"><a href="#BeanFactory" class="headerlink" title="BeanFactory"></a>BeanFactory</h2><p><strong>实现类</strong></p>
<ul>
<li><p>DefaultListableBeanFactory</p>
<ul>
<li><p>提供控制反转、基本的依赖注入、Bean生命周期的各个功能</p>
</li>
<li><p>默认无其他后处理器，解析不了注解，需要添加</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//添加后处理器</span></span><br><span class="line">AnnotationConfigUtils.registerAnnotationConfigProcessors(容器对象);</span><br><span class="line"><span class="comment">//启动后处理器</span></span><br><span class="line">容器对象.getBeanOfType(BeanFactoryPostProcessor.class)</span><br><span class="line">    ,values().stream().forEach(beanFactoryPostProcessor -&gt; &#123;</span><br><span class="line">    beanFactoryPostProcessor.postProcessBeanFactory(容器对象);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
</li>
<li><p>容器中的Bean对象在使用时才会创建（延迟创建），也可以提前创建</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//提前创建</span></span><br><span class="line">容器对象.preInstantiateSingletos()</span><br></pre></td></tr></table></figure>
</li>
<li><p>默认不会解析 ${}、#{}</p>
</li>
</ul>
</li>
</ul>
<h2 id="ApplicationContext"><a href="#ApplicationContext" class="headerlink" title="ApplicationContext"></a>ApplicationContext</h2><p><strong>实现类</strong></p>
<ul>
<li><p>ClassPathXmlApplicationContext、FIleSystemXmlApplicationContext</p>
<ul>
<li><p>创建DefaultListableBeanFactory</p>
</li>
<li><p>通过XmlBeanDefinitionReader中的loadBeanDefinitions()</p>
</li>
<li><p>读取Xml中的Bean</p>
</li>
</ul>
</li>
<li><p>AnnotationConfigApplicationContext</p>
<ul>
<li><p>通过配置类创建容器</p>
</li>
<li><p>会自动添加常用的后处理器</p>
</li>
</ul>
</li>
<li><p>AnnotationConfigServletWebServerApplicationContext</p>
<ul>
<li>借助了内嵌的Tomcat</li>
<li>需要提供一些Bean<ul>
<li>ServletWebServerFactory</li>
<li>DispatcherServlet</li>
<li>DispatchServletRegistrationBean</li>
</ul>
</li>
<li>非必须Bean<ul>
<li>Controller（web.servlet.mvc）<ul>
<li>处理Request、Response</li>
<li>可以指定访问的url</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="生命周期"><a href="#生命周期" class="headerlink" title="生命周期"></a>生命周期</h2><ol>
<li>处理名称，检查缓存</li>
</ol>
<ul>
<li>解析别名，解析特殊符号，查询三级缓存看是否有创建好的Bean</li>
</ul>
<ol start="2">
<li>处理父子容器</li>
</ol>
<ul>
<li>如果有父容器，回去父容器是否有创建好的Bean<ul>
<li>父子容器的bean名称可以重复</li>
<li>优先找子容器Bean，子容器没有再找父容器</li>
</ul>
</li>
</ul>
<ol start="3">
<li>dependsOn</li>
</ol>
<ul>
<li>判断是否用使用dependsOn指定Bean的创建顺序</li>
</ul>
<ol start="4">
<li>按不同的Scope创建Bean</li>
<li>实例化</li>
</ol>
<ul>
<li>通过构造函数创建</li>
<li>反射生成对象，堆中申请空间，给成员变量赋默认值</li>
</ul>
<ol start="6">
<li>依赖注入</li>
<li>初始化</li>
</ol>
<ul>
<li>Bean属性注入<ul>
<li>包括自定义属性和容器属性</li>
</ul>
</li>
<li>Bean功能扩展<ul>
<li>BeanPostProcessor<ul>
<li>AOP在此处实现</li>
</ul>
</li>
</ul>
</li>
</ul>
<ol start="8">
<li>使用，通过容器对象调用getBean()方法获取Bean对象</li>
<li>销毁</li>
</ol>
<h2 id="三级缓存-循环依赖"><a href="#三级缓存-循环依赖" class="headerlink" title="三级缓存 &#x2F; 循环依赖"></a>三级缓存 &#x2F; 循环依赖</h2><ul>
<li><p>用于解决循环依赖的问题</p>
<ul>
<li>循环依赖指的是对象创建时需要另一个对象，正好那个对象也在创建并等待该对象创建导致卡住<ul>
<li>主要在设值注入、构造注入时出现</li>
<li>设值注入单例情况下使用三级缓存解决</li>
<li>原型对象不使用三级缓存，因为会大量存储于缓存中无法被gc</li>
<li>构造注入出现循环依赖是无解的，所以只能通过检测来避免<ul>
<li>用一个容器存储，当对象创建时放入该容器，每当在需要依赖的时候就检测这个容器中是否有对应的对象，有的话就是发生了循环依赖</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><p>一级缓存：singletonObjects</p>
<ul>
<li>存成品对象</li>
<li>createBeanInstances之后放置</li>
<li>Bean生命周期中后置处理器处理时存入</li>
</ul>
</li>
<li><p>二级缓存：earlySingletonObjects</p>
<ul>
<li>存半成品对象</li>
<li>第一次从三级缓存中确定对象是代理对象还是普通对象的时候放置，同时删除三级缓存</li>
<li>Bean生命周期中填充属性时存入</li>
</ul>
</li>
<li><p>三级缓存：singletonFactories</p>
<ul>
<li>存的是工厂对象，也是lambda表达式，value值是ObjectFactory，key是beanname</li>
<li>生成完整对象之后放到一级缓存，删除二三级缓存</li>
<li>Bean生命周期中调用构造方法时存入</li>
</ul>
</li>
</ul>
<h2 id="事务原理"><a href="#事务原理" class="headerlink" title="事务原理"></a>事务原理</h2><p>​		事务是由AOP来实现的，首先生成代理对象，通过TransactionInterceptor，调用invoke实现具体逻辑</p>
<ol>
<li>解析方法上事务的相关属性，判断是否开启新事务</li>
<li>获取数据库连接，关闭自动提交，开启事务</li>
<li>执行具体的sql逻辑<ul>
<li>成功：通过commitTransactionAfterReturning提交，通过doCommit实现</li>
<li>失败：通过commitTransactionAfterThrowing执行回滚，通过doRollBack实现</li>
</ul>
</li>
<li>之后清除相关的事务信息，cleanupTransactionInfo</li>
</ol>
<h2 id="后处理器"><a href="#后处理器" class="headerlink" title="后处理器"></a>后处理器</h2><h3 id="BeanPostProcessor"><a href="#BeanPostProcessor" class="headerlink" title="BeanPostProcessor"></a>BeanPostProcessor</h3><ul>
<li>AutowiredAnnotationBeanPostProcessor<ul>
<li>解析@Autowired、@Value</li>
<li>内部调用的postProcessprProperties方法解析注解<ol>
<li>通过findAutowiringMetadata找到加了@Autowired的成员信息metadata</li>
<li>调用metadata.inject方法进行依赖注入<ul>
<li>获取成员信息的类型</li>
<li>封装为DependencyDescriptor对象</li>
<li>然后通过BeanFactory.doResolveDependency到容器里找对应的Bean</li>
</ul>
</li>
</ol>
</li>
</ul>
</li>
<li>ContextAnnotationAutowiredCandidateResolver<ul>
<li>解析${}</li>
</ul>
</li>
<li>CommonAnnotationBeanPostProcessor<ul>
<li>解析@Resource、@postConstruct、@PreDestroy</li>
</ul>
</li>
<li>ConfigurationPropertiesBindingPostProcessor<ul>
<li>解析@ConfigurationProperties</li>
</ul>
</li>
</ul>
<h3 id="BeanProcessor"><a href="#BeanProcessor" class="headerlink" title="BeanProcessor"></a>BeanProcessor</h3><ul>
<li>ConfigurationClassPostProcessor<ul>
<li>解析@Bean、@ComponentScan、@Import、@ImportResource</li>
</ul>
</li>
<li>MapperScannerConfigurer<ul>
<li>讲mapper加入容器，解析@MapperScan</li>
</ul>
</li>
</ul>
<h2 id="注解"><a href="#注解" class="headerlink" title="注解"></a>注解</h2><h3 id="Autowired"><a href="#Autowired" class="headerlink" title="@Autowired"></a>@Autowired</h3><h3 id="ComponentScan"><a href="#ComponentScan" class="headerlink" title="@ComponentScan"></a>@ComponentScan</h3><ol>
<li>获取包路径</li>
<li>转化为classpath的格式</li>
<li>通过容器的getResources方法获得路径下所有的类</li>
<li>判断类是否直接或间接加了@Component<ul>
<li>通过CachingMetadataReaderFactory对象的getMetadataReader方法获得MetadataReader</li>
<li>MetadataReader通过getAnnotationMetadata方法获得AnnotationMetadata对象</li>
<li>AnnotationMetadata对象调用hasAnnotation和hasMetaAnnotation判断是否直接或间接标注了@Component注解</li>
</ul>
</li>
<li>加了注解就把这个bean封装到BeanDefinition<ul>
<li>使用BeanDefinitionBuilder通过Bean名称获取BeanDefinition</li>
<li>通过AnnotationBeanNameGenerator生成Bean的名称</li>
<li>加入容器</li>
</ul>
</li>
</ol>
<h3 id="Bean"><a href="#Bean" class="headerlink" title="@Bean"></a>@Bean</h3><ol>
<li>获取包路径</li>
<li>转化为classpath的格式</li>
<li>通过容器的getResources方法获得路径下所有的类</li>
<li>判断类是否直接或间接加了@Component<ul>
<li>通过CachingMetadataReaderFactory对象的getMetadataReader方法获得MetadataReader</li>
</ul>
</li>
</ol>
<h1 id="SpringMVC"><a href="#SpringMVC" class="headerlink" title="SpringMVC"></a>SpringMVC</h1><h2 id="自动配置"><a href="#自动配置" class="headerlink" title="自动配置"></a>自动配置</h2><ul>
<li>主要是通过@EnableAutoConfiguration及其内部注解实现<ul>
<li>@AutoConfigurationPackage<ul>
<li>@Import(AutoConfigurationPackage.Registrar.class)<ul>
<li>利用Registrar批量注册组件</li>
</ul>
</li>
</ul>
</li>
<li>@Import(AutoConfigurationImportSelector.class)<ul>
<li>利用getAutoConfigurationEntry(annotationMetadata a) 给容器批量导入一些组件</li>
<li>调用getCandidateConfigurations(annotationMetadata, attributes) 获取所有需要导入的容器中的配置类&#x2F;组件<ul>
<li>利用了SpringFactoriesLoader（Spring工厂加载器）的loadFactoryNames() 这个方法返回loadSpringFactories的Map得到所有的组件<ul>
<li>loadSpringFactories方法会扫描当前系统里面所有的META-INF&#x2F;spring.factories</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="执行流程"><a href="#执行流程" class="headerlink" title="执行流程"></a>执行流程</h2><ol>
<li>用户发起HttpRequest请求，请求进入到 DispatcherServlet<ul>
<li>默认路径是 “ &#x2F; ”，会匹配到所有的url</li>
<li>SpringBoot会自动创建并加载DispatcherServlet的Bean<ul>
<li>会创建Spring容器并执行refresh方法</li>
</ul>
</li>
<li>第一次请求来时会初始化DispatcherServlet，然后到容器中找它依赖的组件，没有就用默认的<ul>
<li>HandlerMapping、HandlerAdapter、HandlerExceptionResolver、ViewResolver</li>
</ul>
</li>
</ul>
</li>
<li>DispatcherServlet 将请求转发给所有的 HandlerMapping，HandlerMapping 会找到能处理这些请求的Handler方法<ul>
<li>这些Handler方法会被封装成HandlerMethod对象，并结合匹配到的拦截器，合并成HandlerExecutionChain（调用链）对象，然后一起返回给DispatcherServlet </li>
<li>HandlerMapping 会在初始化时就会建立好请求路径和处理器的映射关系</li>
</ul>
</li>
<li>DispatcherServlet 收到这条调用链后 <ul>
<li>调用所有拦截器的preHandle方法，返回true才继续后续的调用</li>
<li>调用HandlerAdapter解析HandlerMethod并调用对应的Handler方法，准备数据绑定工厂、模型工厂，将HandlerMethod完善为ServletInvocableHandlerMethod<ul>
<li>使用HandlerMethodArgumentResolver参数解析</li>
<li>调用ServletInvocableHandlerMethod</li>
<li>调用HandlerMethodReturnValueHandler处理返回值<ul>
<li>有@ResponseBody注解的话直接返回Json</li>
<li>否则返回的是 ModelAndView ，然后进行视图解析和渲染</li>
</ul>
</li>
</ul>
</li>
<li>调用拦截器的postHandle方法</li>
</ul>
</li>
<li>视图渲染或处理异常<ul>
<li>如果1 - 3出现异常，ExceptionHandlerExceptionResolver处理<ul>
<li>@ControllerAdvice增强5：@ExceptionHandler异常处理</li>
</ul>
</li>
<li>视图解析即渲染<ul>
<li>将 ModelAndView 转发给 ViewResolver 处理并返回 View 对象给 DispatcherServlet</li>
<li>DispatcherServlet 再将渲染后的页面返回给客户端</li>
</ul>
</li>
</ul>
</li>
<li>调用拦截器的afterCompletion方法</li>
</ol>
<h1 id="SpringBoot"><a href="#SpringBoot" class="headerlink" title="SpringBoot"></a>SpringBoot</h1><h2 id="执行流程-1"><a href="#执行流程-1" class="headerlink" title="执行流程"></a>执行流程</h2><ol>
<li>调用构造方法创建SpringApplication对象<ul>
<li>根据各种来源添加BeanDefinition</li>
<li>推断应用程序类型(servlet, none, reacter)</li>
<li>准备初始化器，监听器</li>
<li>进行主类推断</li>
</ul>
</li>
<li>执行run方法<ol>
<li>得到SpringApplicationRunListeners事件发布器<ul>
<li>发布7个事件<ul>
<li>starting：开始启动</li>
<li>environmentPrepared：准备环境</li>
<li>contextPrepared：容器创建并调用初始化器</li>
<li>contextLoaded：Bean定义加载</li>
<li>started：refresh方法执行</li>
<li>running：springboot启动完成</li>
</ul>
</li>
</ul>
</li>
<li>封装args为ApplicationArgument对象<ul>
<li>用DefaultApplicationArguments(args)封装</li>
</ul>
</li>
<li>创建Environment对象<ul>
<li>有系统属性和系统环境变量，优先找系统属性</li>
</ul>
</li>
<li>对Environment中命名规范统一处理</li>
<li>对Environment做扩展增强<ul>
<li>使用EnvironmentPostProcessor后处理器做增强</li>
</ul>
</li>
<li>对Environment中以”spring.main”为前缀的key与SpringApplication容器对象做绑定</li>
<li>打印Banner</li>
<li>创建spring容器</li>
<li>应用初始化器的增强</li>
<li>得到所有的BeanDefinition</li>
<li>调用Application的refresh方法</li>
<li>调用所有实现ApplicationRunner和CommandLineRunner接口的Bean</li>
</ol>
</li>
</ol>
<h2 id="自动装配"><a href="#自动装配" class="headerlink" title="自动装配"></a>自动装配</h2><ol>
<li>通过@EnableAutoConfiguration注解</li>
</ol>
<h1 id="SpringCloud"><a href="#SpringCloud" class="headerlink" title="SpringCloud"></a>SpringCloud</h1><h2 id="Nacos"><a href="#Nacos" class="headerlink" title="Nacos"></a>Nacos</h2><h3 id="动态配置刷新"><a href="#动态配置刷新" class="headerlink" title="动态配置刷新"></a>动态配置刷新</h3><ul>
<li>主要依赖推送和拉取<ul>
<li>推送机制是指Nacos服务器在检测到配置变化时，主动通知客户端更新配置。Nacos服务器使用了<strong>长轮询</strong>的方式来实现推送</li>
<li>拉取机制是客户端每30秒会执行一次心跳检测，此时客户端也会执行一次配置拉取操作，如果发现配置有变化，则会触发配置更新的回调函数，可以保证nacos推送失败或者网络问题异常的情况下依然能获取最新的配置<ul>
<li>回调函数是ContextRefresher类的refresh方法，该方法会触发一个RefreshEvent事件，该事件会被springcloud的组件监听并执行相应的刷新逻辑</li>
</ul>
</li>
</ul>
</li>
<li>原理是基于Environment、@RefreshScope、@Value<ul>
<li>通过Environment获取的配置会自动刷新</li>
<li>通过@RefreshScope标注的Bean会重新创建并注入容器</li>
<li>通过@Value的字段会重新赋值</li>
</ul>
</li>
</ul>
<h3 id="服务注册"><a href="#服务注册" class="headerlink" title="服务注册"></a>服务注册</h3><ol>
<li><p>调用register接口，传入ip、namespace、groupName、serviceName等等</p>
</li>
<li><p>解析request请求取得参数</p>
<ul>
<li><p>如果没传namespace会使用默认的namespace</p>
</li>
<li><p>服务名称：groupName@@serviceName</p>
<ul>
<li><p>解析request请求获得参数，封装为Instance对象</p>
</li>
<li><p>内部有两个集合，一个放临时实例，一个放永久实例</p>
</li>
</ul>
</li>
</ul>
</li>
<li><p>将参数封装为Instance对象，然后调用registerInstance注册该实例</p>
<ol>
<li>创建空的服务service，只有第一次会创建，为了确保有服务对象<ul>
<li>尝试从注册表中获取service<ul>
<li>为空则创建，会记录服务最后一次更新时间</li>
<li>存进注册表，双重检查</li>
</ul>
</li>
</ul>
</li>
<li>添加实例到服务service中<ul>
<li>为服务生成唯一标识</li>
<li>从注册表中拿到服务service</li>
<li>加锁，多实例间只能串行添加<ul>
<li>拷贝注册表中旧的实例列表然后加上新注册的实例组成完整的实例列表</li>
</ul>
</li>
</ul>
</li>
</ol>
</li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2024/01/18/Note/%E5%90%8E%E7%AB%AF/Java/%E6%BA%90%E7%A0%81/Spring/" data-id="clrj8pzxy00986wuw3u4rb6tb" data-title="Spring" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E6%BA%90%E7%A0%81/" rel="tag">源码</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-Note/后端/Java/源码/JUC" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2024/01/18/Note/%E5%90%8E%E7%AB%AF/Java/%E6%BA%90%E7%A0%81/JUC/" class="article-date">
  <time class="dt-published" datetime="2024-01-18T13:12:24.703Z" itemprop="datePublished">2024-01-18</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%BA%90%E7%A0%81/">源码</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2024/01/18/Note/%E5%90%8E%E7%AB%AF/Java/%E6%BA%90%E7%A0%81/JUC/">JUC源码</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="AtomicInteger"><a href="#AtomicInteger" class="headerlink" title="AtomicInteger"></a>AtomicInteger</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//自增自减都是通过这个方法实现，</span></span><br><span class="line">unsafe.getAndAddInt(<span class="built_in">this</span>, valueOffset, <span class="number">1</span> / -<span class="number">1</span>);</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//复杂运算</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">updateAndGet</span><span class="params">(IntUnaryOperator updateFunction)</span> &#123;</span><br><span class="line">    <span class="type">int</span> prev, next;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        prev = get();</span><br><span class="line">        next = updateFunction.applyAsInt(prev);</span><br><span class="line">    &#125; <span class="keyword">while</span> (!compareAndSet(prev, next));</span><br><span class="line">    <span class="keyword">return</span> next;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>IntUnaryOperator是一个函数式接口，使用lambda传值</li>
</ul>
<h2 id="ConcurrentHashMap"><a href="#ConcurrentHashMap" class="headerlink" title="ConcurrentHashMap"></a>ConcurrentHashMap</h2><h3 id="成员变量"><a href="#成员变量" class="headerlink" title="成员变量"></a>成员变量</h3><ul>
<li>sizeCtl<ul>
<li>下一次扩容的阈值</li>
<li>默认为0，初始化时为-1</li>
<li>扩容时为 - (1 + 扩容线程数)</li>
</ul>
</li>
<li>Node<ul>
<li>节点</li>
</ul>
</li>
<li>ForwardingNode<ul>
<li>继承Node</li>
<li>扩容时作为旧数组的头节点</li>
</ul>
</li>
<li>ReservationNode<ul>
<li>继承Node</li>
<li>在compute以及computeIfAbsent时，用来占位</li>
<li>计算完成后替换为普通Node</li>
</ul>
</li>
<li>TreeBin<ul>
<li>继承Node</li>
<li>作为树的头节点</li>
<li>存储root和first</li>
<li>加了读写锁</li>
</ul>
</li>
<li>TreeNode<ul>
<li>继承Node</li>
<li>作为TreeBin的节点</li>
<li>存储parent，left，right</li>
</ul>
</li>
<li>Node[] table<ul>
<li>哈希表</li>
</ul>
</li>
<li>Node[] nextTable<ul>
<li>扩容时的新哈希表</li>
</ul>
</li>
</ul>
<h3 id="成员方法"><a href="#成员方法" class="headerlink" title="成员方法"></a>成员方法</h3><ul>
<li>tabAt<ul>
<li>获取Node[]中第 i 个Node</li>
<li>参数：table，下标</li>
</ul>
</li>
<li>casTabAt<ul>
<li>cas修改Node[] 中Node的值</li>
<li>参数：数组table、下标、旧值、新值</li>
</ul>
</li>
<li>setTabAt<ul>
<li>直接修改Node[] 中 Node的值</li>
<li>参数：数组table、下标、新值</li>
</ul>
</li>
</ul>
<h3 id="构造方法-初始化"><a href="#构造方法-初始化" class="headerlink" title="构造方法 &#x2F; 初始化"></a>构造方法 &#x2F; 初始化</h3><ul>
<li>1.7<ul>
<li>初始化时就会创建segment数组和HashEntry数组的0号元素<ul>
<li>segment数组默认大小16</li>
<li>初始化后segment数组的长度就不能改变</li>
<li>并发度是ConcurrentHashmap的长度（segment数组的大小）</li>
<li>这个数组的0号元素为其他HashEntry数组的创建提供原型</li>
<li>每个片段下的数组大小 &#x3D; 容量 &#x2F; 并发度<ul>
<li>最小值为2，数组的元素数量超过阈值（0.75）就会扩容</li>
</ul>
</li>
</ul>
</li>
<li>指定容量时大于等于接近等级的容量x0.75时，容量会升一级创建</li>
</ul>
</li>
<li>1.8<ul>
<li>懒惰初始化，第一次put数据时才会创建数组结构，默认初始容量是16</li>
<li>无参构造创建时，数组初始容量是16</li>
<li>初始化时传了容量大小时，判断是否超过容量×负载因子<ul>
<li>大于则创建下一个阶段的大小</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="索引计算"><a href="#索引计算" class="headerlink" title="索引计算"></a>索引计算</h3><ul>
<li>1.7<ul>
<li>segment数组索引<ul>
<li>并发度为16（2^4^）时，看二次hash值的高四位</li>
<li>并发度为32（2^5^）时，看二次hash值的高五位</li>
</ul>
</li>
<li>数组索引<ul>
<li>数组的大小为2（2^1^）时，看二次hash的低一位</li>
<li>数组的大小为4（2^2^）时，看二次hash的低二位</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="put方法"><a href="#put方法" class="headerlink" title="put方法"></a>put方法</h3><ul>
<li>1.7<ul>
<li>头插法</li>
<li>hash找segement，内部数组执行put操作</li>
<li>使用cas初始化槽</li>
<li>通过tryLock()获取锁，获取不到就重试，再获取不到就lock住，直到获取锁</li>
</ul>
</li>
<li>1.8<ul>
<li>尾插法，锁链表头或红黑树根节点</li>
</ul>
</li>
</ul>
<h3 id="get方法"><a href="#get方法" class="headerlink" title="get方法"></a>get方法</h3><ul>
<li>1.7<ul>
<li>计算hash找segement，再hash找数组，再遍历链表</li>
<li>没加锁，需要考虑并发问题<ul>
<li>get时有put操作<ul>
<li>源码中使用了CAS保证初始化segement时也能get</li>
<li>源码中使用了UNSAFE.putOrderedObject保证put后的数据也能被get到</li>
<li>源码中使用了volatile 保证扩容时数据也能被get到</li>
</ul>
</li>
<li>get时有remove操作<ul>
<li>源码中使用了UNSAFE.putOrderedObject保证remove后的数据不会被get到</li>
<li>源码中使用了volatile 保证remove时数据不会被get到</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>1.8<ul>
<li>计算hash，找数组对应位置<ul>
<li>如果hash值为0，说明正在扩容或者是红黑树</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="初始化table方法"><a href="#初始化table方法" class="headerlink" title="初始化table方法"></a>初始化table方法</h3><ul>
<li>1.8<ul>
<li>size计算实际发生在put，remove改变集合元素的操作之中<ul>
<li>没有竞争发生，向baseCount累加计数</li>
<li>有竞争发生，新建counterCells，向其中的一个cell累加计数<ul>
<li>counterCells初始有两个cell</li>
<li>如果计数竞争比较激烈，会创建新的cell来累加计数</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="链表转红黑树"><a href="#链表转红黑树" class="headerlink" title="链表转红黑树"></a>链表转红黑树</h3><ul>
<li><h2 id="1-8"><a href="#1-8" class="headerlink" title="1.8"></a>1.8</h2></li>
</ul>
<h3 id="扩容"><a href="#扩容" class="headerlink" title="扩容"></a>扩容</h3><ul>
<li>1.7<ul>
<li>segement不能扩容，扩容的是HashEntry数组</li>
<li>元素个数 &gt; 容量 × 负载因子 时扩容，大小变为2倍，先扩容，再插值</li>
</ul>
</li>
<li>1.8 <ul>
<li>元素个数 &gt;&#x3D; 四分之三时扩容，与负载因子无关</li>
<li>以链表为单位，从后往前迁移数据，处理完当前位置会在这个位置打上标记（forwardingNode）</li>
<li>可以多个线程帮忙扩容，一个线程扩容16个位置，从后往前做数据迁移</li>
</ul>
</li>
</ul>
<h2 id="ReentrantLock"><a href="#ReentrantLock" class="headerlink" title="ReentrantLock"></a>ReentrantLock</h2><ul>
<li>锁的竞争是用的CAS机制来实现的</li>
<li>没有竞争到锁时是使用AQS来存储竞争锁的线程</li>
<li>锁的重入是内部变量记录了当前持锁线程的id，重入时判断id是否相同</li>
</ul>
<h2 id="ThreadLcoal"><a href="#ThreadLcoal" class="headerlink" title="ThreadLcoal"></a>ThreadLcoal</h2><h2 id="LongAdder"><a href="#LongAdder" class="headerlink" title="LongAdder"></a>LongAdder</h2><h3 id="成员变量-1"><a href="#成员变量-1" class="headerlink" title="成员变量"></a>成员变量</h3><ul>
<li>Cell[] cells<ul>
<li>累加单元数组，懒惰初始化，24字节</li>
</ul>
</li>
<li>base<ul>
<li>基础值，如果没有竞争，则用cas累加这个域</li>
</ul>
</li>
<li>cellsBusy<ul>
<li>在cells创建或扩容时，置位1，表示加锁</li>
</ul>
</li>
<li>Cell<ul>
<li>内部维护一个value值</li>
<li>用cas进行累加</li>
<li>一个缓存行(64字节)可以存下2个Cell，但是会有问题<ul>
<li>当有两个线程同时修改同一个缓存行中的cell时，一方的修改会导致另一方失败</li>
<li>@sun.misc.Contended可以解决这个问题，它通过在对象的前后各加上128字节的padding，从而让cpu将对象预读至不同的缓存行，所以不会造成失效</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="线程池"><a href="#线程池" class="headerlink" title="线程池"></a>线程池</h2><h3 id="任务执行流程"><a href="#任务执行流程" class="headerlink" title="任务执行流程"></a>任务执行流程</h3><ol>
<li>判断任务是否为null，不为空正常往下走，为空抛异常</li>
<li>检查是否能创建工作线程，通过比对stl低29位和线程池参数<ul>
<li>还能创建核心线程，创建并执行任务</li>
<li>不能创建核心线程<ul>
<li>有可能创建失败，同时又多个任务进来，然后同时创建新的线程，核心线程数够了的话就会有可能创建失败，也有可能核心线程数已经满了</li>
</ul>
</li>
</ul>
</li>
<li>如果不能创建核心线程，判断线程池状态，判断是否能放进阻塞队列中<ul>
<li>线程池正常并成功放进队列中<ul>
<li>判断线程池状态，判断是否能去除等待队列中的任务<ul>
<li>线程池正常并能取出队列中的任务，查看工作线程是否有空闲，空闲直接执行任务，否则创建救急线程</li>
<li>线程池异常或不能取出队列中的任务，走拒绝策略</li>
</ul>
</li>
</ul>
</li>
<li>线程池异常或不能放进队列中，尝试添加救急线程处理，不能添加就走拒绝策略</li>
</ul>
</li>
</ol>
<h3 id="添加线程流程"><a href="#添加线程流程" class="headerlink" title="添加线程流程"></a>添加线程流程</h3><ul>
<li><p>核心方法是addWorker方法，方法主要做了两步</p>
<ol>
<li><p>检验线程池状态以及工作线程个数</p>
<ol>
<li><p>取ctl高三位判断线程池状态，不是running状态则失败</p>
</li>
<li><p>通过传入的参数判断是添加核心线程还是救急线程</p>
</li>
<li><p>取ctl的低29位，</p>
<ul>
<li><p>判断线程数是否超出最大线程数</p>
</li>
<li><p>判断创建核心线程还是救急线程</p>
</li>
<li><p>使用cas方式对ctl低29位进行+1操作</p>
</li>
</ul>
</li>
</ol>
</li>
<li><p>构建线程并且启动</p>
<ul>
<li>new一个工作线程，获取他的线程对象</li>
<li>工作线程是放在一个hashset中的，添加的时候使用了lock锁保证线程安全</li>
<li>通过线程对象启动任务</li>
</ul>
</li>
</ol>
</li>
</ul>
<h2 id=""><a href="#" class="headerlink" title=""></a></h2>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2024/01/18/Note/%E5%90%8E%E7%AB%AF/Java/%E6%BA%90%E7%A0%81/JUC/" data-id="clrj8pzxx008w6wuwf0q37g8n" data-title="JUC源码" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E6%BA%90%E7%A0%81/" rel="tag">源码</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-Note/后端/Java/源码/MyBatis" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2024/01/18/Note/%E5%90%8E%E7%AB%AF/Java/%E6%BA%90%E7%A0%81/MyBatis/" class="article-date">
  <time class="dt-published" datetime="2024-01-18T13:12:24.703Z" itemprop="datePublished">2024-01-18</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%BA%90%E7%A0%81/">源码</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2024/01/18/Note/%E5%90%8E%E7%AB%AF/Java/%E6%BA%90%E7%A0%81/MyBatis/">MyBatis源码</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="架构"><a href="#架构" class="headerlink" title="架构"></a>架构</h1><p><img src="/../pic/image-20230317103336946.png" alt="image-20230317103336946"></p>
<ul>
<li><p>接口层</p>
<ul>
<li><p>提供操作数据的Api接口，完成交互</p>
</li>
<li><p>提供两种调用方式</p>
<ul>
<li>基于statementId，需要传递xml中查询的id和参数<ul>
<li>基于mapper接口，生成代理对象调用方法，只需要传参数即可，本质上还是基于statementId的</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><p>数据处理层</p>
<ul>
<li>核心层，主要完成对数据的处理工作<ul>
<li>参数映射（ParameterHandler）、sql解析（sqlSource）、sql执行（Executor）、结果处理和映射封装（ResultSetHandler）</li>
</ul>
</li>
</ul>
</li>
<li><p>框架支撑层</p>
<ul>
<li>为基础服务提供支持，负责通用服务支持<ul>
<li>sql配置方式：xml，注解</li>
<li>事务管理、连接池管理、缓存管理</li>
</ul>
</li>
</ul>
</li>
<li><p>引导层</p>
<ul>
<li>提供两种配置方式，获取mybatis启动需要的配置信息<ul>
<li>基于xml</li>
<li>基于JavaAPI</li>
</ul>
</li>
</ul>
</li>
</ul>
<h1 id="组件及其调用关系"><a href="#组件及其调用关系" class="headerlink" title="组件及其调用关系"></a>组件及其调用关系</h1><p><img src="/../pic/image-20230317115152145.png" alt="image-20230317115152145"></p>
<h1 id="Mybatis"><a href="#Mybatis" class="headerlink" title="Mybatis"></a>Mybatis</h1><h2 id="执行流程"><a href="#执行流程" class="headerlink" title="执行流程"></a>执行流程</h2><ol>
<li>读取配置文件信息，加载sql映射文件<ul>
<li>通过类加载器对配置文件进行加载，加载成了字节输入流，存到内存中，这一步中配置文件还没有被解析</li>
<li>内部使用了ClassLoaderWrapper，它是 ClassLoader 的装饰器，封装了多个 ClassLoader，方便统一使用</li>
</ul>
</li>
<li>构建SqlSessionFactory<ul>
<li>解析xml配置文件 将inputStream转换成Document对象，创建Configuration</li>
<li>使用构建者模式构建复杂的Configuration对象中的成员变量（配置信息和Mapper信息）</li>
<li>创建SqlSessionFactory对象</li>
<li>XPathParser是一个基于Java XPath的解析器，将传入的inputStream 转换成一个Document对象</li>
<li>创建Configuration对象，完成类型别名注册</li>
</ul>
</li>
<li>创建对应的SqlSession</li>
<li>通过Executor执行器操作数据库，维护缓存</li>
<li>读取MapperStatement对象</li>
</ol>
<h2 id="二级缓存"><a href="#二级缓存" class="headerlink" title="二级缓存"></a>二级缓存</h2><ul>
<li><p>提升数据的检索效率</p>
</li>
<li><p>一级缓存为本地缓存（SqlSession）</p>
<ul>
<li>SqlSession中有一个Excutor，Excutor中有一个localcache</li>
<li>当用户发起查询时，mybatis会去localcache中查</li>
<li>分布式环境下可能会出现一个脏读的问题</li>
</ul>
</li>
<li><p>二级缓存为跨SqlSession的缓存</p>
<ul>
<li>即多个用户查询时，只要有一个SqlSession查询到数据后，就会加入二级缓存，其他SqlSession就可以直接从二级缓存中取数据</li>
<li>在Excutor上做了一个装饰器（CachingExcutor），查询一级缓存前会先查这个</li>
<li>二级缓存实现了多个SqlSession之间的共享，是一个全局的缓存，缓存粒度在namespace级别，可以通过Cache接口实现不同缓存实现类组合</li>
<li>原理就是在每次查询时生成一个CacheKey对象，然后去二级缓存中找这个CacheKey对象是否有对应的数据<ul>
<li>没有就查数据库，然后加入二级缓存</li>
<li>有的话直接返回</li>
</ul>
</li>
<li>创建CacheKey对象的方法中已经重写了equals和hashcode方法，所以其比较的是hash值而不是地址值</li>
<li>CacheKey由6部分构成的，为statementId、分页参数（偏移、条数）、sql、参数的值、环境变量，它们各自生成的hash组成的一个集合</li>
</ul>
</li>
</ul>
<h1 id="MybatisPlus"><a href="#MybatisPlus" class="headerlink" title="MybatisPlus"></a>MybatisPlus</h1>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2024/01/18/Note/%E5%90%8E%E7%AB%AF/Java/%E6%BA%90%E7%A0%81/MyBatis/" data-id="clrj8pzxy008y6wuwe2zt5b2h" data-title="MyBatis源码" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E6%BA%90%E7%A0%81/" rel="tag">源码</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-Note/后端/Java/源码/JDK" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2024/01/18/Note/%E5%90%8E%E7%AB%AF/Java/%E6%BA%90%E7%A0%81/JDK/" class="article-date">
  <time class="dt-published" datetime="2024-01-18T13:12:24.702Z" itemprop="datePublished">2024-01-18</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%BA%90%E7%A0%81/">源码</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2024/01/18/Note/%E5%90%8E%E7%AB%AF/Java/%E6%BA%90%E7%A0%81/JDK/">JDK源码</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="Unsafe"><a href="#Unsafe" class="headerlink" title="Unsafe"></a>Unsafe</h2><p>简介</p>
<ul>
<li><p>因为使Java拥有了类似c语言一样的指针，所以不安全Unsafe</p>
</li>
<li><p>Unsafe不能直接调用</p>
<ul>
<li><p>通过反射获得</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Field</span> <span class="variable">theUnsafe</span> <span class="operator">=</span> Unsafe.class.getDeclaredField(<span class="string">&quot;theUnsafe&quot;</span>);</span><br><span class="line">theUnsafe.setAccessible(<span class="literal">true</span>);</span><br><span class="line"><span class="type">Unsafe</span> <span class="variable">unsafe</span> <span class="operator">=</span> theUnsafe.get(<span class="literal">null</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p>Unsafe提供了一个静态方法getUnsafe可以获取Unsafe实例，但是必须使用引导类加载器加载Unsafe类才能使用，因为有@CallerSensitive注解标注，为危险方法</p>
<ul>
<li>命令行中输入：<code>java -Xbootclasspath/a: $&#123;path&#125;   // 其中path为调用Unsafe相关方法的类所在jar包路径 </code></li>
</ul>
</li>
</ul>
</li>
</ul>
<p>操作内存</p>
<ul>
<li>主要包含堆外内存的分配、拷贝、释放、给定地址值操作等方法</li>
<li>为什么要使用堆外内存<ul>
<li>对垃圾回收停顿的改善。由于堆外内存是直接受操作系统管理而不是JVM，所以当我们使用堆外内存时，即可保持较小的堆内内存规模。从而在GC时减少回收停顿对于应用的影响。</li>
<li>提升程序I&#x2F;O操作的性能。通常在I&#x2F;O通信过程中，会存在堆内内存到堆外内存的数据拷贝操作，对于需要频繁进行内存间数据拷贝且生命周期较短的暂存数据，都建议存储到堆外内存。</li>
</ul>
</li>
<li>应用：<ul>
<li>DirectByteBuffer，在NIO框架中通常作为缓冲池使用，内部的内存分配逻辑都由Unsafe提供<ul>
<li><code>unsafe.allocateMemory(内存大小)</code><ul>
<li>分配内存，返回基地址</li>
</ul>
</li>
<li><code>unsafe.setMemory(base, size, (byte) 0)</code><ul>
<li>设置内存，内存初始化</li>
</ul>
</li>
<li><code>cleaner = Cleaner.create(this, new Deallocator(base, size, cap))</code><ul>
<li>跟踪DirectByteBuffer对象的垃圾回收，以实现当DirectByteBuffer被垃圾回收时，分配的堆外内存一起被释放</li>
<li>Cleaner继承自虚引用，当DirectByteBuffer对象仅被Cleaner对象引用时，</li>
<li>gc时会将DirectByteBuffer对象回收，Cleaner对象会调用clean() 方法来进行堆外内存的释放。</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>CAS（CompareAndSwap）</p>
<ul>
<li>是一个本地方法</li>
<li>AtomicInteger 使用 unsafe提供的CAS</li>
<li>Unsafe只提供了 compareAndSwapObject、compareAndSwapInt、compareAndSwapLong 方法</li>
<li>赋值阶段源码中都是通过do-while判断</li>
<li>原理：<ul>
<li><p>通过循环判断预期值来决定是否更新值</p>
</li>
<li><p>如果是多处理器，需要添加lock前缀（Lock#信号），内存屏障</p>
</li>
<li><p>这里的lock前缀就是使用了处理器的总线锁(最新的处理器都使用缓存锁代替总线锁来提高性能)</p>
<ul>
<li><p>总线锁：将cpu和内存之间的通信锁住，其他cpu不能操作内存中的数据，开销比较大，相当于加了悲观锁</p>
</li>
<li><p>缓存锁：使用缓存锁定，将原子操作放在cpu缓存中进行</p>
<ul>
<li>缓存锁定：<ul>
<li>发生共享内存的锁定时，不会锁内存，而是修改内存地址，通过<strong>MESI缓存一致性</strong>保证原子性</li>
</ul>
</li>
<li>缓存一致性：<ul>
<li>如果这块内存被两个以上的处理器缓存，会阻止这块内存区域的同时修改</li>
<li>当处理器对缓存中的数据修改后，会通知其他处理器删除其内部这块内存的缓存，或者从主内存中重新读取</li>
</ul>
</li>
<li>如果操作的数据跨多个缓存行时，处理器会使用总线锁</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>线程调度</p>
<ul>
<li>线程挂起、恢复、锁机制</li>
<li>park、unpark、monitorEnter、monitorExit、tryMonitorEnter</li>
</ul>
<p>Class相关</p>
<ul>
<li>提供Class和它的静态字段的操作相关方法，包含静态字段内存定位、定义类、定义匿名类、检验&amp;确保初始化等</li>
<li>获取属性在内存中的位置</li>
<li>获取数组第一个元素在内存中的偏移地址，还可以获取下标的增量地址</li>
</ul>
<p>系统相关</p>
<ul>
<li>addressSize：返回系统指针的大小。返回值为4（32位系统）或 8（64位系统）</li>
<li>pageSize：内存页的大小，此值为2的幂次方</li>
</ul>
<p>内存屏障</p>
<ul>
<li>loadFence：禁止load操作重排序</li>
<li>storeFence：禁止store操作重排序</li>
<li>fullFence：禁止load、store操作重排序</li>
</ul>
<p>对象操作</p>
<ul>
<li>主要包含对象成员属性相关操作及非常规的对象实例化方式等相关方法</li>
<li>Unsafe的allocateInstance实现对象的实例化，保证在目标类无默认构造函数时，反序列化不够影响</li>
</ul>
<h3 id="getUnsafe"><a href="#getUnsafe" class="headerlink" title="getUnsafe()"></a>getUnsafe()</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@CallerSensitive</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Unsafe <span class="title function_">getUnsafe</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">Class</span> <span class="variable">var0</span> <span class="operator">=</span> Reflection.getCallerClass(); <span class="comment">//getCallerClass方法需要启动类加载的类才可以调用</span></span><br><span class="line">    <span class="keyword">if</span> (!VM.isSystemDomainLoader(var0.getClassLoader())) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SecurityException</span>(<span class="string">&quot;Unsafe&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> theUnsafe;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="getAndAddInt"><a href="#getAndAddInt" class="headerlink" title="getAndAddInt()"></a>getAndAddInt()</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">getAndAddInt</span><span class="params">(Object var1, <span class="type">long</span> var2, <span class="type">int</span> var4)</span> &#123;</span><br><span class="line">    <span class="type">int</span> var5;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        var5 = <span class="built_in">this</span>.getIntVolatile(var1, var2); <span class="comment">//检验</span></span><br><span class="line">    &#125; <span class="keyword">while</span>(!<span class="built_in">this</span>.compareAndSwapInt(var1, var2, var5, var5 + var4));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> var5;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="核心方法"><a href="#核心方法" class="headerlink" title="核心方法"></a>核心方法</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//重新分配内存</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> <span class="type">long</span> <span class="title function_">reallocateMemory</span><span class="params">(<span class="type">long</span> address, <span class="type">long</span> bytes)</span>;  </span><br><span class="line">  </span><br><span class="line"><span class="comment">//分配内存  </span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> <span class="type">long</span> <span class="title function_">allocateMemory</span><span class="params">(<span class="type">long</span> bytes)</span>;  </span><br><span class="line">  </span><br><span class="line"><span class="comment">//释放内存  </span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title function_">freeMemory</span><span class="params">(<span class="type">long</span> address)</span>;  </span><br><span class="line">  </span><br><span class="line"><span class="comment">//在给定的内存块中设置值  </span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title function_">setMemory</span><span class="params">(Object o, <span class="type">long</span> offset, <span class="type">long</span> bytes, <span class="type">byte</span> value)</span>;  </span><br><span class="line">  </span><br><span class="line"><span class="comment">//从一个内存块拷贝到另一个内存块  </span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title function_">copyMemory</span><span class="params">(Object srcBase, <span class="type">long</span> srcOffset, Object destBase, <span class="type">long</span> destOffset, <span class="type">long</span> bytes)</span>;  </span><br><span class="line">  </span><br><span class="line"><span class="comment">//获取值，不管java的访问限制，其他有类似的getInt，getDouble，getLong，getChar等等  </span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> Object <span class="title function_">getObject</span><span class="params">(Object o, <span class="type">long</span> offset)</span>;  </span><br><span class="line">  </span><br><span class="line"><span class="comment">//设置值，不管java的访问限制，其他有类似的putInt,putDouble，putLong，putChar等等  </span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title function_">putObject</span><span class="params">(Object o, <span class="type">long</span> offset)</span>;  </span><br><span class="line">  </span><br><span class="line"><span class="comment">//从一个给定的内存地址获取本地指针，如果不是allocateMemory方法的，结果将不确定  </span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> <span class="type">long</span> <span class="title function_">getAddress</span><span class="params">(<span class="type">long</span> address)</span>;  </span><br><span class="line">  </span><br><span class="line"><span class="comment">//存储一个本地指针到一个给定的内存地址,如果地址不是allocateMemory方法的，结果将不确定  </span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title function_">putAddress</span><span class="params">(<span class="type">long</span> address, <span class="type">long</span> x)</span>;  </span><br><span class="line">  </span><br><span class="line"><span class="comment">//该方法返回给定field的内存地址偏移量，这个值对于给定的filed是唯一的且是固定不变的  </span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> <span class="type">long</span> <span class="title function_">staticFieldOffset</span><span class="params">(Field f)</span>;  </span><br><span class="line">  </span><br><span class="line"><span class="comment">//报告一个给定的字段的位置，不管这个字段是private，public还是保护类型，和staticFieldBase结合使用  </span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> <span class="type">long</span> <span class="title function_">objectFieldOffset</span><span class="params">(Field f)</span>;  </span><br><span class="line">  </span><br><span class="line"><span class="comment">//获取一个给定字段的位置  </span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> Object <span class="title function_">staticFieldBase</span><span class="params">(Field f)</span>;  </span><br><span class="line">  </span><br><span class="line"><span class="comment">//确保给定class被初始化，这往往需要结合基类的静态域（field）  </span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title function_">ensureClassInitialized</span><span class="params">(Class c)</span>;  </span><br><span class="line">  </span><br><span class="line"><span class="comment">//可以获取数组第一个元素的偏移地址  </span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> <span class="type">int</span> <span class="title function_">arrayBaseOffset</span><span class="params">(Class arrayClass)</span>;  </span><br><span class="line">  </span><br><span class="line"><span class="comment">//可以获取数组的转换因子，也就是数组中元素的增量地址。将arrayBaseOffset与arrayIndexScale配合使用， 可以定位数组中每个元素在内存中的位置  </span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> <span class="type">int</span> <span class="title function_">arrayIndexScale</span><span class="params">(Class arrayClass)</span>;  </span><br><span class="line">  </span><br><span class="line"><span class="comment">//获取本机内存的页数，这个值永远都是2的幂次方  </span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> <span class="type">int</span> <span class="title function_">pageSize</span><span class="params">()</span>;  </span><br><span class="line">  </span><br><span class="line"><span class="comment">//告诉虚拟机定义了一个没有安全检查的类，默认情况下这个类加载器和保护域来着调用者类  </span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> Class <span class="title function_">defineClass</span><span class="params">(String name, <span class="type">byte</span>[] b, <span class="type">int</span> off, <span class="type">int</span> len, ClassLoader loader, ProtectionDomain protectionDomain)</span>;  </span><br><span class="line">  </span><br><span class="line"><span class="comment">//定义一个类，但是不让它知道类加载器和系统字典  </span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> Class <span class="title function_">defineAnonymousClass</span><span class="params">(Class hostClass, <span class="type">byte</span>[] data, Object[] cpPatches)</span>;  </span><br><span class="line">  </span><br><span class="line"><span class="comment">//锁定对象，必须是没有被锁的</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title function_">monitorEnter</span><span class="params">(Object o)</span>;  </span><br><span class="line">  </span><br><span class="line"><span class="comment">//解锁对象  </span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title function_">monitorExit</span><span class="params">(Object o)</span>;  </span><br><span class="line">  </span><br><span class="line"><span class="comment">//试图锁定对象，返回true或false是否锁定成功，如果锁定，必须用monitorExit解锁  </span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> <span class="type">boolean</span> <span class="title function_">tryMonitorEnter</span><span class="params">(Object o)</span>;  </span><br><span class="line">  </span><br><span class="line"><span class="comment">//引发异常，没有通知  </span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title function_">throwException</span><span class="params">(Throwable ee)</span>;  </span><br><span class="line">  </span><br><span class="line"><span class="comment">//CAS，如果对象偏移量上的值=期待值，更新为x,返回true.否则false.类似的有compareAndSwapInt,compareAndSwapLong,compareAndSwapBoolean,compareAndSwapChar等等。  </span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">native</span> <span class="type">boolean</span> <span class="title function_">compareAndSwapObject</span><span class="params">(Object o, <span class="type">long</span> offset,  Object expected, Object x)</span>;  </span><br><span class="line">  </span><br><span class="line"><span class="comment">// 该方法获取对象中offset偏移地址对应的整型field的值,支持volatile load语义。类似的方法有getIntVolatile，getBooleanVolatile等等  </span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> Object <span class="title function_">getObjectVolatile</span><span class="params">(Object o, <span class="type">long</span> offset)</span>;   </span><br><span class="line">  </span><br><span class="line"><span class="comment">//线程调用该方法，线程将一直阻塞直到超时，或者是中断条件出现。  </span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title function_">park</span><span class="params">(<span class="type">boolean</span> isAbsolute, <span class="type">long</span> time)</span>;  </span><br><span class="line">  </span><br><span class="line"><span class="comment">//终止挂起的线程，恢复正常.java.util.concurrent包中挂起操作都是在LockSupport类实现的，也正是使用这两个方法</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title function_">unpark</span><span class="params">(Object thread)</span>;  </span><br><span class="line">  </span><br><span class="line"><span class="comment">//获取系统在不同时间系统的负载情况  </span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> <span class="type">int</span> <span class="title function_">getLoadAverage</span><span class="params">(<span class="type">double</span>[] loadavg, <span class="type">int</span> nelems)</span>;  </span><br><span class="line">  </span><br><span class="line"><span class="comment">//创建一个类的实例，不需要调用它的构造函数、初使化代码、各种JVM安全检查以及其它的一些底层的东西。即使构造函数是私有，我们也可以通过这个方法创建它的实例,对于单例模式，简直是噩梦。 </span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> Object <span class="title function_">allocateInstance</span><span class="params">(Class cls)</span> <span class="keyword">throws</span> InstantiationException;  </span><br></pre></td></tr></table></figure>

<h2 id="集合"><a href="#集合" class="headerlink" title="集合"></a>集合</h2><h3 id="ArrayList"><a href="#ArrayList" class="headerlink" title="ArrayList"></a>ArrayList</h3><ul>
<li><p>扩容</p>
<ul>
<li>使用无参构造方法创建时默认初始容量是0，使用add方法添加元素就触发扩容</li>
<li>第一次扩容容量变为10，当存满了会再触发扩容，默认是1.5倍</li>
<li>扩容是创建一个新数组，再将原数组内容拷贝到新数组</li>
<li>扩容后容量 &#x3D; 扩容前容量 &gt; 1 +扩容前容量 (即1.5倍)</li>
<li>因为每次扩容都比较小，所以要尽量避免频繁的扩容，当预知要保存多少元素时，就在创建时指定ArrayList的初始大小，或者使用ensureCapacity手动扩容</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//数组最大值 = 整型最大值 - 8</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">MAX_ARRAY_SIZE</span> <span class="operator">=</span> Integer.MAX_VALUE - <span class="number">8</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">ensureCapacity</span><span class="params">(<span class="type">int</span> minCapacity)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">minExpand</span> <span class="operator">=</span> (elementData != DEFAULTCAPACITY_EMPTY_ELEMENTDATA)</span><br><span class="line">        ? <span class="number">0</span> : DEFAULT_CAPACITY;</span><br><span class="line">    <span class="keyword">if</span> (minCapacity &gt; minExpand) &#123;</span><br><span class="line">        ensureExplicitCapacity(minCapacity);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">ensureExplicitCapacity</span><span class="params">(<span class="type">int</span> minCapacity)</span> &#123;</span><br><span class="line">    modCount++;</span><br><span class="line">    <span class="keyword">if</span> (minCapacity - elementData.length &gt; <span class="number">0</span>)</span><br><span class="line">        grow(minCapacity);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">grow</span><span class="params">(<span class="type">int</span> minCapacity)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">oldCapacity</span> <span class="operator">=</span> elementData.length;</span><br><span class="line">    <span class="type">int</span> <span class="variable">newCapacity</span> <span class="operator">=</span> oldCapacity + (oldCapacity &gt;&gt; <span class="number">1</span>); <span class="comment">//1.5倍</span></span><br><span class="line">    <span class="keyword">if</span> (newCapacity - minCapacity &lt; <span class="number">0</span>)</span><br><span class="line">        newCapacity = minCapacity;</span><br><span class="line">    <span class="keyword">if</span> (newCapacity - MAX_ARRAY_SIZE &gt; <span class="number">0</span>)</span><br><span class="line">        newCapacity = hugeCapacity(minCapacity);</span><br><span class="line">    elementData = Arrays.copyOf(elementData, newCapacity);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//得到最大的数组容量</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">hugeCapacity</span><span class="params">(<span class="type">int</span> minCapacity)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (minCapacity &lt; <span class="number">0</span>) <span class="comment">// 太大超过int最大值就变成负数了</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">OutOfMemoryError</span>();</span><br><span class="line">    <span class="keyword">return</span> (minCapacity &gt; MAX_ARRAY_SIZE) ? Integer.MAX_VALUE : MAX_ARRAY_SIZE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
<li><p>add(E e)、addAll(Collection&lt;? extends E&gt; c)</p>
<ul>
<li>检查剩余空间是否需要扩容，modCount++</li>
<li>添加到数组末尾</li>
<li>更新size</li>
</ul>
</li>
<li><p>add(int index, E element)、addAll(int index, Collection&lt;? extends E&gt; c)</p>
<ul>
<li>检查下标是否越界</li>
<li>检查剩余空间是否需要扩容，modCount++</li>
<li>原数组的值复制到新数组，插入区间前后的元素复制到新数组不包含插入区间的位置</li>
<li>然后在插入区间插入新增的元素</li>
<li>更新size</li>
</ul>
</li>
<li><p>set(int index, E element)</p>
<ul>
<li>检查下标是否越界</li>
<li>保存老值，新值插入index位置</li>
<li>返回老值</li>
</ul>
</li>
<li><p>get(int index)</p>
<ul>
<li>检查下标是否越界</li>
<li>返回指定下标的值，需要注意类型转换</li>
</ul>
</li>
<li><p>remove(int index)</p>
<ul>
<li>检查下标是否越界，modCount++</li>
<li>保存老值</li>
<li>数组从index下标之后的元素都往前移（通过复制）</li>
<li>为了让GC起作用，最后一个位置会显式赋<code>null</code>值</li>
<li>返回老值</li>
</ul>
</li>
<li><p>remove(Object o)</p>
<ul>
<li>删除第一个满足<code>o.equals(elementData[index])</code>的元素</li>
</ul>
</li>
<li><p>trimToSize() 将底层数组的容量调整为当前列表保存的实际元素的大小</p>
<ul>
<li><p>modCount++</p>
</li>
<li><p>判断 size 是否 小于数组大小</p>
<ul>
<li>如果size &#x3D;&#x3D; 0 则为空数组</li>
<li>size !&#x3D; 0 则 将数组复制到一个size &#x3D; 数组长度的新数组</li>
</ul>
</li>
</ul>
</li>
<li><p>indexOf(Object o)、lastIndexOf(Object o)</p>
<ul>
<li><p>判断 o 是否为 null</p>
</li>
<li><p>遍历数组找下标</p>
<ul>
<li>o 为 null 则用 &#x3D;&#x3D; 判断</li>
<li>o 不为 null 则用 equals 判断</li>
</ul>
</li>
<li><p>找到返回下标，找不到返回-1</p>
</li>
</ul>
</li>
<li><p>Fail-Fast机制</p>
<ul>
<li>通过记录modCount参数，迭代器遍历的时候遇到并发的修改时会报错</li>
</ul>
</li>
</ul>
<h3 id="LinkedList"><a href="#LinkedList" class="headerlink" title="LinkedList"></a>LinkedList</h3><ul>
<li><p>getFirst() 、getLast()</p>
<ul>
<li>定义个一个常量来接收 first 或者 last</li>
<li>如果指向 null，抛<code>NoSuchElementException</code>异常</li>
<li>有值就返回</li>
</ul>
</li>
<li><p>get(int index)</p>
<ul>
<li>检查下标是否合法，是否越界</li>
<li>返回 node(index).item</li>
</ul>
</li>
<li><p>set(int index, E element)</p>
<ul>
<li>判断下标是否合法，是否越界</li>
<li>Node x &#x3D; node(index) </li>
<li>E oldVal &#x3D; x.item</li>
<li>x.item &#x3D; element</li>
<li>return  oldVal</li>
</ul>
</li>
<li><p>remove(Object o)</p>
<ul>
<li><p>判断 o 是否为 null</p>
</li>
<li><p>遍历链表找值符合的节点</p>
<ul>
<li>o 为 null 则用 &#x3D;&#x3D; 判断</li>
<li>o 不为 null 则用 equals 判断</li>
</ul>
</li>
<li><p>找到则用 unlink() 删除节点，成功返回true</p>
</li>
</ul>
</li>
<li><p>remove(int index)</p>
<ul>
<li>检查下标是否越界</li>
<li>用 unlink( node(index) ) 删除节点</li>
</ul>
</li>
<li><p>removeFirst()、removeLast()</p>
<ul>
<li>定义一个常来接收 first &#x2F; last</li>
<li>first &#x2F; last 为null 抛NoSuchElementException异常</li>
<li>不为空则调用 unlinkFirst() &#x2F; unlinkLast()</li>
</ul>
</li>
<li><p>unlink(Node&lt;E&gt; x)</p>
<ul>
<li>定义三个常量保存节点的值 element、前驱节点 prev、后继节点 next</li>
<li>先处理前驱，在处理后继，注意防止空指针异常<ul>
<li>判断 prev 是否为null<ul>
<li>为 null 说明是第一个节点要删除，直接 first &#x3D; next</li>
<li>不为 null，则 prev.next &#x3D; next，x.prev &#x3D; null</li>
</ul>
</li>
<li>判断 next 是否为null<ul>
<li>为 null 则说明是最后一个节点要删除，直接 last &#x3D; prev</li>
<li>不为 null，则 next.prev &#x3D; prev，x.next &#x3D; null</li>
</ul>
</li>
</ul>
</li>
<li>将x的值置为 null。更新 size，modCount++</li>
<li>返回被删除的值 element</li>
</ul>
</li>
<li><p>unlinkFirst(Node&lt;E&gt; f)</p>
<ul>
<li><p>定义两个常量保存节点的值 element，后继节点 next</p>
</li>
<li><p>将 f 的值和后继节点置为 null</p>
</li>
<li><p>然后 first &#x3D; next</p>
</li>
<li><p>判断 next 是否等于 null</p>
<ul>
<li>为 null，则 last &#x3D; null</li>
<li>不为 null，则 next.prev &#x3D; null</li>
</ul>
</li>
<li><p>size–</p>
</li>
<li><p>modCount++</p>
</li>
<li><p>返回被删除的值 element</p>
</li>
</ul>
</li>
<li><p>unlinkLast(Node&lt;E&gt; l)</p>
<ul>
<li>定义两个常量保存节点的值 element，前驱节点 prev</li>
<li>将 l 的值和前驱节点置为 null</li>
<li>然后 last &#x3D; prev</li>
<li>判断 prev 是否等于 null<ul>
<li>为 null，则 first &#x3D; null</li>
<li>不为 null，则 prev.next &#x3D; null</li>
</ul>
</li>
<li>size–</li>
<li>modCount++</li>
<li>返回被删除的值 element</li>
</ul>
</li>
<li><p>add(E e)</p>
<ul>
<li>调用 linkLast(e)</li>
<li>返回 true</li>
</ul>
</li>
<li><p>add(int index, E element)</p>
<ul>
<li>判断下标是否合法，是否越界</li>
<li>如果 下标 &#x3D; size，说明是在链表最后插入，调用 linkLast(element)</li>
<li>下标 !&#x3D; size，则调用 linkBefore(element, node(index))</li>
</ul>
</li>
<li><p>linkLast(E e)</p>
<ul>
<li>定义两个常量保存 尾节点 l，新节点 newNode（根据 e 创建）</li>
<li>last &#x3D; newNode</li>
<li>判断 l 是否为 null<ul>
<li>为 null，说明链表中无节点，所以 first &#x3D; newNode</li>
<li>不为 null，说明链表中有节点，所以 l.next &#x3D; newNode</li>
</ul>
</li>
<li>size++</li>
<li>modCount++</li>
</ul>
</li>
<li><p>node(int index) </p>
<ul>
<li>判断 index 在链表前半段还是后半段，通过比较 size &gt;&gt; 1<ul>
<li>前半段：从前往后遍历找<ul>
<li>x &#x3D; first</li>
<li>for x &#x3D; x.next</li>
</ul>
</li>
<li>后半段：从后往前遍历找<ul>
<li>x &#x3D; last</li>
<li>for x &#x3D; x.prev</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><p>addAll(Collection&lt;? extends E&gt; c)</p>
<ul>
<li>调用addAll(size, c) 实现</li>
</ul>
</li>
<li><p>addAll(int index, Collection&lt;? extends E&gt; c)</p>
<ul>
<li><p>判断下标是否合法</p>
</li>
<li><p>将集合c转化为Object数组 a</p>
</li>
<li><p>得到 a的长度 numNew，判断是否等于0，等于0返回false</p>
</li>
<li><p>创建两个节点指针 pred、succ</p>
</li>
<li><p>判断 index 是否等于 size</p>
<ul>
<li>等于，相当于在链表最后添加，则 succ &#x3D; null，pred &#x3D; last</li>
<li>不等于，则 succ &#x3D; node(index)，pred &#x3D; succ.prev</li>
</ul>
</li>
<li><p>遍历 for (Object o : a) </p>
<ul>
<li>E e &#x3D; (E) o      强制类型转换</li>
<li>根据值和前驱 pred 创建节点 newNode </li>
<li>判断 pred 是否为 null<ul>
<li>为 null，则 first &#x3D; newNode</li>
<li>不为 null，pred.next &#x3D; newNode</li>
</ul>
</li>
<li>pred &#x3D; newNode</li>
</ul>
</li>
<li><p>判断 succ 是否为 null</p>
<ul>
<li>为 null，则 last &#x3D; pred</li>
<li>不为 null，则 pred.next &#x3D; succ，succ.prev &#x3D;  pred</li>
</ul>
</li>
<li><p>size +&#x3D; numNew</p>
</li>
<li><p>modCount++</p>
</li>
<li><p>return true</p>
</li>
</ul>
</li>
<li><p>clear()</p>
<ul>
<li>遍历<ul>
<li>先取得当前节点的next节点</li>
<li>然后当前节点的所有属性置为 null</li>
<li>x &#x3D; next</li>
</ul>
</li>
<li>first &#x3D; last &#x3D; null</li>
<li>size &#x3D; 0</li>
<li>modCount++</li>
</ul>
</li>
<li><p>indexOf(Object o)</p>
<ul>
<li>定义一个index &#x3D; 0</li>
<li>判断 o 是否为 null <ul>
<li>为 null，遍历时走 &#x3D;&#x3D; 判断</li>
<li>不为 null，遍历时走 equals判断</li>
</ul>
</li>
<li>找到返回index，找不到返回 -1</li>
</ul>
</li>
<li><p>lastIndexOf(Object o)</p>
<ul>
<li>定义一个index &#x3D; size</li>
<li>从后往前遍历，也是先判断 o 是否为 null 走不同的判断逻辑</li>
<li>找到返回index，找不到返回 -1</li>
</ul>
</li>
<li><p>peek()、peekFirst()、peekLast() </p>
<ul>
<li>定义一个常量 f 接收 first</li>
<li>如果 f 为 null 返回 null，不为 null 返回 f.item</li>
</ul>
</li>
<li><p>poll()、pollFirst()、pollLast()</p>
<ul>
<li>定义一个常量 f 接收 first</li>
<li>如果 f 为 null 返回 null，不为 null 返回 unlinkFirst(f)</li>
</ul>
</li>
<li><p>removeLastOccurrence(Object o)</p>
<ul>
<li><p>判断 o 是否为 null </p>
<ul>
<li>为 null，遍历时走 &#x3D;&#x3D; 判断</li>
<li>不为 null，遍历时走 equals判断</li>
</ul>
</li>
<li><p>找到用 unlink(x) 并返回true，找不到返回 false</p>
</li>
</ul>
</li>
<li><p>element()</p>
<ul>
<li>调用 getFirst()</li>
</ul>
</li>
<li><p>remove()</p>
<ul>
<li>调用 removeFirst()</li>
</ul>
</li>
<li><p>offer(E e)</p>
<ul>
<li>add(e)</li>
</ul>
</li>
<li><p>offerLast(E e)</p>
<ul>
<li>调用 addLast(e)</li>
<li>返回 true</li>
</ul>
</li>
<li><p>push(E e)</p>
<ul>
<li>调用 addFirst(e)</li>
</ul>
</li>
<li><p>pop()</p>
<ul>
<li>调用 removeFirst()</li>
</ul>
</li>
<li><p>removeFirstOccurrence(Object o)</p>
<ul>
<li>调用 remove(o)</li>
</ul>
</li>
</ul>
<h3 id="ArrayDeque"><a href="#ArrayDeque" class="headerlink" title="ArrayDeque"></a>ArrayDeque</h3><ul>
<li>addFirst(E e)<ul>
<li>判断 e 是否为null，为 null 就抛异常</li>
<li>就是在 head 之前插入，插入后head-1<ul>
<li>elements [ head &#x3D; (head - 1) &amp; (elements.length - 1) ] &#x3D; e</li>
</ul>
</li>
<li>判断是否需要扩容， 如果 head &#x3D;&#x3D; tail 就需要扩容</li>
</ul>
</li>
<li>addLast(E e)<ul>
<li>判断 e 是否为null，为 null 就抛异常</li>
<li>就是在 tail 的位置插入，插入后 tail+1<ul>
<li>elements[tail] &#x3D; e</li>
</ul>
</li>
<li>判断下标是否越界，越界就要扩容<ul>
<li>( tail &#x3D; ( tail + 1 ) &amp; ( elements.length - 1) ) &#x3D;&#x3D; head，为 true 就要扩容</li>
</ul>
</li>
</ul>
</li>
<li>doubleCapacity()<ul>
<li>只有在 head &#x3D;&#x3D; tail 的时候才需要扩容，源码中用 assert 判断，不满足条件则抛AssertionError异常</li>
<li>保存 head 的值（下标） p，数组的长度 n</li>
<li>计算 head 右边元素的个数 r &#x3D; n - p</li>
<li>计算扩容后的数组大小 newCapacity &#x3D; n &lt;&lt; 1，如果 newCapacity &lt; 0 则抛IllegalStateException异常 （就是太大了，超出in最大值就会变负数）</li>
<li>根据 newCapacity 创建一个新数组</li>
<li>将旧数组的值复制到新数组 a，分两步复制<ul>
<li>先复制 head 右边的数据到新数组</li>
<li>再复制 head 左边的数据到新数组</li>
</ul>
</li>
<li>将 elements 替换为新数组 a</li>
<li>head &#x3D; 0，tail &#x3D; n</li>
</ul>
</li>
<li>pollFirst()<ul>
<li>取得 head 位置的值 result</li>
<li>判断是否为 null，为 null 则说明数组为 null ，直接返回 null</li>
<li>将 head 位置的值置为 null</li>
<li>更新 head<ul>
<li>head &#x3D; (head + 1) &amp; (elements.length - 1)</li>
</ul>
</li>
<li>返回 result</li>
</ul>
</li>
<li>pollLast()<ul>
<li>获得 tial 前一位的值 t<ul>
<li>t &#x3D; (tail - 1) &amp; (elements.length - 1)</li>
</ul>
</li>
<li>取得 t 位置上的值 result</li>
<li>判断  result  是否为 null，为 null 则说明数组为 null ，直接返回 null</li>
<li>将 t 位置上的值置为 null</li>
<li>更新 tail<ul>
<li>tail &#x3D; t</li>
</ul>
</li>
<li>返回 result</li>
</ul>
</li>
<li>peekFirst()<ul>
<li>返回 elements[head] 的值</li>
</ul>
</li>
<li>peekLast()<ul>
<li>返回 elements[(tail - 1) &amp; (elements.length - 1)] 的值</li>
</ul>
</li>
</ul>
<h3 id="PriorityQueue"><a href="#PriorityQueue" class="headerlink" title="PriorityQueue"></a>PriorityQueue</h3><ul>
<li><p>add(E e)、offer(E e)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">offer</span><span class="params">(E e)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (e == <span class="literal">null</span>)<span class="comment">//不允许放入null元素</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span>();</span><br><span class="line">    modCount++;</span><br><span class="line">    <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> size;</span><br><span class="line">    <span class="keyword">if</span> (i &gt;= queue.length)</span><br><span class="line">        grow(i + <span class="number">1</span>);<span class="comment">//自动扩容</span></span><br><span class="line">    size = i + <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> (i == <span class="number">0</span>)<span class="comment">//队列原来为空，这是插入的第一个元素</span></span><br><span class="line">        queue[<span class="number">0</span>] = e;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        siftUp(i, e);<span class="comment">//调整</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>siftUp(int k, E x)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">siftUp</span><span class="params">(<span class="type">int</span> k, E x)</span> &#123;</span><br><span class="line">    <span class="keyword">while</span> (k &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">parent</span> <span class="operator">=</span> (k - <span class="number">1</span>) &gt;&gt;&gt; <span class="number">1</span>;<span class="comment">//parentNo = (nodeNo-1)/2</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">e</span> <span class="operator">=</span> queue[parent];<span class="comment">//取得父节点的值e</span></span><br><span class="line">        <span class="keyword">if</span> (comparator.compare(x, (E) e) &gt;= <span class="number">0</span>)<span class="comment">//调用比较器的比较方法</span></span><br><span class="line">            <span class="keyword">break</span>;<span class="comment">// x 大于 e 则不用交换了，直接退出</span></span><br><span class="line">        queue[k] = e;</span><br><span class="line">        k = parent;</span><br><span class="line">    &#125;</span><br><span class="line">    queue[k] = x;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>element()、peek()</p>
<ul>
<li>如果 size &#x3D;  0，返回 null</li>
<li>返回 (E) queue[ 0 ]</li>
</ul>
</li>
<li><p>remove()、poll()</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> E <span class="title function_">poll</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (size == <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="type">int</span> <span class="variable">s</span> <span class="operator">=</span> --size;</span><br><span class="line">    modCount++;</span><br><span class="line">    <span class="type">E</span> <span class="variable">result</span> <span class="operator">=</span> (E) queue[<span class="number">0</span>];<span class="comment">//0下标处的那个元素就是最小的那个</span></span><br><span class="line">    <span class="type">E</span> <span class="variable">x</span> <span class="operator">=</span> (E) queue[s];</span><br><span class="line">    queue[s] = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (s != <span class="number">0</span>)</span><br><span class="line">        siftDown(<span class="number">0</span>, x);<span class="comment">//调整</span></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>siftDown(int k, E x)</p>
<ul>
<li><p>得到 size 的一半 half</p>
</li>
<li><p>循环 k &lt; half </p>
<ul>
<li>得到左孩子的下标  child &#x3D; (k &lt;&lt; 1) + 1</li>
<li>得到左孩子下标对应的值 c</li>
<li>得到右孩子的下标 right &#x3D; child + 1</li>
<li>如果 right &lt; size 并且 c &gt; queue[right]，则 c &#x3D; queue[child &#x3D; right]，就是找左右孩子小的那一个</li>
<li>如果 x &lt; c 退出循环</li>
<li>queue[k] &#x3D; c，因为 x &gt; c</li>
<li>交换后从 k &#x3D; child</li>
</ul>
</li>
<li><p>queue[ k ] &#x3D; x</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">siftDown</span><span class="params">(<span class="type">int</span> k, E x)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">half</span> <span class="operator">=</span> size &gt;&gt;&gt; <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">while</span> (k &lt; half) &#123;</span><br><span class="line">    	<span class="comment">//首先找到左右孩子中较小的那个，记录到c里，并用child记录其下标</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">child</span> <span class="operator">=</span> (k &lt;&lt; <span class="number">1</span>) + <span class="number">1</span>;<span class="comment">//leftNo = parentNo*2+1</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">c</span> <span class="operator">=</span> queue[child];</span><br><span class="line">        <span class="type">int</span> <span class="variable">right</span> <span class="operator">=</span> child + <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span> (right &lt; size &amp;&amp;</span><br><span class="line">            comparator.compare((E) c, (E) queue[right]) &gt; <span class="number">0</span>)</span><br><span class="line">            c = queue[child = right];</span><br><span class="line">        <span class="keyword">if</span> (comparator.compare(x, (E) c) &lt;= <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        queue[k] = c;<span class="comment">//然后用c取代原来的值</span></span><br><span class="line">        k = child;</span><br><span class="line">    &#125;</span><br><span class="line">    queue[k] = x;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>remove(Object o)</p>
<ul>
<li><p>遍历数组找到符合值的下标 i &#x3D; indexOf(o)</p>
</li>
<li><p>如果 i &#x3D; -1 ，返回 false</p>
</li>
<li><p>得到数组最后一个元素的下标 s &#x3D; –size</p>
</li>
<li><p>如果 s &#x3D;&#x3D; i，说明要删除的是最后一个元素，则 queue[i] &#x3D; null</p>
</li>
<li><p>s !&#x3D; i</p>
<ul>
<li>取出数组最后一个元素的值 moved</li>
<li>queue[ s ] &#x3D; null</li>
<li>siftDown(i, moved)</li>
</ul>
</li>
<li><p>返回 true</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">remove</span><span class="params">(Object o)</span> &#123;</span><br><span class="line">	<span class="comment">//通过遍历数组的方式找到第一个满足o.equals(queue[i])元素的下标</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> indexOf(o);</span><br><span class="line">    <span class="keyword">if</span> (i == -<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="type">int</span> <span class="variable">s</span> <span class="operator">=</span> --size;</span><br><span class="line">    <span class="keyword">if</span> (s == i) <span class="comment">//情况1</span></span><br><span class="line">        queue[i] = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="type">E</span> <span class="variable">moved</span> <span class="operator">=</span> (E) queue[s];</span><br><span class="line">        queue[s] = <span class="literal">null</span>;</span><br><span class="line">        siftDown(i, moved);<span class="comment">//情况2</span></span><br><span class="line">        ......</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="Vector"><a href="#Vector" class="headerlink" title="Vector"></a>Vector</h3><h3 id="HashSet"><a href="#HashSet" class="headerlink" title="HashSet"></a>HashSet</h3><h3 id="LinkedHashMap"><a href="#LinkedHashMap" class="headerlink" title="LinkedHashMap"></a>LinkedHashMap</h3><h4 id="源码"><a href="#源码" class="headerlink" title="源码"></a>源码</h4><ul>
<li><p>get() 与hashmap的get方法几乎一致</p>
</li>
<li><p>addEntry(int hash, K key, V value, int bucketIndex)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">addEntry</span><span class="params">(<span class="type">int</span> hash, K key, V value, <span class="type">int</span> bucketIndex)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> ((size &gt;= threshold) &amp;&amp; (<span class="literal">null</span> != table[bucketIndex])) &#123;</span><br><span class="line">        resize(<span class="number">2</span> * table.length);<span class="comment">// 自动扩容，并重新哈希</span></span><br><span class="line">        hash = (<span class="literal">null</span> != key) ? hash(key) : <span class="number">0</span>;</span><br><span class="line">        bucketIndex = hash &amp; (table.length-<span class="number">1</span>);<span class="comment">// hash%table.length</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 1.在冲突链表头部插入新的entry</span></span><br><span class="line">    HashMap.Entry&lt;K,V&gt; old = table[bucketIndex];</span><br><span class="line">    Entry&lt;K,V&gt; e = <span class="keyword">new</span> <span class="title class_">Entry</span>&lt;&gt;(hash, key, value, old);</span><br><span class="line">    table[bucketIndex] = e;</span><br><span class="line">    <span class="comment">// 2.在双向链表的尾部插入新的entry</span></span><br><span class="line">    e.addBefore(header);</span><br><span class="line">    size++;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">addBefore</span><span class="params">(Entry&lt;K,V&gt; existingEntry)</span> &#123;</span><br><span class="line">    after  = existingEntry;</span><br><span class="line">    before = existingEntry.before;</span><br><span class="line">    before.after = <span class="built_in">this</span>;</span><br><span class="line">    after.before = <span class="built_in">this</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>removeEntryForKey(Object key)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> Entry&lt;K,V&gt; <span class="title function_">removeEntryForKey</span><span class="params">(Object key)</span> &#123;</span><br><span class="line">	......</span><br><span class="line">	<span class="type">int</span> <span class="variable">hash</span> <span class="operator">=</span> (key == <span class="literal">null</span>) ? <span class="number">0</span> : hash(key);</span><br><span class="line">    <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> indexFor(hash, table.length);<span class="comment">// hash&amp;(table.length-1)</span></span><br><span class="line">    Entry&lt;K,V&gt; prev = table[i];<span class="comment">// 得到冲突链表</span></span><br><span class="line">    Entry&lt;K,V&gt; e = prev;</span><br><span class="line">    <span class="keyword">while</span> (e != <span class="literal">null</span>) &#123;<span class="comment">// 遍历冲突链表</span></span><br><span class="line">        Entry&lt;K,V&gt; next = e.next;</span><br><span class="line">        Object k;</span><br><span class="line">        <span class="keyword">if</span> (e.hash == hash &amp;&amp;</span><br><span class="line">            ((k = e.key) == key || (key != <span class="literal">null</span> &amp;&amp; key.equals(k)))) &#123;<span class="comment">// 找到要删除的entry</span></span><br><span class="line">            modCount++; size--;</span><br><span class="line">            <span class="comment">// 1. 将e从对应bucket的冲突链表中删除</span></span><br><span class="line">            <span class="keyword">if</span> (prev == e) table[i] = next;</span><br><span class="line">            <span class="keyword">else</span> prev.next = next;</span><br><span class="line">            <span class="comment">// 2. 将e从双向链表中删除</span></span><br><span class="line">            e.before.after = e.after;</span><br><span class="line">            e.after.before = e.before;</span><br><span class="line">            <span class="keyword">return</span> e;</span><br><span class="line">        &#125;</span><br><span class="line">        prev = e; e = next;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> e;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="HashMap"><a href="#HashMap" class="headerlink" title="HashMap"></a>HashMap</h3><h4 id="源码-1-8"><a href="#源码-1-8" class="headerlink" title="源码 1.8"></a>源码 1.8</h4><ul>
<li><p>put( K key, V value )</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> V <span class="title function_">put</span><span class="params">(K key, V value)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> putVal(hash(key), key, value, <span class="literal">false</span>, <span class="literal">true</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>putVal( int hash, K key, V value, boolean onlyIfAbsent, boolean evict )</p>
<ul>
<li><p>判断 p 是否和要插入的 key 相等，这个 p 是这个位置上的第一个元素</p>
<ul>
<li>相等则用 e 接收这个节点（保留）</li>
<li>不相等判断 p 是不是树节点<ul>
<li>是树节点，调用红黑树的插入 ( ( TreeNode&lt;K,V&gt; ) p ).putTreeVal( this, tab, hash, key, value )，并用 e 接收返回值</li>
<li>是链表节点<ul>
<li>遍历链表节点<ul>
<li>用 e 接收 p.next，判断 e 是否为null<ul>
<li>为 null 直接插入p.next</li>
<li>如果链表长度大于等于8，则需要转化为红黑树，调用 treeifyBin(tab, hash)，跳出循环</li>
</ul>
</li>
<li>如果在该链表中找到了相等的 key (&#x3D;&#x3D; 或 equals)，跳出循环</li>
<li>p &#x3D; e</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>如果 e !&#x3D; null，说明存在旧值的key与要插入的key相等<ul>
<li>取得 e.value 为 oldValue</li>
<li>覆盖旧值 e.value &#x3D; value</li>
<li>返回旧值 oldValue</li>
</ul>
</li>
</ul>
</li>
<li><p>++modCount</p>
</li>
<li><p>如果因为插值 size &gt; 扩容阈值，就执行扩容 resize()</p>
</li>
<li><p>返回 null</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> V <span class="title function_">putVal</span><span class="params">(<span class="type">int</span> hash, K key, V value, <span class="type">boolean</span> onlyIfAbsent, <span class="type">boolean</span> evict)</span> &#123;</span><br><span class="line">    <span class="comment">//定义一个 tab 接收数组，p 接收下标的第一个元素，n 接收数组长度，i 接收下标</span></span><br><span class="line">    Node&lt;K,V&gt;[] tab; Node&lt;K,V&gt; p; <span class="type">int</span> n, i;</span><br><span class="line">    <span class="comment">// 第一次 put 值的时候，会触发扩容，0 -&gt; 16</span></span><br><span class="line">    <span class="keyword">if</span> ((tab = table) == <span class="literal">null</span> || (n = tab.length) == <span class="number">0</span>)  n = (tab = resize()).length;</span><br><span class="line">    <span class="comment">// pqu如果p为 null，说明该位置还没有值，直接插入即可</span></span><br><span class="line">    <span class="keyword">if</span> ((p = tab[i = (n - <span class="number">1</span>) &amp; hash]) == <span class="literal">null</span>) tab[i] = newNode(hash, key, value, <span class="literal">null</span>);</span><br><span class="line">    <span class="comment">// 数组该位置有数据</span></span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//局部变量e储存插入的位置，k储存p的</span></span><br><span class="line">        Node&lt;K,V&gt; e; K k;</span><br><span class="line">        <span class="comment">// 首先，判断该位置的第一个数据和我们要插入的数据，key 是不是&quot;相等&quot;，如果是，取出这个节点</span></span><br><span class="line">        <span class="keyword">if</span> (p.hash == hash &amp;&amp; ((k = p.key) == key || (key != <span class="literal">null</span> &amp;&amp; key.equals(k))))</span><br><span class="line">            e = p;</span><br><span class="line">        <span class="comment">// 如果该节点是代表红黑树的节点，调用红黑树的插值方法，本文不展开说红黑树</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (p <span class="keyword">instanceof</span> TreeNode)</span><br><span class="line">            e = ((TreeNode&lt;K,V&gt;)p).putTreeVal(<span class="built_in">this</span>, tab, hash, key, value);</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 到这里，说明数组该位置上是一个链表</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">binCount</span> <span class="operator">=</span> <span class="number">0</span>; ; ++binCount) &#123;</span><br><span class="line">                <span class="comment">// 插入到链表的最后面(Java7 是插入到链表的最前面)</span></span><br><span class="line">                <span class="keyword">if</span> ((e = p.next) == <span class="literal">null</span>) &#123;</span><br><span class="line">                    p.next = newNode(hash, key, value, <span class="literal">null</span>);</span><br><span class="line">                    <span class="comment">// TREEIFY_THRESHOLD 为 8，所以，如果新插入的值是链表中的第 8 个</span></span><br><span class="line">                    <span class="comment">// 会触发下面的 treeifyBin，也就是将链表转换为红黑树</span></span><br><span class="line">                    <span class="keyword">if</span> (binCount &gt;= TREEIFY_THRESHOLD - <span class="number">1</span>) <span class="comment">// -1 for 1st</span></span><br><span class="line">                        treeifyBin(tab, hash);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 如果在该链表中找到了&quot;相等&quot;的 key(== 或 equals)</span></span><br><span class="line">                <span class="keyword">if</span> (e.hash == hash &amp;&amp;</span><br><span class="line">                    ((k = e.key) == key || (key != <span class="literal">null</span> &amp;&amp; key.equals(k))))</span><br><span class="line">                    <span class="comment">// 此时 break，那么 e 为链表中[与要插入的新值的 key &quot;相等&quot;]的 node</span></span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                p = e;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// e!=null 说明存在旧值的key与要插入的key&quot;相等&quot;</span></span><br><span class="line">        <span class="comment">// 对于我们分析的put操作，下面这个 if 其实就是进行 &quot;值覆盖&quot;，然后返回旧值</span></span><br><span class="line">        <span class="keyword">if</span> (e != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="type">V</span> <span class="variable">oldValue</span> <span class="operator">=</span> e.value;</span><br><span class="line">            <span class="keyword">if</span> (!onlyIfAbsent || oldValue == <span class="literal">null</span>)</span><br><span class="line">                e.value = value;</span><br><span class="line">            afterNodeAccess(e);</span><br><span class="line">            <span class="keyword">return</span> oldValue;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ++modCount;</span><br><span class="line">    <span class="comment">// 如果 HashMap 由于新插入这个值导致 size 已经超过了阈值，需要进行扩容</span></span><br><span class="line">    <span class="keyword">if</span> (++size &gt; threshold)</span><br><span class="line">        resize();</span><br><span class="line">    afterNodeInsertion(evict);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>resize()</p>
<ul>
<li><p>定义一个节点数组保存原始数据 oldTab</p>
</li>
<li><p>定义一个 oldCap 保存旧数组容量，oldThr 保存旧阈值，定义 newCap, newThr 为 0</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (oldCap &gt; <span class="number">0</span>) &#123; <span class="comment">// 对应数组扩容</span></span><br><span class="line">    <span class="keyword">if</span> (oldCap &gt;= MAXIMUM_CAPACITY) &#123;</span><br><span class="line">        threshold = Integer.MAX_VALUE;</span><br><span class="line">        <span class="keyword">return</span> oldTab;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 将数组大小扩大一倍</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ((newCap = oldCap &lt;&lt; <span class="number">1</span>) &lt; MAXIMUM_CAPACITY &amp;&amp; oldCap &gt;= DEFAULT_INITIAL_CAPACITY)</span><br><span class="line">        <span class="comment">// 将阈值扩大一倍</span></span><br><span class="line">        newThr = oldThr &lt;&lt; <span class="number">1</span>; </span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (oldThr &gt; <span class="number">0</span>) <span class="comment">// 使用指定容量的构造函数创建时，因为没put所以 oldCap&lt;=0</span></span><br><span class="line">    newCap = oldThr;</span><br><span class="line"><span class="keyword">else</span> &#123;<span class="comment">// 使用无参构造函数创建并第一次put的时候</span></span><br><span class="line">    newCap = DEFAULT_INITIAL_CAPACITY;</span><br><span class="line">    newThr = (<span class="type">int</span>)(DEFAULT_LOAD_FACTOR * DEFAULT_INITIAL_CAPACITY);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//如果走了上面第一个if 中的 if 和 第一个 if 的else if 时</span></span><br><span class="line"><span class="comment">//newThr是没有值的，所以需要赋值，需要判断是哪一种情况</span></span><br><span class="line"><span class="keyword">if</span> (newThr == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="type">float</span> <span class="variable">ft</span> <span class="operator">=</span> (<span class="type">float</span>)newCap * loadFactor;</span><br><span class="line">    newThr = (newCap &lt; MAXIMUM_CAPACITY &amp;&amp; ft &lt; (<span class="type">float</span>)MAXIMUM_CAPACITY ?</span><br><span class="line">              (<span class="type">int</span>)ft : Integer.MAX_VALUE);</span><br><span class="line">&#125;</span><br><span class="line">threshold = newThr;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>创建新数组并转移数据</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//用新的数组大小初始化新的数组</span></span><br><span class="line">Node&lt;K,V&gt;[] newTab = (Node&lt;K,V&gt;[])<span class="keyword">new</span> <span class="title class_">Node</span>[newCap];</span><br><span class="line">table = newTab; <span class="comment">// 如果是初始化数组，到这里就结束了，返回 newTab 即可</span></span><br><span class="line"><span class="comment">// 开始遍历原数组，进行数据迁移。</span></span><br><span class="line"><span class="keyword">if</span> (oldTab != <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; oldCap; ++j) &#123;</span><br><span class="line">        Node&lt;K,V&gt; e;</span><br><span class="line">        <span class="keyword">if</span> ((e = oldTab[j]) != <span class="literal">null</span>) &#123;</span><br><span class="line">            oldTab[j] = <span class="literal">null</span>;</span><br><span class="line">            <span class="comment">// 如果该数组位置上只有单个元素，那就简单了，简单迁移这个元素就可以了</span></span><br><span class="line">            <span class="keyword">if</span> (e.next == <span class="literal">null</span>)</span><br><span class="line">                newTab[e.hash &amp; (newCap - <span class="number">1</span>)] = e;</span><br><span class="line">            <span class="comment">// 如果是红黑树，具体我们就不展开了</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (e <span class="keyword">instanceof</span> TreeNode)</span><br><span class="line">                ((TreeNode&lt;K,V&gt;)e).split(<span class="built_in">this</span>, newTab, j, oldCap);</span><br><span class="line">            <span class="keyword">else</span> &#123; </span><br><span class="line">                <span class="comment">// 这块是处理链表的情况，</span></span><br><span class="line">                <span class="comment">// 需要将此链表拆成两个链表，放到新的数组中，并且保留原来的先后顺序</span></span><br><span class="line">                <span class="comment">// loHead、loTail 对应一条链表，hiHead、hiTail 对应另一条链表，代码还是比较简单的</span></span><br><span class="line">                Node&lt;K,V&gt; loHead = <span class="literal">null</span>, loTail = <span class="literal">null</span>;</span><br><span class="line">                Node&lt;K,V&gt; hiHead = <span class="literal">null</span>, hiTail = <span class="literal">null</span>;</span><br><span class="line">                Node&lt;K,V&gt; next;</span><br><span class="line">                <span class="keyword">do</span> &#123;</span><br><span class="line">                    next = e.next;</span><br><span class="line">                    <span class="keyword">if</span> ((e.hash &amp; oldCap) == <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (loTail == <span class="literal">null</span>)</span><br><span class="line">                            loHead = e;</span><br><span class="line">                        <span class="keyword">else</span></span><br><span class="line">                            loTail.next = e;</span><br><span class="line">                        loTail = e;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="keyword">if</span> (hiTail == <span class="literal">null</span>)</span><br><span class="line">                            hiHead = e;</span><br><span class="line">                        <span class="keyword">else</span></span><br><span class="line">                            hiTail.next = e;</span><br><span class="line">                        hiTail = e;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; </span><br><span class="line">                <span class="keyword">while</span> ((e = next) != <span class="literal">null</span>);</span><br><span class="line">                <span class="keyword">if</span> (loTail != <span class="literal">null</span>) &#123;</span><br><span class="line">                    loTail.next = <span class="literal">null</span>;</span><br><span class="line">                    <span class="comment">// 第一条链表</span></span><br><span class="line">                    newTab[j] = loHead;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (hiTail != <span class="literal">null</span>) &#123;</span><br><span class="line">                    hiTail.next = <span class="literal">null</span>;</span><br><span class="line">                    <span class="comment">// 第二条链表的新的位置是 j + oldCap，这个很好理解</span></span><br><span class="line">                    newTab[j + oldCap] = hiHead;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> newTab;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>get(Object key)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> getNode(hash(key), key) == <span class="literal">null</span> ? <span class="literal">null</span> : e.value</span><br></pre></td></tr></table></figure>
</li>
<li><p>getNode(int hash, Object key)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> Node&lt;K,V&gt; <span class="title function_">getNode</span><span class="params">(<span class="type">int</span> hash, Object key)</span> &#123;</span><br><span class="line">    Node&lt;K,V&gt;[] tab; Node&lt;K,V&gt; first, e; <span class="type">int</span> n; K k;</span><br><span class="line">    <span class="comment">//表不为空，长度大于0，下标处有值</span></span><br><span class="line">    <span class="keyword">if</span> ((tab = table) != <span class="literal">null</span> &amp;&amp; (n = tab.length) &gt; <span class="number">0</span> &amp;&amp; (first = tab[(n - <span class="number">1</span>) &amp; hash]) != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 判断第一个节点是不是就是需要的</span></span><br><span class="line">        <span class="keyword">if</span> (first.hash == hash &amp;&amp;  ((k = first.key) == key || (key != <span class="literal">null</span> &amp;&amp; key.equals(k))))</span><br><span class="line">            <span class="keyword">return</span> first;</span><br><span class="line">        <span class="comment">//大于一个节点</span></span><br><span class="line">        <span class="keyword">if</span> ((e = first.next) != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 判断是否是红黑树</span></span><br><span class="line">            <span class="keyword">if</span> (first <span class="keyword">instanceof</span> TreeNode)</span><br><span class="line">                <span class="keyword">return</span> ((TreeNode&lt;K,V&gt;)first).getTreeNode(hash, key);</span><br><span class="line">            <span class="comment">// 链表遍历</span></span><br><span class="line">            <span class="keyword">do</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (e.hash == hash &amp;&amp; ((k = e.key) == key || (key != <span class="literal">null</span> &amp;&amp; key.equals(k))))</span><br><span class="line">                    <span class="keyword">return</span> e;</span><br><span class="line">            &#125;<span class="keyword">while</span> ((e = e.next) != <span class="literal">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="TreeMap"><a href="#TreeMap" class="headerlink" title="TreeMap"></a>TreeMap</h3><h4 id="源码-1"><a href="#源码-1" class="headerlink" title="源码"></a>源码</h4><ul>
<li><p>左旋</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">		p                         pr(r)</span></span><br><span class="line"><span class="comment">	   / \                        / \</span></span><br><span class="line"><span class="comment">	 pl   pr(r)       ==&gt;        p   rr</span></span><br><span class="line"><span class="comment">	      / \                   / \</span></span><br><span class="line"><span class="comment">	    rl   rr               pl  rl</span></span><br><span class="line"><span class="comment">	</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">rotateLeft</span><span class="params">(Entry&lt;K,V&gt; p)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (p != <span class="literal">null</span>) &#123;</span><br><span class="line">        Entry&lt;K,V&gt; r = p.right;</span><br><span class="line">        p.right = r.left;</span><br><span class="line">        <span class="keyword">if</span> (r.left != <span class="literal">null</span>)</span><br><span class="line">            r.left.parent = p;</span><br><span class="line">        r.parent = p.parent;</span><br><span class="line">        <span class="keyword">if</span> (p.parent == <span class="literal">null</span>)</span><br><span class="line">            root = r;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (p.parent.left == p)</span><br><span class="line">            p.parent.left = r;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            p.parent.right = r;</span><br><span class="line">        r.left = p;</span><br><span class="line">        p.parent = r;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>右旋</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">		p                         pl(l)</span></span><br><span class="line"><span class="comment">	   /  \                        / \</span></span><br><span class="line"><span class="comment">   (l)pl   pr       ==&gt;          ll   p</span></span><br><span class="line"><span class="comment">	/ \                              / \</span></span><br><span class="line"><span class="comment">  ll   lr                           lr  pr</span></span><br><span class="line"><span class="comment">	</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">rotateRight</span><span class="params">(Entry&lt;K,V&gt; p)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (p != <span class="literal">null</span>) &#123;</span><br><span class="line">        Entry&lt;K,V&gt; l = p.left;</span><br><span class="line">        p.left = l.right;</span><br><span class="line">        <span class="keyword">if</span> (l.right != <span class="literal">null</span>) </span><br><span class="line">            l.right.parent = p;</span><br><span class="line">        l.parent = p.parent;</span><br><span class="line">        <span class="keyword">if</span> (p.parent == <span class="literal">null</span>)</span><br><span class="line">            root = l;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (p.parent.right == p)</span><br><span class="line">            p.parent.right = l;</span><br><span class="line">        <span class="keyword">else</span> p.parent.left = l;</span><br><span class="line">        l.right = p;</span><br><span class="line">        p.parent = l;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>寻找节点后继</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> &lt;K,V&gt; TreeMap.Entry&lt;K,V&gt; <span class="title function_">successor</span><span class="params">(Entry&lt;K,V&gt; t)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (t == <span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 1. t的右子树不空，则t的后继是其右子树中最小的那个元素，即最左的元素</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (t.right != <span class="literal">null</span>) &#123;</span><br><span class="line">        Entry&lt;K,V&gt; p = t.right;</span><br><span class="line">        <span class="keyword">while</span> (p.left != <span class="literal">null</span>)</span><br><span class="line">            p = p.left;</span><br><span class="line">        <span class="keyword">return</span> p;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 2. t的右孩子为空，则t的后继是其第一个向左走的祖先，即parent.right = t的</span></span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        Entry&lt;K,V&gt; p = t.parent;</span><br><span class="line">        Entry&lt;K,V&gt; ch = t;</span><br><span class="line">        <span class="keyword">while</span> (p != <span class="literal">null</span> &amp;&amp; ch == p.right) &#123;</span><br><span class="line">            ch = p;</span><br><span class="line">            p = p.parent;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> p;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>get</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> Entry&lt;K,V&gt; <span class="title function_">getEntry</span><span class="params">(Object key)</span> &#123;</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">if</span> (key == <span class="literal">null</span>)<span class="comment">//不允许key值为null</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span>();</span><br><span class="line">    Comparable&lt;? <span class="built_in">super</span> K&gt; k = (Comparable&lt;? <span class="built_in">super</span> K&gt;) key;<span class="comment">//使用元素的自然顺序</span></span><br><span class="line">    Entry&lt;K,V&gt; p = root;</span><br><span class="line">    <span class="keyword">while</span> (p != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">cmp</span> <span class="operator">=</span> k.compareTo(p.key);</span><br><span class="line">        <span class="keyword">if</span> (cmp &lt; <span class="number">0</span>)<span class="comment">//向左找</span></span><br><span class="line">            p = p.left;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (cmp &gt; <span class="number">0</span>)<span class="comment">//向右找</span></span><br><span class="line">            p = p.right;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="keyword">return</span> p;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>put()</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> V <span class="title function_">put</span><span class="params">(K key, V value)</span> &#123;</span><br><span class="line">	......</span><br><span class="line">    Entry&lt;K,V&gt; t = <span class="built_in">this</span>.root;</span><br><span class="line">    <span class="comment">//如果根节点为null，当前节点直接作为根节点</span></span><br><span class="line">    <span class="keyword">if</span>(t == <span class="literal">null</span>) <span class="built_in">this</span>.root = <span class="keyword">new</span> <span class="title class_">Entry</span>&lt;&gt;(key, value, parent);</span><br><span class="line">    <span class="type">int</span> cmp;</span><br><span class="line">    Entry&lt;K,V&gt; parent; <span class="comment">//定义一个父亲节点</span></span><br><span class="line">    <span class="keyword">if</span> (key == <span class="literal">null</span>)  <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span>();</span><br><span class="line">    Comparable&lt;? <span class="built_in">super</span> K&gt; k = (Comparable&lt;? <span class="built_in">super</span> K&gt;) key;<span class="comment">//使用元素的自然顺序</span></span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        parent = t;</span><br><span class="line">        cmp = k.compareTo(t.key); <span class="comment">//与当前值比较大小</span></span><br><span class="line">        <span class="keyword">if</span> (cmp &lt; <span class="number">0</span>) t = t.left;<span class="comment">//向左找 插入的值小于当前值</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (cmp &gt; <span class="number">0</span>) t = t.right;<span class="comment">//向右找 插入的值大于当前值</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">return</span> t.setValue(value); <span class="comment">//当前值等于插入值</span></span><br><span class="line">    &#125; <span class="keyword">while</span> (t != <span class="literal">null</span>); <span class="comment">//非叶子节点</span></span><br><span class="line">    <span class="comment">//到达叶子节点</span></span><br><span class="line">    Entry&lt;K,V&gt; e = <span class="keyword">new</span> <span class="title class_">Entry</span>&lt;&gt;(key, value, parent);<span class="comment">//创建并插入新的entry</span></span><br><span class="line">    <span class="keyword">if</span> (cmp &lt; <span class="number">0</span>) parent.left = e;</span><br><span class="line">    <span class="keyword">else</span> parent.right = e;</span><br><span class="line">    fixAfterInsertion(e);<span class="comment">//调整（旋转和变色）</span></span><br><span class="line">    size++;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//调整插入的情况</span></span><br><span class="line"><span class="comment">/*         左三               右三                     3树左                     3树右</span></span><br><span class="line"><span class="comment">			a（黑）         a（黑）                    a（黑）                  a（黑）</span></span><br><span class="line"><span class="comment">	   	   /                 \                       /   \                     /   \</span></span><br><span class="line"><span class="comment">	 	 b（红）               b（红）            b（红） c（红）            b（红）  c（红）</span></span><br><span class="line"><span class="comment">    	/                       \                 /                                   \</span></span><br><span class="line"><span class="comment">   	   x（红）                    x（红）        x（红）                                x（红）</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">fixAfterInsertion</span><span class="params">(Entry&lt;K,V&gt; x)</span> &#123;</span><br><span class="line">    x.color = RED;<span class="comment">//新插入的节点都是红色的</span></span><br><span class="line">    <span class="comment">//父节点为红色时需要调整</span></span><br><span class="line">    <span class="keyword">while</span> (x != <span class="literal">null</span> &amp;&amp; x != root &amp;&amp; x.parent.color == RED) &#123;</span><br><span class="line">        <span class="comment">//x的父节点是爷爷节点的左节点（处理左三和3树左的情况）</span></span><br><span class="line">        <span class="keyword">if</span> (parentOf(x) == leftOf(parentOf(parentOf(x)))) &#123;</span><br><span class="line">            <span class="comment">//取出父亲节点的父亲节点的右节点（叔叔节点）</span></span><br><span class="line">            Entry&lt;K,V&gt; y = rightOf(parentOf(parentOf(x)));</span><br><span class="line">            <span class="comment">//判断是否是3树左，如果叔叔节点为空是false，不为空则是3树左的情况</span></span><br><span class="line">            <span class="keyword">if</span> (colorOf(y) == RED) &#123;</span><br><span class="line">                setColor(parentOf(x), BLACK);              <span class="comment">//x的父亲设置为黑色</span></span><br><span class="line">                setColor(y, BLACK);                        <span class="comment">//叔叔节点设置为黑色</span></span><br><span class="line">                setColor(parentOf(parentOf(x)), RED);      <span class="comment">//爷爷节点设置为红色</span></span><br><span class="line">                x = parentOf(parentOf(x));                 <span class="comment">//x指向爷爷节点，如果爷爷节点的父节点也是红接着处理</span></span><br><span class="line">            &#125; </span><br><span class="line">            <span class="comment">//左3</span></span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">//x是父节点的右节点（非完全左3），需要先左旋为左3，再右旋</span></span><br><span class="line">                <span class="keyword">if</span> (x == rightOf(parentOf(x))) &#123;</span><br><span class="line">                    x = parentOf(x);                       </span><br><span class="line">                    rotateLeft(x);                        <span class="comment">//在旋转时会改回父子间的指向</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//x是父节点的左节点</span></span><br><span class="line">                setColor(parentOf(x), BLACK);             <span class="comment">//x的父亲设置为黑色</span></span><br><span class="line">                setColor(parentOf(parentOf(x)), RED);     <span class="comment">//爷爷节点设置为红色</span></span><br><span class="line">                rotateRight(parentOf(parentOf(x)));       <span class="comment">//右旋 </span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125; </span><br><span class="line">        <span class="comment">//x的父节点是爷爷节点的右节点（处理右三和3树右的情况）</span></span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//取出父亲节点的父亲节点的左节点（叔叔节点）</span></span><br><span class="line">            Entry&lt;K,V&gt; y = leftOf(parentOf(parentOf(x)));</span><br><span class="line">            <span class="comment">//判断是否是3树右，如果叔叔节点为空是false，不为空则是3树右的情况</span></span><br><span class="line">            <span class="keyword">if</span> (colorOf(y) == RED) &#123;</span><br><span class="line">                setColor(parentOf(x), BLACK);              <span class="comment">//x的父亲设置为黑色</span></span><br><span class="line">                setColor(y, BLACK);                        <span class="comment">//叔叔节点设置为黑色</span></span><br><span class="line">                setColor(parentOf(parentOf(x)), RED);      <span class="comment">//爷爷节点设置为红色</span></span><br><span class="line">                x = parentOf(parentOf(x));                 <span class="comment">//x指向爷爷节点，如果爷爷节点的父节点也是红接着处理</span></span><br><span class="line">            &#125; </span><br><span class="line">            <span class="comment">//右3</span></span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">//x是父节点的左节点（非完全右3），需要先右旋为右3，再左旋</span></span><br><span class="line">                <span class="keyword">if</span> (x == leftOf(parentOf(x))) &#123;</span><br><span class="line">                    x = parentOf(x);                       </span><br><span class="line">                    rotateRight(x);                        <span class="comment">//在旋转时会改回父子间的指向</span></span><br><span class="line">                &#125;</span><br><span class="line">                setColor(parentOf(x), BLACK);              <span class="comment">//x的父亲设置为黑色</span></span><br><span class="line">                setColor(parentOf(parentOf(x)), RED);      <span class="comment">//爷爷节点设置为红色</span></span><br><span class="line">                rotateLeft(parentOf(parentOf(x)));         <span class="comment">//左旋 </span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    root.color = BLACK;			<span class="comment">//根节点必须为黑色</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>remove()</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">	删除的情况：</span></span><br><span class="line"><span class="comment">		1.删除节点是叶子节点，直接删除</span></span><br><span class="line"><span class="comment">		2.删除节点有左孩子或者右孩子，删除节点后让其左孩子或右孩子指向向删除节点的父节点</span></span><br><span class="line"><span class="comment">		3.删除节点有左右孩子节点，需要找到当前节点的后继节点，替代当前节点                    </span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">deleteEntry</span><span class="params">(Entry&lt;K,V&gt; p)</span> &#123;</span><br><span class="line">    modCount++;</span><br><span class="line">    size--;</span><br><span class="line">    <span class="comment">//情况3，将其转换成情况2来处理</span></span><br><span class="line">    <span class="keyword">if</span> (p.left != <span class="literal">null</span> &amp;&amp; p.right != <span class="literal">null</span>) </span><br><span class="line">        Entry&lt;K,V&gt; s = successor(p);</span><br><span class="line">        p.key = s.key;</span><br><span class="line">        p.value = s.value;</span><br><span class="line">        p = s; <span class="comment">//p指向它的后继节点</span></span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">//情况2</span></span><br><span class="line">	<span class="comment">//有左孩子取左孩子，没有就取右（因为我们找的是后继节点，是不会有左孩子的，但源码为了代码健壮性）</span></span><br><span class="line">    Entry&lt;K,V&gt; replacement = (p.left != <span class="literal">null</span> ? p.left : p.right);</span><br><span class="line">	<span class="comment">//有右孩子</span></span><br><span class="line">    <span class="keyword">if</span> (replacement != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">//左孩子或右孩子指向向删除节点的父节点</span></span><br><span class="line">        replacement.parent = p.parent;</span><br><span class="line">        <span class="keyword">if</span> (p.parent == <span class="literal">null</span>) <span class="comment">//父节点为空说明是根节点，直接替换</span></span><br><span class="line">            root = replacement;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (p == p.parent.left) <span class="comment">//是父节点的左孩子，重新修改指向</span></span><br><span class="line">            p.parent.left  = replacement;</span><br><span class="line">        <span class="keyword">else</span>						<span class="comment">//是父节点的右孩子，重新修改指向</span></span><br><span class="line">            p.parent.right = replacement;</span><br><span class="line">        p.left = p.right = p.parent = <span class="literal">null</span>; <span class="comment">//被删除的节点的引用全部置为null，gc处理</span></span><br><span class="line">        <span class="keyword">if</span> (p.color == BLACK)			 <span class="comment">//如果删除节点的颜色为黑色需要进行调整</span></span><br><span class="line">            fixAfterDeletion(replacement);<span class="comment">// 调整</span></span><br><span class="line">    &#125; </span><br><span class="line">	<span class="comment">//无左右孩子且父节点为null，即删除的节点是根节点</span></span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (p.parent == <span class="literal">null</span>) &#123;</span><br><span class="line">        root = <span class="literal">null</span>;	      </span><br><span class="line">    &#125; </span><br><span class="line">	<span class="comment">//情况1</span></span><br><span class="line">	<span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (p.color == BLACK)</span><br><span class="line">            fixAfterDeletion(p);<span class="comment">// 调整</span></span><br><span class="line">        <span class="keyword">if</span> (p.parent != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (p == p.parent.left)</span><br><span class="line">                p.parent.left = <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (p == p.parent.right)</span><br><span class="line">                p.parent.right = <span class="literal">null</span>;</span><br><span class="line">            p.parent = <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">	情况1：被删除的节点有左右孩子的节点，需要通过改变节点指向和变色就可以解决的</span></span><br><span class="line"><span class="comment">	情况2：被删除的节点无左右孩子的节点，用父亲节点替代，再用一个兄弟节点的子节点替代父亲节点</span></span><br><span class="line"><span class="comment">		情况2.1：兄弟节点有一个孩子，旋转成有右孩子的情况，在进行左旋</span></span><br><span class="line"><span class="comment">		情况2.2：兄弟节点有两个孩子，直接进行左旋</span></span><br><span class="line"><span class="comment">	情况3：被删除的节点无左右孩子的节点，用父亲节点替代，但是兄弟节点没有子节点可以替代父亲节点	</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">fixAfterDeletion</span><span class="params">(Entry&lt;K,V&gt; x)</span> &#123;</span><br><span class="line">    <span class="comment">//情况2，3</span></span><br><span class="line">    <span class="keyword">while</span> (x != root &amp;&amp; colorOf(x) == BLACK) &#123;</span><br><span class="line">        <span class="comment">//x是左孩子的情况</span></span><br><span class="line">        <span class="keyword">if</span> (x == leftOf(parentOf(x))) &#123;</span><br><span class="line">            <span class="comment">//找到x的兄弟节点</span></span><br><span class="line">            Entry&lt;K,V&gt; sib = rightOf(parentOf(x));</span><br><span class="line">            <span class="comment">//判断sib是否是x的兄弟节点，只有sib是黑色时才是兄弟节点，红色需要调整</span></span><br><span class="line">            <span class="keyword">if</span> (colorOf(sib) == RED) &#123;</span><br><span class="line">                setColor(sib, BLACK);                   <span class="comment">// 兄弟变黑</span></span><br><span class="line">                setColor(parentOf(x), RED);             <span class="comment">// 兄弟父亲变红</span></span><br><span class="line">                rotateLeft(parentOf(x));                <span class="comment">// 左旋，将左孩子变成右孩子</span></span><br><span class="line">                sib = rightOf(parentOf(x));             <span class="comment">// 修改找到真正的兄弟节点</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//情况3，兄弟节点无左右孩子节点</span></span><br><span class="line">            <span class="keyword">if</span> (colorOf(leftOf(sib))  == BLACK &amp;&amp; colorOf(rightOf(sib)) == BLACK) &#123;</span><br><span class="line">                setColor(sib, RED);                     <span class="comment">// 设置兄弟节点为红色</span></span><br><span class="line">                x = parentOf(x);                        <span class="comment">// 删除的节点指向x的父亲，递归条件</span></span><br><span class="line">            &#125; </span><br><span class="line">            <span class="comment">//情况2，兄弟节点有一个或俩个子节点</span></span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">//没有右孩子，需要右旋为有左孩子的情况</span></span><br><span class="line">                <span class="keyword">if</span> (colorOf(rightOf(sib)) == BLACK) &#123;</span><br><span class="line">                    setColor(leftOf(sib), BLACK);       <span class="comment">// 将兄弟节点的左节点变黑</span></span><br><span class="line">                    setColor(sib, RED);                 <span class="comment">// 将兄弟节点变红</span></span><br><span class="line">                    rotateRight(sib);                   <span class="comment">// 右旋</span></span><br><span class="line">                    sib = rightOf(parentOf(x));         <span class="comment">// 兄弟节点重新指向为父亲节点的右节点</span></span><br><span class="line">                &#125;</span><br><span class="line">                setColor(sib, colorOf(parentOf(x)));    <span class="comment">// 兄弟节点要变成父亲节点的颜色</span></span><br><span class="line">                setColor(parentOf(x), BLACK);           <span class="comment">// 父亲节点变黑</span></span><br><span class="line">                setColor(rightOf(sib), BLACK);          <span class="comment">// 兄弟节点的右孩子变黑</span></span><br><span class="line">                rotateLeft(parentOf(x));                <span class="comment">// 左旋</span></span><br><span class="line">                x = root;                               <span class="comment">// 结束循环</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125; </span><br><span class="line">        <span class="comment">//x是右孩子的情况，不会出现这种可能</span></span><br><span class="line">        <span class="keyword">else</span> &#123; </span><br><span class="line">            Entry&lt;K,V&gt; sib = leftOf(parentOf(x));</span><br><span class="line">            <span class="keyword">if</span> (colorOf(sib) == RED) &#123;</span><br><span class="line">                setColor(sib, BLACK);                   <span class="comment">// </span></span><br><span class="line">                setColor(parentOf(x), RED);             <span class="comment">// </span></span><br><span class="line">                rotateRight(parentOf(x));               <span class="comment">// </span></span><br><span class="line">                sib = leftOf(parentOf(x));              <span class="comment">// </span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (colorOf(rightOf(sib)) == BLACK &amp;&amp;</span><br><span class="line">                colorOf(leftOf(sib)) == BLACK) &#123;</span><br><span class="line">                setColor(sib, RED);                     <span class="comment">// </span></span><br><span class="line">                x = parentOf(x);                        <span class="comment">// </span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (colorOf(leftOf(sib)) == BLACK) &#123;</span><br><span class="line">                    setColor(rightOf(sib), BLACK);      <span class="comment">// </span></span><br><span class="line">                    setColor(sib, RED);                 <span class="comment">// </span></span><br><span class="line">                    rotateLeft(sib);                    <span class="comment">// </span></span><br><span class="line">                    sib = leftOf(parentOf(x));          <span class="comment">// </span></span><br><span class="line">                &#125;</span><br><span class="line">                setColor(sib, colorOf(parentOf(x)));    <span class="comment">// </span></span><br><span class="line">                setColor(parentOf(x), BLACK);           <span class="comment">// </span></span><br><span class="line">                setColor(leftOf(sib), BLACK);           <span class="comment">// </span></span><br><span class="line">                rotateRight(parentOf(x));               <span class="comment">// </span></span><br><span class="line">                x = root;                               <span class="comment">// </span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//情况1，变黑，指向在前面已经修改完毕了</span></span><br><span class="line">    setColor(x, BLACK);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="HashTable"><a href="#HashTable" class="headerlink" title="HashTable"></a>HashTable</h3><h3 id="WeakHashMap"><a href="#WeakHashMap" class="headerlink" title="WeakHashMap"></a>WeakHashMap</h3><h2 id="注解"><a href="#注解" class="headerlink" title="注解"></a>注解</h2><h3 id="CallerSensitive"><a href="#CallerSensitive" class="headerlink" title="@CallerSensitive"></a>@CallerSensitive</h3><ul>
<li>该注解标注的方法为危险方法，调用该注解标注的方法的对象必须也需要有该注解，且改对象必须有启动类加载</li>
<li>开发者自己写的@CallerSensitive不可被识别即无法调用该危险方法</li>
<li>可以通过jvm参数 <code>-Xbootclasspath/a: path</code> 伪装为启动类</li>
</ul>
<h3 id="FunctionInterface"><a href="#FunctionInterface" class="headerlink" title="@FunctionInterface"></a>@FunctionInterface</h3><ul>
<li>接口中只有一个抽象方法，即可搭配lamda表达式使用</li>
</ul>
<h3 id="Contended"><a href="#Contended" class="headerlink" title="@Contended"></a>@Contended</h3><ul>
<li>防止缓存行，伪共享</li>
<li>对齐填充，因为一个缓存行是64字节，当读取的目标数据小于64字节时，可以填充一些无意义的数据使其字节接近或达到64字节，这样就可以使一个缓存行只被一个线程所持有</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2024/01/18/Note/%E5%90%8E%E7%AB%AF/Java/%E6%BA%90%E7%A0%81/JDK/" data-id="clrj8pzxx008s6wuwaq1vem01" data-title="JDK源码" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E6%BA%90%E7%A0%81/" rel="tag">源码</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-Note/后端/Java/模块/搜索" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2024/01/18/Note/%E5%90%8E%E7%AB%AF/Java/%E6%A8%A1%E5%9D%97/%E6%90%9C%E7%B4%A2/" class="article-date">
  <time class="dt-published" datetime="2024-01-18T13:12:24.699Z" itemprop="datePublished">2024-01-18</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%A8%A1%E5%9D%97/">模块</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2024/01/18/Note/%E5%90%8E%E7%AB%AF/Java/%E6%A8%A1%E5%9D%97/%E6%90%9C%E7%B4%A2/">搜索</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="ES"><a href="#ES" class="headerlink" title="ES"></a>ES</h1><h2 id="搜索"><a href="#搜索" class="headerlink" title="搜索"></a>搜索</h2><ul>
<li><p>创建一个查询对象vo类，属性包括需要显示的信息，指定其属于ES中哪个索引，哪个type（表）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Document(indexName = &quot;haoke&quot;, type = &quot;house&quot;, createIndex = false)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Data</span>&#123;</span><br><span class="line">    <span class="comment">//需要返回的数据</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建一个搜索结果类，存放查询结果集合</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SearchResult</span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Integer totalPage;</span><br><span class="line">    <span class="keyword">private</span> List&lt;Data&gt; list;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建<code>SearchController</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SearchController</span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> SearchService searchService;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@GetMapping</span></span><br><span class="line">    <span class="keyword">public</span> SearchResult <span class="title function_">search</span><span class="params">(<span class="meta">@RequestParam(&quot;keyWord&quot;)</span> String kewWord,</span></span><br><span class="line"><span class="params">                               <span class="meta">@RequestParam(value = &quot;page&quot;, defaultValue = &quot;1&quot;)</span> Integer page)</span>&#123;</span><br><span class="line">      	<span class="comment">//防止爬虫，保障ES性能，减少压力</span></span><br><span class="line">        <span class="keyword">if</span>(page &gt; <span class="number">100</span>)  page = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.searchService.search(keyWord, page);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建<code>SearchService</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SearchService</span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ElasticsearchTemplate elasticsearchTemplate;</span><br><span class="line">    <span class="comment">//由后端指定页面数据条数</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Integer</span> <span class="variable">ROWS</span> <span class="operator">=</span> <span class="number">10</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> SearchResult <span class="title function_">serach</span><span class="params">(String kewWord, Integer page)</span>&#123;</span><br><span class="line">        <span class="comment">//设置分页参数</span></span><br><span class="line">        <span class="type">PageRequest</span> <span class="variable">pageRequest</span> <span class="operator">=</span> PageRequest.of(page - <span class="number">1</span>, ROWS);</span><br><span class="line">        <span class="type">SearchQuery</span> <span class="variable">searchQuery</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NativSearchQueryBuilder</span>()</span><br><span class="line">            .withQuery(Querybuilder.matchQuery(<span class="string">&quot;title&quot;</span>, keyWord).operator(Operator.AND))</span><br><span class="line">            .withPageable(pageRequest)</span><br><span class="line">            .withHighlightFields(<span class="keyword">new</span> <span class="title class_">HighlightBuilder</span>.Field(<span class="string">&quot;title&quot;</span>))<span class="comment">//不起作用</span></span><br><span class="line">            .builder();</span><br><span class="line">        AggregatedPage&lt;HouseData&gt; housePage = </span><br><span class="line">            <span class="built_in">this</span>.elasticsearchTemplate.queryForPage(searchQuery, HouseData.class);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">SearchResult</span>(housePage.getTotalPages(), housePage.getContent());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="高亮显示"><a href="#高亮显示" class="headerlink" title="高亮显示"></a>高亮显示</h2><ul>
<li>处理高亮和非高亮</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">SearchResult</span>(housePage.getTotalPages(), housePage.getContent(), <span class="keyword">new</span> <span class="title class_">SearchResultMapper</span>()&#123;</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> &lt;T&gt; AggregatedPage&lt;T&gt; <span class="title function_">mapResults</span><span class="params">(SearchResponse response, Class&lt;T&gt; clazz, Pageable pageable)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">    <span class="comment">//如果查询到的条数为0时返回空对象</span></span><br><span class="line">    <span class="keyword">if</span>(response.getHits().totalHits == <span class="number">0</span>) </span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">AggregatedPageImpl</span>&lt;&gt;(Collection.emptyList(), pageable, <span class="number">0L</span>);</span><br><span class="line">    <span class="comment">//接收</span></span><br><span class="line">    List&lt;T&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="comment">//遍历命中的数据</span></span><br><span class="line">    <span class="keyword">for</span>(SearchHits searchHit : response.getHits().getHits())&#123;</span><br><span class="line">        <span class="type">T</span> <span class="variable">obj</span> <span class="operator">=</span> (T) ReflectUtils.newInstance(clazz);</span><br><span class="line">        FieldUtils.writeField(obj, <span class="string">&quot;id&quot;</span>, searchHit.getId(), <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//非高亮字段的数据处理</span></span><br><span class="line">        <span class="keyword">for</span>(Map.Entry&lt;String, Object&gt; entry : searchHit.getSourceAsMap().entrySet())&#123;</span><br><span class="line">            <span class="keyword">if</span>(<span class="literal">null</span> == FieldUtils.getFiled(clazz, entry.getKey(), <span class="literal">true</span>)) <span class="keyword">continue</span>;</span><br><span class="line">            FieldUtils.writeField(obj, entry.getKey(), entry.getValue(), <span class="literal">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//处理高亮字段</span></span><br><span class="line">        <span class="keyword">for</span>(Map.Entry&lt;String, HighlighField&gt; entry : searchHit.getHighlighFields().entrySet())&#123;</span><br><span class="line">            <span class="type">StringBulider</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">            Text[] fragments = entry.getValue().getFragments();</span><br><span class="line">            <span class="keyword">for</span>(Text fragment : fragments)&#123;</span><br><span class="line">                sb.append(fragment.toString());</span><br><span class="line">            &#125;</span><br><span class="line">            FieldUtils.writeField(obj, entry.getKey(), sb.toString(), <span class="literal">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        list.add(obj);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">AggregatedPageImpl</span>&lt;&gt;(list, pagable, response.getHits().totalHits);</span><br><span class="line">&#125;);                                                           </span><br></pre></td></tr></table></figure>

<h2 id="热词搜索"><a href="#热词搜索" class="headerlink" title="热词搜索"></a>热词搜索</h2><ul>
<li><p>redis使用sortedSet</p>
</li>
<li><p><code>SearchController</code> 添加方法，并添加热词搜索次数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SearchController</span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> SearchService searchService;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate redisTemplate;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@GetMapping</span></span><br><span class="line">    <span class="keyword">public</span> SearchResult <span class="title function_">search</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(page &gt; <span class="number">100</span>)  page = <span class="number">1</span>;</span><br><span class="line">        <span class="type">SearchResult</span> <span class="variable">search</span> <span class="operator">=</span> <span class="built_in">this</span>.searchService.search(keyWord, page);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//热词加入redis</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">redisKey</span> <span class="operator">=</span> <span class="string">&quot;SEARCH_HOT_WORDS&quot;</span>;</span><br><span class="line">        <span class="comment">//数据条数 = 数据页数 * 每页条数 + 当前页数据条数</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> ((Math.max(search.getTotalPage(), <span class="number">1</span>) - <span class="number">1</span>) * searchService.ROWS) + search.getList().size();</span><br><span class="line">        <span class="built_in">this</span>.redisTemplate.opsForZSet().add(redisKey, keyWord, count);</span><br><span class="line">        <span class="comment">//判断是否返回热词搜索</span></span><br><span class="line">        <span class="keyword">if</span>(search.totalPage() &lt;=<span class="number">1</span>)[</span><br><span class="line">            <span class="type">Set</span> <span class="variable">set</span> <span class="operator">=</span> <span class="built_in">this</span>.redisTemplate.opsForZSet().reverseRange(redsikey, <span class="number">0</span>, <span class="number">4</span>);</span><br><span class="line">            search.setHotWord(set);</span><br><span class="line">        ]</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> search;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>修改<code>SearchResult</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SearchResult</span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Integer totalPage;</span><br><span class="line">    <span class="keyword">private</span> List&lt;HouseData&gt; list;</span><br><span class="line">    <span class="comment">//新增一个热词字段</span></span><br><span class="line">    <span class="keyword">private</span> Set&lt;String&gt; hotWord;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="拼音分词"><a href="#拼音分词" class="headerlink" title="拼音分词"></a>拼音分词</h2><ul>
<li><p>创建索引时使用拼音分词插件，配置拼音插件</p>
</li>
<li><p>创建索引时为字段建立一个拼音的子字段，该子字段使用拼音分词器</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">&quot;properties&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;title&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;text&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;analyzer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ik_max_word&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;fields&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;text&quot;</span><span class="punctuation">,</span></span><br><span class="line">        	<span class="attr">&quot;analyzer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;pinyin_analyzer&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    .............</span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>高亮会失效，使用混合搜索可解决</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">&quot;query&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">	<span class="attr">&quot;mult_match&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="string">&quot;地铁kou&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;fields&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="string">&quot;title&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="string">&quot;title.pinyin&quot;</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">	<span class="attr">&quot;highlight&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;fields&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;title.pinyin&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">            &#x27;title&#x27;<span class="punctuation">:</span><span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>修改 <code>SearchService</code> 中的实现</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SearchService</span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ElasticsearchTemplate elasticsearchTemplate;</span><br><span class="line">    <span class="comment">//由后端指定页面数据条数</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Integer</span> <span class="variable">ROWS</span> <span class="operator">=</span> <span class="number">10</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> SearchResult <span class="title function_">serach</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="comment">//设置分页参数</span></span><br><span class="line">        <span class="type">PageRequest</span> <span class="variable">pageRequest</span> <span class="operator">=</span> PageRequest.of(page - <span class="number">1</span>, ROWS);</span><br><span class="line">        <span class="type">SearchQuery</span> <span class="variable">searchQuery</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">NativSearchQueryBuilder</span>()</span><br><span class="line">            <span class="comment">//这里修改为混合搜索</span></span><br><span class="line">            .withQuery(Querybuilder.multMatchQuery(keyWord, <span class="string">&quot;title&quot;</span>, <span class="string">&quot;title.pinyin&quot;</span>).operator(Operator.AND))</span><br><span class="line">            .withPageable(pageRequest)</span><br><span class="line">            .withHighlightFields(<span class="keyword">new</span> <span class="title class_">HighlightBuilder</span>.Field(<span class="string">&quot;title&quot;</span>))</span><br><span class="line">            .builder();</span><br><span class="line">        AggregatedPage&lt;HouseData&gt; housePage = </span><br><span class="line">            <span class="built_in">this</span>.elasticsearchTemplate.queryForPage(searchQuery, HouseData.class);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">SearchResult</span>(housePage.getTotalPages(), housePage.getContent());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2024/01/18/Note/%E5%90%8E%E7%AB%AF/Java/%E6%A8%A1%E5%9D%97/%E6%90%9C%E7%B4%A2/" data-id="clrj8pzxs007m6wuwbx6y2i0c" data-title="搜索" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E6%A8%A1%E5%9D%97/" rel="tag">模块</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-Note/后端/Java/模块/登录" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2024/01/18/Note/%E5%90%8E%E7%AB%AF/Java/%E6%A8%A1%E5%9D%97/%E7%99%BB%E5%BD%95/" class="article-date">
  <time class="dt-published" datetime="2024-01-18T13:12:24.699Z" itemprop="datePublished">2024-01-18</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%A8%A1%E5%9D%97/">模块</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2024/01/18/Note/%E5%90%8E%E7%AB%AF/Java/%E6%A8%A1%E5%9D%97/%E7%99%BB%E5%BD%95/">登录</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="用户名密码登录"><a href="#用户名密码登录" class="headerlink" title="用户名密码登录"></a>用户名密码登录</h2><ol>
<li>通过用户名查询用户表，得到密码和盐值</li>
<li>将客户端传递过来的密码加上盐值再通过md5加密后与用户表中的密码进行比对</li>
<li>成功则生成jwt和用户信息返回给客户端</li>
</ol>
<h2 id="短信登录"><a href="#短信登录" class="headerlink" title="短信登录"></a>短信登录</h2><ol>
<li>获取验证码</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//发送验证码</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">sendCode</span><span class="params">(String phone, HttpSession session)</span> &#123;</span><br><span class="line">    <span class="comment">// 1.校验手机号</span></span><br><span class="line">    <span class="comment">// 2.如果不符合，返回错误信息</span></span><br><span class="line">    <span class="comment">// 3.符合，生成验证码</span></span><br><span class="line">    <span class="comment">// 4.保存验证码到 redis</span></span><br><span class="line">    <span class="comment">// 5.发送验证码</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>校验验证码</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//校验验证码</span></span><br><span class="line"><span class="keyword">public</span> Result <span class="title function_">login</span><span class="params">(LoginFormDTO loginForm, HttpSession session)</span> &#123;</span><br><span class="line">    <span class="comment">// 1.校验手机号</span></span><br><span class="line">    <span class="comment">// 2.从redis获取验证码并校验</span></span><br><span class="line">        <span class="comment">// 2.1 不一致，报错或者记录信息后友好提示</span></span><br><span class="line">    <span class="comment">// 3.一致，根据手机号查询数据库用户 select * from tb_user where phone = ?</span></span><br><span class="line">    <span class="comment">// 4.判断用户是否存在</span></span><br><span class="line">        <span class="comment">// 4.1.不存在，注册新用户并保存</span></span><br><span class="line">    <span class="comment">// 5.存在，保存用户信息到 redis中</span></span><br><span class="line">    <span class="comment">// 6.使用JWT生成token，作为登录令牌</span></span><br><span class="line">    <span class="comment">// 7.将User对象转为HashMap存储</span></span><br><span class="line">    <span class="comment">// 8.存储到redis中</span></span><br><span class="line">    <span class="comment">// 9.设置token有效期</span></span><br><span class="line">    <span class="comment">// 10.返回token给客户端</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>发送验证码时检验一次，登录时再检验一，防止两次的手机号不同</p>
</li>
<li><p>redis存储时 key为手机号，value为验证码</p>
</li>
</ul>
<h3 id="设置拦截器拦截用户访问需要用户信息的页面"><a href="#设置拦截器拦截用户访问需要用户信息的页面" class="headerlink" title="设置拦截器拦截用户访问需要用户信息的页面"></a>设置拦截器拦截用户访问需要用户信息的页面</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="comment">// 1.获取请求头中的token</span></span><br><span class="line">    <span class="comment">// 2.基于TOKEN获取redis中的用户</span></span><br><span class="line">    <span class="comment">// 3.判断用户是否存在</span></span><br><span class="line">    <span class="comment">// 4.将查询到的hash数据转为UserDTO</span></span><br><span class="line">    	<span class="comment">// 4.1.不存在，拦截，跳转到登录页面</span></span><br><span class="line">    <span class="comment">// 5.存在，保存用户信息到 ThreadLocal</span></span><br><span class="line">    <span class="comment">// 6.刷新token有效期</span></span><br><span class="line">    <span class="comment">// 7.放行</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="设置拦截器防止用户过期重新登录"><a href="#设置拦截器防止用户过期重新登录" class="headerlink" title="设置拦截器防止用户过期重新登录"></a>设置拦截器防止用户过期重新登录</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="comment">// 1.获取请求头中的token</span></span><br><span class="line">    <span class="comment">// 2.基于TOKEN获取redis中的用户</span></span><br><span class="line">    <span class="comment">// 3.判断用户是否存在</span></span><br><span class="line">    <span class="comment">// 4.将查询到的hash数据转为UserDTO</span></span><br><span class="line">    <span class="comment">// 5.判断UserDTO是否存在</span></span><br><span class="line">    	<span class="comment">// 5.1.不存在，重新登录</span></span><br><span class="line">    <span class="comment">// 6.存在，保存用户信息到 ThreadLocal</span></span><br><span class="line">    <span class="comment">// 7.刷新token有效期</span></span><br><span class="line">    <span class="comment">// 8.放行</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>拦截一切路径</li>
</ul>
<h3 id="常见问题"><a href="#常见问题" class="headerlink" title="常见问题"></a>常见问题</h3><h4 id="集群Session共享问题"><a href="#集群Session共享问题" class="headerlink" title="集群Session共享问题"></a>集群Session共享问题</h4><ul>
<li>使用session保存收集好user对象，每一个session都有一个唯一的sessionId，在访问tomcat时sessionId会自动写入cookie中，session的原理是cookie</li>
<li>集群下不同的服务器并不共享session，导致请求切换到不同服务器时需要重新登录</li>
</ul>
<h2 id="二维码登录"><a href="#二维码登录" class="headerlink" title="二维码登录"></a>二维码登录</h2><h2 id="第三方登录"><a href="#第三方登录" class="headerlink" title="第三方登录"></a>第三方登录</h2><h2 id="游客登录"><a href="#游客登录" class="headerlink" title="游客登录"></a>游客登录</h2><h2 id="注册"><a href="#注册" class="headerlink" title="注册"></a>注册</h2><ol>
<li>输入用户名密码，生成随机盐值，保存到对应的用户表</li>
<li>保存密码时，通过 密码 + 盐值 再通过md5存储到用户表中</li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2024/01/18/Note/%E5%90%8E%E7%AB%AF/Java/%E6%A8%A1%E5%9D%97/%E7%99%BB%E5%BD%95/" data-id="clrj8pzxt007r6wuwbef6dvjl" data-title="登录" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E6%A8%A1%E5%9D%97/" rel="tag">模块</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-Note/后端/Java/模块/地图" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2024/01/18/Note/%E5%90%8E%E7%AB%AF/Java/%E6%A8%A1%E5%9D%97/%E5%9C%B0%E5%9B%BE/" class="article-date">
  <time class="dt-published" datetime="2024-01-18T13:12:24.698Z" itemprop="datePublished">2024-01-18</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%A8%A1%E5%9D%97/">模块</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2024/01/18/Note/%E5%90%8E%E7%AB%AF/Java/%E6%A8%A1%E5%9D%97/%E5%9C%B0%E5%9B%BE/">地图</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="Mongo实现"><a href="#Mongo实现" class="headerlink" title="Mongo实现"></a>Mongo实现</h1><h2 id="地图显示附近房源位置"><a href="#地图显示附近房源位置" class="headerlink" title="地图显示附近房源位置"></a>地图显示附近房源位置</h2><ul>
<li><p>需要返回给前端 房源集合（需要有经纬度信息），可以给房源添加经纬度信息，或者创建一个新的类保存（位置集合（X，Y），id，房源id，房源标题）</p>
</li>
<li><p>在MongoDB中为经纬度信息创建地理位置索引</p>
<ul>
<li><code>db.house.createIndex(&#123;loc:&quot;id&quot;&#125;)</code></li>
</ul>
</li>
<li><p>需要存储地图缩放比对应的公里数</p>
</li>
<li><p>查询MongoDB</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MongoHouseService</span>&#123;</span><br><span class="line">    <span class="comment">//需要定义缩放比对应的公里数</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Map&lt;Integer, Double&gt; BAIDU_ZOOM = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MongoTemplate mongoTemplate;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> MapHouseDataResult <span class="title function_">queryHouseData</span><span class="params">(Float lng, Float lat, Integer zoom)</span>&#123;</span><br><span class="line">        <span class="comment">//1.5倍距离范围</span></span><br><span class="line">        <span class="type">double</span> <span class="variable">distance</span> <span class="operator">=</span> BAIDU_ZOOM.get(zoom) * <span class="number">1.5</span> / <span class="number">111.12</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="type">Query</span> <span class="variable">query</span> <span class="operator">=</span> Query.query(Criteria.where(<span class="string">&quot;loc&quot;</span>)</span><br><span class="line">                                  .near(<span class="keyword">new</span> <span class="title class_">Point</span>(lng, lat))</span><br><span class="line">                                  .maxDistance(distance));</span><br><span class="line">        List&lt;MongoHouse&gt; mongoHouses = <span class="built_in">this</span>.mongoTemplate.find(query, MongoHouse.class);</span><br><span class="line">        List&lt;MapHouseXY&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span>(MongoHouse mongoHouse : mongoHouses)&#123;</span><br><span class="line">            list.add(<span class="keyword">new</span> <span class="title class_">MapHouseXY</span>(mongoHouses.getLoc()[<span class="number">0</span>], mongoHouse.getLoc()[<span class="number">1</span>]));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">MapHouseDataResult</span>(list);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h1 id="Redis实现"><a href="#Redis实现" class="headerlink" title="Redis实现"></a>Redis实现</h1><h2 id="附近商铺"><a href="#附近商铺" class="headerlink" title="附近商铺"></a>附近商铺</h2><h3 id="Redis中的GEO实现"><a href="#Redis中的GEO实现" class="headerlink" title="Redis中的GEO实现"></a>Redis中的GEO实现</h3><h1 id="百度地图API"><a href="#百度地图API" class="headerlink" title="百度地图API"></a>百度地图API</h1><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><ul>
<li>实现地图找房</li>
<li>创建地图、覆盖物、控件、事件</li>
<li>坐标转换、路线规划、IP定位</li>
</ul>
<h2 id="地图找房"><a href="#地图找房" class="headerlink" title="地图找房"></a>地图找房</h2><p>- </p>
<h2 id="运动类"><a href="#运动类" class="headerlink" title="运动类"></a>运动类</h2><ul>
<li>运动轨迹、保存路线、分享路线、附近的人、附近路线</li>
<li>基于百度地图的鹰眼轨迹服务实现</li>
</ul>
<h2 id="物流"><a href="#物流" class="headerlink" title="物流"></a>物流</h2><ul>
<li>运行轨迹、电子wei’l</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2024/01/18/Note/%E5%90%8E%E7%AB%AF/Java/%E6%A8%A1%E5%9D%97/%E5%9C%B0%E5%9B%BE/" data-id="clrj8pzxr007f6wuwdsiu2hva" data-title="地图" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E6%A8%A1%E5%9D%97/" rel="tag">模块</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-Note/后端/Java/模块/导入导出" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2024/01/18/Note/%E5%90%8E%E7%AB%AF/Java/%E6%A8%A1%E5%9D%97/%E5%AF%BC%E5%85%A5%E5%AF%BC%E5%87%BA/" class="article-date">
  <time class="dt-published" datetime="2024-01-18T13:12:24.698Z" itemprop="datePublished">2024-01-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="导出word"><a href="#导出word" class="headerlink" title="导出word"></a>导出word</h2><p>freemarker</p>
<h2 id="导出Excel"><a href="#导出Excel" class="headerlink" title="导出Excel"></a>导出Excel</h2><p>EasyExcel</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2024/01/18/Note/%E5%90%8E%E7%AB%AF/Java/%E6%A8%A1%E5%9D%97/%E5%AF%BC%E5%85%A5%E5%AF%BC%E5%87%BA/" data-id="clrj8pzxs007j6wuw7b96frjr" data-title="" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-Note/后端/Java/模块/OSS" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2024/01/18/Note/%E5%90%8E%E7%AB%AF/Java/%E6%A8%A1%E5%9D%97/OSS/" class="article-date">
  <time class="dt-published" datetime="2024-01-18T13:12:24.697Z" itemprop="datePublished">2024-01-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="Minio"><a href="#Minio" class="headerlink" title="Minio"></a>Minio</h2><h3 id="文件上传"><a href="#文件上传" class="headerlink" title="文件上传"></a>文件上传</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> MinioClient minioClient;</span><br><span class="line"><span class="keyword">public</span> UploadFileResultDTO <span class="title function_">uploadFile</span><span class="params">(<span class="type">byte</span>[] bytes, Long userId, UploadFileParam param, String folderName)</span>&#123;</span><br><span class="line">    <span class="comment">//上传到minio</span></span><br><span class="line">    <span class="type">PutObjectArgs</span> <span class="variable">putObjectArgs</span> <span class="operator">=</span> PutObjectArgs.builder()</span><br><span class="line">        .bucket(<span class="string">&quot;桶名&quot;</span>)</span><br><span class="line">        .object(<span class="string">&quot;文件名&quot;</span>)</span><br><span class="line">        .stream(<span class="string">&quot;文件输入流, 文件大小, 分片大小（-1最小5m, 最大10000）&quot;</span>)</span><br><span class="line">        .contentType(<span class="string">&quot;content-type&quot;</span>) <span class="comment">//资源d</span></span><br><span class="line">        .build();</span><br><span class="line">    minioClient.putObject(putObjectArgs);</span><br><span class="line">    <span class="comment">//保存到数据库</span></span><br><span class="line">    <span class="comment">//可以将文件流转换为md5存入数据库</span></span><br><span class="line">    	<span class="comment">//先查再插入</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//上传文件的基本信息</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UploadFileParam</span>&#123;</span><br><span class="line">    <span class="comment">//文件名</span></span><br><span class="line">    <span class="keyword">private</span> String fileName;</span><br><span class="line">    <span class="comment">//content-type</span></span><br><span class="line">    <span class="keyword">private</span> String contentType;</span><br><span class="line">    <span class="comment">//文件类型</span></span><br><span class="line">    <span class="keyword">private</span> String fileType;</span><br><span class="line">    <span class="comment">//标签</span></span><br><span class="line">    <span class="keyword">private</span> String tags;</span><br><span class="line">    <span class="comment">//上传人</span></span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    <span class="comment">//备注</span></span><br><span class="line">    <span class="keyword">private</span> String remark;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="视频上传"><a href="#视频上传" class="headerlink" title="视频上传"></a>视频上传</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//检查该文件在minio上是否存在</span></span><br><span class="line"><span class="keyword">public</span> R <span class="title function_">checkFile</span><span class="params">(String fileMd5, <span class="type">int</span> index)</span>&#123;</span><br><span class="line">    <span class="comment">//查数据库，数据存在再查minio</span></span><br><span class="line">    <span class="comment">//查minio</span></span><br><span class="line">    <span class="type">GetObjectArgs</span> <span class="variable">object</span> <span class="operator">=</span> GetObjectArgs.builder()....</span><br><span class="line">    minioClient.getObject(object);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//判断分块是否存在</span></span><br><span class="line"><span class="keyword">public</span> R <span class="title function_">checkFile</span><span class="params">(String fileMd5)</span>&#123;</span><br><span class="line">    <span class="comment">//截取fileMd5前两位，拼接成文件路径</span></span><br><span class="line">    <span class="comment">//查minio</span></span><br><span class="line">    <span class="type">GetObjectArgs</span> <span class="variable">object</span> <span class="operator">=</span> GetObjectArgs.builder()....</span><br><span class="line">    minioClient.getObject(object); </span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//开始上传</span></span><br><span class="line"><span class="keyword">public</span> R <span class="title function_">uploadchunk</span><span class="params">(String fileMd5, <span class="type">int</span> index, String localFilePath)</span>&#123;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//合并</span></span><br></pre></td></tr></table></figure>

<h2 id="阿里云"><a href="#阿里云" class="headerlink" title="阿里云"></a>阿里云</h2>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2024/01/18/Note/%E5%90%8E%E7%AB%AF/Java/%E6%A8%A1%E5%9D%97/OSS/" data-id="clrj8pzxr007b6wuwdply57z6" data-title="" class="article-share-link"><span class="fa fa-share">Share</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  


  <nav id="page-nav">
    
    <a class="extend prev" rel="prev" href="/page/4/">&laquo; Prev</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><span class="page-number current">5</span><a class="page-number" href="/page/6/">6</a><a class="page-number" href="/page/7/">7</a><span class="space">&hellip;</span><a class="page-number" href="/page/12/">12</a><a class="extend next" rel="next" href="/page/6/">Next &raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Go/">Go</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java%E4%B8%AD%E9%97%B4%E4%BB%B6/">Java中间件</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java%E5%9F%BA%E7%A1%80/">Java基础</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java%E6%A1%86%E6%9E%B6/">Java框架</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Web3/">Web3</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E4%BA%BA%E5%B7%A5%E6%99%BA%E8%83%BD/">人工智能</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%8A%9B%E6%89%A3/">力扣</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%BC%80%E5%8F%91/">开发</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/">数据库</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%A8%A1%E5%9D%97/">模块</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%BA%90%E7%A0%81/">源码</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%AE%97%E6%B3%95%E9%A2%98/">算法题</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%9F%A5%E8%AF%86/">计算机知识</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E9%9D%A2%E8%AF%95/">面试</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/code/" rel="tag">code</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/defi/" rel="tag">defi</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/go/" rel="tag">go</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/language/" rel="tag">language</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/solidity/" rel="tag">solidity</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/web3/" rel="tag">web3</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E4%B8%AD%E9%97%B4%E4%BB%B6/" rel="tag">中间件</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E4%BB%A3%E7%A0%81%E9%9A%8F%E6%83%B3%E5%BD%95/" rel="tag">代码随想录</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E4%BC%98%E5%8C%96/" rel="tag">优化</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%89%91%E6%8C%87offer/" rel="tag">剑指offer</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%8A%9B%E6%89%A3%E7%83%AD%E9%A2%98100/" rel="tag">力扣热题100</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%8A%9B%E6%89%A3%E9%A2%98/" rel="tag">力扣题</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%8E%9F%E7%90%86/" rel="tag">原理</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%9F%BA%E7%A1%80/" rel="tag">基础</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%B7%A5%E5%85%B7/" rel="tag">工具</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%B7%A6%E7%A5%9E/" rel="tag">左神</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%BA%93/" rel="tag">库</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%BC%80%E5%8F%91/" rel="tag">开发</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%8A%80%E5%B7%A7/" rel="tag">技巧</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/" rel="tag">操作系统</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/" rel="tag">数据库</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/" rel="tag">数据结构</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E5%92%8C%E7%AE%97%E6%B3%95/" rel="tag">数据结构和算法</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%A1%86%E6%9E%B6/" rel="tag">框架</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%A8%A1%E5%9D%97/" rel="tag">模块</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%A8%A1%E5%9E%8B/" rel="tag">模型</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%BA%90%E7%A0%81/" rel="tag">源码</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%90%86%E5%BF%B5/" rel="tag">理念</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%AE%97%E6%B3%95/" rel="tag">算法</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%B3%BB%E7%BB%9Fan-quan/" rel="tag">系统an&#39;quan</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/" rel="tag">系统设计</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%BD%91%E7%BB%9C/" rel="tag">网络</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%A7%84%E8%8C%83/" rel="tag">规范</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%97%AE%E9%A2%98/" rel="tag">问题</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%9B%86%E6%88%90/" rel="tag">集成</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%9B%86%E7%BE%A4/" rel="tag">集群</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%9D%A2%E8%AF%95/" rel="tag">面试</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/code/" style="font-size: 10px;">code</a> <a href="/tags/defi/" style="font-size: 10px;">defi</a> <a href="/tags/go/" style="font-size: 10px;">go</a> <a href="/tags/language/" style="font-size: 10px;">language</a> <a href="/tags/solidity/" style="font-size: 10px;">solidity</a> <a href="/tags/web3/" style="font-size: 12.86px;">web3</a> <a href="/tags/%E4%B8%AD%E9%97%B4%E4%BB%B6/" style="font-size: 20px;">中间件</a> <a href="/tags/%E4%BB%A3%E7%A0%81%E9%9A%8F%E6%83%B3%E5%BD%95/" style="font-size: 10px;">代码随想录</a> <a href="/tags/%E4%BC%98%E5%8C%96/" style="font-size: 10px;">优化</a> <a href="/tags/%E5%89%91%E6%8C%87offer/" style="font-size: 10px;">剑指offer</a> <a href="/tags/%E5%8A%9B%E6%89%A3%E7%83%AD%E9%A2%98100/" style="font-size: 10px;">力扣热题100</a> <a href="/tags/%E5%8A%9B%E6%89%A3%E9%A2%98/" style="font-size: 10px;">力扣题</a> <a href="/tags/%E5%8E%9F%E7%90%86/" style="font-size: 10px;">原理</a> <a href="/tags/%E5%9F%BA%E7%A1%80/" style="font-size: 15.71px;">基础</a> <a href="/tags/%E5%B7%A5%E5%85%B7/" style="font-size: 10px;">工具</a> <a href="/tags/%E5%B7%A6%E7%A5%9E/" style="font-size: 10px;">左神</a> <a href="/tags/%E5%BA%93/" style="font-size: 10px;">库</a> <a href="/tags/%E5%BC%80%E5%8F%91/" style="font-size: 18.57px;">开发</a> <a href="/tags/%E6%8A%80%E5%B7%A7/" style="font-size: 11.43px;">技巧</a> <a href="/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/" style="font-size: 10px;">操作系统</a> <a href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/" style="font-size: 12.86px;">数据库</a> <a href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/" style="font-size: 11.43px;">数据结构</a> <a href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E5%92%8C%E7%AE%97%E6%B3%95/" style="font-size: 17.14px;">数据结构和算法</a> <a href="/tags/%E6%A1%86%E6%9E%B6/" style="font-size: 14.29px;">框架</a> <a href="/tags/%E6%A8%A1%E5%9D%97/" style="font-size: 15.71px;">模块</a> <a href="/tags/%E6%A8%A1%E5%9E%8B/" style="font-size: 11.43px;">模型</a> <a href="/tags/%E6%BA%90%E7%A0%81/" style="font-size: 12.86px;">源码</a> <a href="/tags/%E7%90%86%E5%BF%B5/" style="font-size: 14.29px;">理念</a> <a href="/tags/%E7%AE%97%E6%B3%95/" style="font-size: 10px;">算法</a> <a href="/tags/%E7%B3%BB%E7%BB%9Fan-quan/" style="font-size: 10px;">系统an'quan</a> <a href="/tags/%E7%B3%BB%E7%BB%9F%E8%AE%BE%E8%AE%A1/" style="font-size: 10px;">系统设计</a> <a href="/tags/%E7%BD%91%E7%BB%9C/" style="font-size: 10px;">网络</a> <a href="/tags/%E8%A7%84%E8%8C%83/" style="font-size: 10px;">规范</a> <a href="/tags/%E9%97%AE%E9%A2%98/" style="font-size: 10px;">问题</a> <a href="/tags/%E9%9B%86%E6%88%90/" style="font-size: 10px;">集成</a> <a href="/tags/%E9%9B%86%E7%BE%A4/" style="font-size: 10px;">集群</a> <a href="/tags/%E9%9D%A2%E8%AF%95/" style="font-size: 12.86px;">面试</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/01/">January 2024</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2024/01/18/Note/%E9%9D%A2%E8%AF%95/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/">计算机基础</a>
          </li>
        
          <li>
            <a href="/2024/01/18/Note/%E9%9D%A2%E8%AF%95/%E7%AE%80%E5%8E%86/">(no title)</a>
          </li>
        
          <li>
            <a href="/2024/01/18/Note/%E9%9D%A2%E8%AF%95/%E8%8B%B1%E8%AF%AD/">(no title)</a>
          </li>
        
          <li>
            <a href="/2024/01/18/Note/%E9%9D%A2%E8%AF%95/%E5%9C%BA%E6%99%AF%E9%A2%98/">场景题</a>
          </li>
        
          <li>
            <a href="/2024/01/18/Note/%E9%9D%A2%E8%AF%95/%E6%95%B0%E6%8D%AE%E5%BA%93/">(no title)</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2024 JianHong<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.6.4.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>